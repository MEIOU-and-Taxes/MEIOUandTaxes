Infra_SetBuildingMax = { #sets max limit for some types of buildings
	set_key = { lhs = Building_AgricultureMax which = Land_Size }
	multiply_key = { lhs = Building_AgricultureMax which = Modi_AgricultureMax }
	
	set_key = { lhs = Building_ForestryMax which = Land_Forest }
	multiply_key = { lhs = Building_ForestryMax which = Modi_ForestryMax }
	
	set_key = { lhs = Building_ExtractionMax which = Land_Resource }
	if = {
		limit = {
			has_province_flag = coal
			OR = {
				has_province_flag = m
				has_province_flag = salt
				has_port = yes
			}
			Prod_NotHasProd = { Prod=14 }
		}
		if = {
			limit = {
				OR = {
					province_id = 5483 	#Xinzhou, North China
					province_id = 722 	#Ordos, Inner Mongolia
					province_id = 480 	#Kulunda, Kazakh Steppe
					province_id = 86 	#Oberstift, Westphalia
					province_id = 2507 	#Belz, Ruthenia
				}
			}
			subtract_key = { lhs = Building_ExtractionMax value = 80 }
		}
		else_if = {
			limit = {
				OR = {
					province_id = 2467	#Zezhou, North China
					province_id = 5119	#Baota, North China
					province_id = 2471	#Pingyang, North China
					province_id = 5489	#Xianyang, North China
					province_id = 5478	#Jiezhou, North China
					province_id = 2467	#Zezhou, North China
					province_id = 5471	#Shanzou, North China
				}
			}
			subtract_key = { lhs = Building_ExtractionMax value = 40 }
		}
		else = {
			subtract_key = { lhs = Building_ExtractionMax value = 30 }
		}
		if = {
			limit = {
				NOT = { check_key = { lhs = Building_ExtractionMax value = 0 } }
			}
			set_key = { lhs = Building_ExtractionMax value = 0 }
		}
	}
	multiply_key = { lhs = Building_ExtractionMax value = 10 }
	multiply_key = { lhs = Building_ExtractionMax which = Modi_ExtractionMax }
	
	set_key = { lhs = Building_FisheryMax which = Land_Fish }
	multiply_key = { lhs = Building_FisheryMax value = 10 }
	multiply_key = { lhs = Building_FisheryMax which = Modi_FisheryMax }
}

Infra_AddPrp = {
	hidden_effect = {
		if = {
			limit = {
				NOT = { check_key = { lhs = Building_$Type$ value = $Amount$ } }
			}
			set_key = { lhs = Building_$Type$ value = $Amount$ }
		}
		[[Cap]
		if = {
			limit = {
				always = $Cap$
				check_key = { lhs = Building_$Type$ which = Building_$Type$Max }
			}
			set_key = { lhs = Building_$Type$ which = Building_$Type$Max }
		}
		]
	}
}
### Inputs
# id = 8 = Pathing, 9 = Harbourage, 10 = Amenities, 11 = Irrigation, 14 = Garrison
# height = Amount of Units to build
# width = Amount of slots
Infra_StartProject = {
    set_key = { lhs = Public_Tmp1 value = 10 }
    set_key = { lhs = Public_Tmp2 which = $height$ }
    set_key = { lhs = Public_Tmp3 value = 0 }
    
    if = { limit = { has_province_flag = Infra_S0 } subtract_key = { lhs = Public_Tmp1 value = 1 } }
    if = { limit = { has_province_flag = Infra_S1 } subtract_key = { lhs = Public_Tmp1 value = 1 } }
    if = { limit = { has_province_flag = Infra_S2 } subtract_key = { lhs = Public_Tmp1 value = 1 } }
    if = { limit = { has_province_flag = Infra_S3 } subtract_key = { lhs = Public_Tmp1 value = 1 } }
    if = { limit = { has_province_flag = Infra_S4 } subtract_key = { lhs = Public_Tmp1 value = 1 } }
    if = { limit = { has_province_flag = Infra_S5 } subtract_key = { lhs = Public_Tmp1 value = 1 } }
    if = { limit = { has_province_flag = Infra_S6 } subtract_key = { lhs = Public_Tmp1 value = 1 } }
    if = { limit = { has_province_flag = Infra_S7 } subtract_key = { lhs = Public_Tmp1 value = 1 } }
    if = { limit = { has_province_flag = Infra_S8 } subtract_key = { lhs = Public_Tmp1 value = 1 } }
    if = { limit = { has_province_flag = Infra_S9 } subtract_key = { lhs = Public_Tmp1 value = 1 } }
    
    if = {
        limit = {
            check_key = { lhs = Public_Tmp1 value = 1 }
        }
        if = {
            limit = {
                check_key = { lhs = Public_Tmp1 which = $width$ }
            }
            set_key = { lhs = Public_Tmp1 which = $width$ }
        }
    
        set_key = { lhs = Public_Tmp3 which = Public_Tmp2 }
    
        divide_key = { lhs = Public_Tmp2 which = Public_Tmp1 }
		multiply_key = { lhs = Public_Tmp2 value = 0.001 }
        multiply_key = { lhs = Public_Tmp2 value = 1000 }
    
        set_key = { lhs = Public_Tmp4 which = Public_Tmp2 }
        multiply_key = { lhs = Public_Tmp4 which = Public_Tmp1 }
        subtract_key = { lhs = Public_Tmp3 which = Public_Tmp4 }
    
        set_key = { lhs = Public_Tmp4 value = 0 }
            
        while = {
            limit = {
                check_key = { lhs = Public_Tmp1 value = 1 }
            }
            subtract_key = { lhs = Public_Tmp1 value = 1 }
    
            if = {
                limit = {
                    check_key = { lhs = Public_Tmp3 value = 1 }
                }
                change_key = { lhs = Public_Tmp2 value = 1 }
            }
            
			if = {
				limit = {
					check_key = { lhs = Public_Tmp2 value = 1 }
				}
				if = {
					limit = {
						NOT = { has_province_flag = Infra_S0 }
					}
					Infra_StartProjectHelper = { slot = 0 id = $id$ size = Public_Tmp2 width = $width$ [[owner] owner = $owner$ ] }
				}
				else_if = {
					limit = {
						NOT = { has_province_flag = Infra_S1 }
					}
					Infra_StartProjectHelper = { slot = 1 id = $id$ size = Public_Tmp2 width = $width$ [[owner] owner = $owner$ ] }
				}
				else_if = {
					limit = {
						NOT = { has_province_flag = Infra_S2 }
					}
					Infra_StartProjectHelper = { slot = 2 id = $id$ size = Public_Tmp2 width = $width$ [[owner] owner = $owner$ ] }
				}
				else_if = {
					limit = {
						NOT = { has_province_flag = Infra_S3 }
					}
					Infra_StartProjectHelper = { slot = 3 id = $id$ size = Public_Tmp2 width = $width$ [[owner] owner = $owner$ ] }
				}
				else_if = {
					limit = {
						NOT = { has_province_flag = Infra_S4 }
					}
					Infra_StartProjectHelper = { slot = 4 id = $id$ size = Public_Tmp2 width = $width$ [[owner] owner = $owner$ ] }
				}
				else_if = {
					limit = {
						NOT = { has_province_flag = Infra_S5 }
					}
					Infra_StartProjectHelper = { slot = 5 id = $id$ size = Public_Tmp2 width = $width$ [[owner] owner = $owner$ ] }
				}
				else_if = {
					limit = {
						NOT = { has_province_flag = Infra_S6 }
					}
					Infra_StartProjectHelper = { slot = 6 id = $id$ size = Public_Tmp2 width = $width$ [[owner] owner = $owner$ ] }
				}
				else_if = {
					limit = {
						NOT = { has_province_flag = Infra_S7 }
					}
					Infra_StartProjectHelper = { slot = 7 id = $id$ size = Public_Tmp2 width = $width$ [[owner] owner = $owner$ ] }
				}
				else_if = {
					limit = {
						NOT = { has_province_flag = Infra_S8 }
					}
					Infra_StartProjectHelper = { slot = 8 id = $id$ size = Public_Tmp2 width = $width$ [[owner] owner = $owner$ ] }
				}
				else_if = {
					limit = {
						NOT = { has_province_flag = Infra_S9 }
					}
					Infra_StartProjectHelper = { slot = 9 id = $id$ size = Public_Tmp2 width = $width$ [[owner] owner = $owner$ ] }
				}
			}
    
            if = {
                limit = {
                    check_key = { lhs = Public_Tmp3 value = 1 }
                }
                subtract_key = { lhs = Public_Tmp3 value = 1 }
                subtract_key = { lhs = Public_Tmp2 value = 1 }
            }
        }
    
        Infra_RefreshModifier = yes
    }
    
    set_key = { lhs = Public_Tmp1 value = 0 }
    set_key = { lhs = Public_Tmp2 value = 0 }
    set_key = { lhs = Public_Tmp3 value = 0 }
    set_key = { lhs = Public_Tmp4 value = 0 }
}

Infra_CheckProject = {
    if = {
        limit = {
			has_province_flag = Infra_S$slot$
        }
        Infra_CheckProjectHelper = { slot = $slot$ prod = 6 }
        Infra_CheckProjectHelper = { slot = $slot$ prod = 22 }
        Infra_CheckProjectHelper = { slot = $slot$ prod = 23 }
        Infra_CheckProjectHelper = { slot = $slot$ prod = 24 }
        Infra_CheckProjectHelper = { slot = $slot$ prod = 41 }
        Infra_CheckProjectHelper = { slot = $slot$ labor = R }
        Infra_CheckProjectHelper = { slot = $slot$ labor = UL }

        if = {
            limit = {
                is_key_equal = { lhs = Infra_S$slot$6 value = 0 }
                is_key_equal = { lhs = Infra_S$slot$22 value = 0 }
                is_key_equal = { lhs = Infra_S$slot$23 value = 0 }
                is_key_equal = { lhs = Infra_S$slot$24 value = 0 }
                is_key_equal = { lhs = Infra_S$slot$41 value = 0 }
                is_key_equal = { lhs = Infra_S$slot$R value = 0 }
                is_key_equal = { lhs = Infra_S$slot$UL value = 0 }
            }
            Infra_RunScript = { id = Infra_S$slot$ script = Infra_AddBuilding }
            Infra_RunScript = { id = Infra_S$slot$ script = Infra_InConstSubt }

            if = {
                limit = {
                    check_key = { lhs = Infra_S$slot$Size value = 1 }
                }
                subtract_key = { lhs = Infra_S$slot$Size value = 1 }

                Infra_RunScript = { id = Infra_S$slot$ script = Infra_GetCostBuild }

                set_key = { lhs = Infra_S$slot$6 which = Infra_Cost6 }
                set_key = { lhs = Infra_S$slot$22 which = Infra_Cost22 }
                set_key = { lhs = Infra_S$slot$23 which = Infra_Cost23 }
                set_key = { lhs = Infra_S$slot$24 which = Infra_Cost24 }
                set_key = { lhs = Infra_S$slot$41 which = Infra_Cost41 }
                set_key = { lhs = Infra_S$slot$R which = Infra_CostR }
                set_key = { lhs = Infra_S$slot$UL which = Infra_CostUL }

                set_key = { lhs = Infra_Cost6 value = 0 }
                set_key = { lhs = Infra_Cost22 value = 0 }
                set_key = { lhs = Infra_Cost23 value = 0 }
                set_key = { lhs = Infra_Cost24 value = 0 }
                set_key = { lhs = Infra_Cost41 value = 0 }
                set_key = { lhs = Infra_CostR value = 0 }
                set_key = { lhs = Infra_CostUL value = 0 }
            }
            else = {
				clr_province_flag = Infra_S$slot$
                set_key = { lhs = Infra_S$slot$ value = 0 }
                set_key = { lhs = Infra_S$slot$Size value = 0 }
                set_key = { lhs = Infra_S$slot$Owner value = 0 }
                set_key = { lhs = Infra_S$slot$Spend value = 0 }
                set_key = { lhs = Infra_S$slot$Parallel value = 0 }
            }
        }
    }
}

Infra_SpendProject = {
    set_key = { lhs = Infra_S$slot$Spend value = 0 }

    if = {
        limit = {
			has_province_flag = Infra_S$slot$
        }
        Infra_SpendProjectHelper = { slot = $slot$ prod = 6 }
        Infra_SpendProjectHelper = { slot = $slot$ prod = 22 }
        Infra_SpendProjectHelper = { slot = $slot$ prod = 23 }
        Infra_SpendProjectHelper = { slot = $slot$ prod = 24 }
        Infra_SpendProjectHelper = { slot = $slot$ prod = 41 }
        Infra_SpendProjectHelper = { slot = $slot$ labor = R }
        Infra_SpendProjectHelper = { slot = $slot$ labor = UL }

        if = {
            limit = {
                check_key = { lhs = Infra_S$slot$Owner value = 1 }
            }
            if = {
                limit = {
                    check_key = { lhs = Infra_S$slot$Owner value = 4 }
                }
                if = {
                    limit = {
                        check_key = { lhs = Infra_S$slot$Owner value = 5 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Infra_S$slot$Owner value = 6 }
                        }
                        if = {
                            limit = {
                                check_key = { lhs = Infra_S$slot$Owner value = 7 }
                            }
                            change_key = { lhs = Building_ProjectSpend which = Infra_S$slot$Spend }
                        }
                        else = {
							change_key = { lhs = CL_SpendPrp which = Infra_S$slot$Spend }
                        }
                    }
                    else = {
						change_key = { lhs = BG_SpendPrp which = Infra_S$slot$Spend }
                    }
                }
                else = {
					change_key = { lhs = NO_SpendPrp which = Infra_S$slot$Spend }
                }
            }
            else = {
                if = {
                    limit = {
                        check_key = { lhs = Infra_S$slot$Owner value = 2 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Infra_S$slot$Owner value = 3 }
                        }
						change_key = { lhs = RE_SpendPrp which = Infra_S$slot$Spend }
                    }
                    else = {
						change_key = { lhs = NM_SpendPrp which = Infra_S$slot$Spend }
                    }
                }
                else = {
					change_key = { lhs = SF_SpendPrp which = Infra_S$slot$Spend }
                }
            }
        }
        else = {
            change_key = { lhs = Infra_Spend which = Infra_S$slot$Spend }
        }
    }
}

Infra_InConstAdd = {
    [[building]
        change_key = { lhs = Infra_InConst$building$ which = $size$ }
    ]
    [[infra]
        change_key = { lhs = Infra_InConst$infra$ which = $size$ }
    ]
}
Infra_InConstSubt = {
    [[building]
        subtract_key = { lhs = Infra_InConst$building$ value = 1 }
    ]
    [[infra]
        subtract_key = { lhs = Infra_InConst$infra$ value = 1 }
    ]
}

Infra_StartProjectHelper = {
    set_province_flag = Infra_S$slot$
    set_key = { lhs = Infra_S$slot$ value = $id$ }
    set_key = { lhs = Infra_S$slot$Size which = $size$ }
    set_key = { lhs = Infra_S$slot$Parallel which = $width$ }
    subtract_key = { lhs = Infra_S$slot$Size value = 1 }
    [[owner] set_key = { lhs = Infra_S$slot$Owner value = $owner$ } ]

    Infra_RunScript = { id = Infra_S$slot$ script = Infra_GetCostBuild }
    Infra_RunScript = { id = Infra_S$slot$ script = Infra_InConstAdd paramInfra = size inpInfra = $size$ }

    set_key = { lhs = Infra_S$slot$6 which = Infra_Cost6 }
    set_key = { lhs = Infra_S$slot$22 which = Infra_Cost22 }
    set_key = { lhs = Infra_S$slot$23 which = Infra_Cost23 }
    set_key = { lhs = Infra_S$slot$24 which = Infra_Cost24 }
    set_key = { lhs = Infra_S$slot$41 which = Infra_Cost41 }
    set_key = { lhs = Infra_S$slot$R which = Infra_CostR }
    set_key = { lhs = Infra_S$slot$UL which = Infra_CostUL }

    set_key = { lhs = Infra_Cost6 value = 0 }
    set_key = { lhs = Infra_Cost22 value = 0 }
    set_key = { lhs = Infra_Cost23 value = 0 }
    set_key = { lhs = Infra_Cost24 value = 0 }
    set_key = { lhs = Infra_Cost41 value = 0 }
    set_key = { lhs = Infra_CostR value = 0 }
    set_key = { lhs = Infra_CostUL value = 0 }
}   

Infra_CheckProjectHelper = {
    [[prod]
		if = {
			limit = {
				check_key = { lhs = Infra_S$slot$$prod$ value = 0.1 }
			}
			set_key = { lhs = Public_Tmp1 value = 100 }
			subtract_key = { lhs = Public_Tmp1 which = TN_ProvFill$prod$ }
			multiply_key = { lhs = Public_Tmp1 value = 0.01 }
			multiply_key = { lhs = Infra_S$slot$$prod$ which = Public_Tmp1 }
		}
		else = {
			set_key = { lhs = Infra_S$slot$$prod$ value = 0 }
		}
    ]
    [[labor]
		if = {
			limit = {
				check_key = { lhs = Infra_S$slot$$labor$ value = 0.1 }
			}
			set_key = { lhs = Public_Tmp1 value = 100 }
			subtract_key = { lhs = Public_Tmp1 which = Prod_Fill$labor$ }
			multiply_key = { lhs = Public_Tmp1 value = 0.01 }
			multiply_key = { lhs = Infra_S$slot$$labor$ which = Public_Tmp1 }
		}
		else = {
			set_key = { lhs = Infra_S$slot$$labor$ value = 0 }
		}
    ]
}

Infra_SpendProjectHelper = {
    [[prod]
        if = {
            limit = {
                check_key = { lhs = Infra_S$slot$$prod$ value = 0.001 }
            }
            set_key = { lhs = Public_Tmp1 which = Infra_S$slot$$prod$ }
            multiply_key = { lhs = Public_Tmp1 which = TN_SectorSpend$prod$ }
            change_key = { lhs = Infra_S$slot$Spend which = Public_Tmp1 }
        }
    ]
    [[labor]
        if = {
            limit = {
                check_key = { lhs = Infra_S$slot$$labor$ value = 0.001 }
            }
            set_key = { lhs = Public_Tmp1 which = Infra_S$slot$$labor$ }
            multiply_key = { lhs = Public_Tmp1 which = Prod_Fill$labor$ }
			multiply_key = { lhs = Public_Tmp1 value = 0.01 }
            multiply_key = { lhs = Public_Tmp1 which = Class_P$labor$ }
            change_key = { lhs = Infra_S$slot$Spend which = Public_Tmp1 }
        }
    ]
}

Infra_SetMaintHelper = {
    if = {
        limit = {
            has_province_flag = Prod_S$slot$
            has_province_flag = Prod_S$slot$DmndB$type$
        }
		### First sum labor into designated pools
		if = {
			limit = {
				check_key = { lhs = Prod_S$slot$DmndR value = 0.001 }
			}
			change_key = { lhs = Tmp_4 which = Prod_S$slot$DmndR } ## Rural
		}
		if = {
			limit = {
				check_key = { lhs = Prod_S$slot$DmndUL value = 0.001 }
			}
			change_key = { lhs = Tmp_5 which = Prod_S$slot$DmndUL } ## Urban
		}
		if = {
			limit = {
				check_key = { lhs = Prod_S$slot$DmndNM value = 0.001 }
			}
			change_key = { lhs = Tmp_6 which = Prod_S$slot$DmndNM } ## Nomad
		}
		if = {
			limit = {
				check_key = { lhs = Prod_S$slot$DmndLT value = 0.001 }
			}
			change_key = { lhs = Tmp_7 which = Prod_S$slot$DmndLT } ## Literati
		}
		if = {
			limit = {
				check_key = { lhs = Prod_S$slot$DmndCL value = 0.001 }
			}
			change_key = { lhs = Tmp_8 which = Prod_S$slot$DmndCL } ## Clergy
		}
		if = {
			limit = {
				check_key = { lhs = Prod_S$slot$DmndBG value = 0.001 }
			}
			change_key = { lhs = Public_Tmp1 which = Prod_S$slot$DmndBG } ## Burghers
		}

		
		if = {
			limit = {
				NOT = {
					has_global_flag = POP_Sim1
				}
			}

			### Result Variables
            # Tmp_0 = (Perceived) Current Profit
            # Tmp_1 = (Perceived) Current Profit Margin
            # Tmp_2 = Desired Change Rate in Size %
			set_key = { lhs = Tmp_0 which = Prod_S$slot$Income }
			# Subtract Spending from Income to get profits
			subtract_key = { lhs = Tmp_0 which = Prod_S$slot$Spend }
			
			[[IncomeMaint]
			# Take out 2.5% of building income for Income based Maint (Commercial)
			if = {
				limit = {
					always = $IncomeMaint$
					check_key = { lhs = Building_$type$IncomeAverage value = 0.001 }
				}
				set_key = { lhs = Tmp_3 which = Building_$type$IncomeAverage }
				multiply_key = { lhs = Tmp_3 value = 0.02 }
				multiply_key = { lhs = Tmp_3 which = Modi_$type$Cost }
				multiply_key = { lhs = Tmp_3 which = Modi_BuildingCost }
				multiply_key = { lhs = Tmp_3 which = Modi_BuildingTime }
				subtract_key = { lhs = Tmp_0 which = Tmp_3 }
			}
			]

			### DBZ handling if income = 0 --> cant get a profit margin if income = 0
			# Result: Tmp_1 = Profit Margin
			if = { 
				limit = { 
					is_key_equal = { lhs = Prod_S$slot$Income value = 0 } 
				}
				set_key = { lhs = Tmp_1 value = 0 }
			}
			else = { ## If Income != 0
				# Calculate profit margin - Profit / Income
				set_key = { lhs = Tmp_1 which = Tmp_0 }
				divide_key = { lhs = Tmp_1 which = Prod_S$slot$Income }

				# If Profit Margin is positive, add a throughput factor and reduce perceived profits 
				# This is done to aritificially reduce expansion demand if throughput is low because non existing inputs
				if = {
					limit = {
						check_key = { lhs = Tmp_1 value = 0.001 }
					}
					### Add a throughput factor
					set_key = { lhs = Tmp_3 which = Prod_S$slot$SizeCur }
					divide_key = { lhs = Tmp_3 which = Prod_S$slot$Size }

					if = {
						limit = { 
							NOT = { check_key = { lhs = Tmp_3 value = 1 } } ### Throughputfactor only applied if TP < 100%
						}
						multiply_key = { lhs = Tmp_3 which = Tmp_3 } ### Exponential effect
						multiply_key = { lhs = Tmp_3 which = Tmp_3 } ### Double exponential effect

						### Throughput factor on perceived profits:
						### TP * TP * PM = Perceived Profit Margin
						multiply_key = { lhs = Tmp_1 which = Tmp_3 }	
						set_key = { lhs = Tmp_3 value = 0 }	
					}
				}
				else = { ### If industry is making losses, check if industry already developed full skill. If not make it decrease size slower based on lower skill
					### Add a sophistication (skill) factor
					set_key = { lhs = Tmp_4 which = Prod_S$slot$Soph }
					multiply_key = { lhs = Tmp_4 value = 0.01 }

					if = {
						limit = { 
							NOT = { check_key = { lhs = Tmp_4 value = 1 } } ### Skill Factor only applied if Skill < 100%
						}
						multiply_key = { lhs = Tmp_4 which = Tmp_4 } # Exponential effect of low skill

						### Skill factor on perceived loss
						### Skill * Skill * PM = Perceived Loss Margin
						multiply_key = { lhs = Tmp_1 which = Tmp_4 }
						set_key = { lhs = Tmp_4 value = 0 }
					}
				}

			}

			### Actual heuristic for Industry Expansion
			# Formula for expansion desire for Perceived Profit Margin != 0:
			# (   33 							)
			# ( ------ * Profit Margin + 0.2 * Profit Margin ) * 0.15
			# (  Size							)
			if = {
				limit = {
					check_key = { lhs = Tmp_1 value = 0.04 } # profit margin >= 4 % --> expand
				}
				set_key = { lhs = Tmp_2 value = 33 }
				divide_key = { lhs = Tmp_2 which = Prod_S$slot$Size }
				multiply_key = { lhs = Tmp_2 which = Tmp_1 }
				multiply_key = { lhs = Tmp_1 value = 0.2 }
				change_key = { lhs = Tmp_1 which = Tmp_2 }
			}
			else_if = {
				limit = {
					NOT = { check_key = { lhs = Tmp_1 value = 0.04 } } # profit margin < 4 %
					check_key = { lhs = Tmp_0 value = 0 } # Profits > 0
				}

				# NO CHANGE IN SIZE
				set_key = { lhs = Tmp_1 value = 0 }
			}
			else = {  # Profits < 0
				#Tmp_1 is a negative value here
				set_key = { lhs = Tmp_2 value = 33 }
				divide_key = { lhs = Tmp_2 which = Prod_S$slot$Size }
				multiply_key = { lhs = Tmp_2 which = Tmp_1 }
				multiply_key = { lhs = Tmp_1 value = 0.2 }
				change_key = { lhs = Tmp_1 which = Tmp_2 }
				divide_key = { lhs = Tmp_1 value = 2.0 } # `Industry_NaturalShrinkage_DivisionFactor~value` Balance factor to make shrinkage slower then expansion
			}

			multiply_key = { lhs = Tmp_1 value = 0.15 } ## Balance Factor on desired change



			##### Calculate actual size changes

			if = { # If Perceived Profit is positive, building will want to expand.
				limit = {
					check_key = { lhs = Tmp_1 value = 0 }
				}

				set_key = { lhs = Prod_S$slot$Change which = Tmp_1 } # Desired rate of change

				# Cap desired change rate 
				if = {
					limit = {
						check_key = { lhs = Prod_S$slot$Change value = 1.0 } # `Industry_NaturalMax_ChangeUp~value`
					}
					set_key = { lhs = Prod_S$slot$Change value = 1.0 } # `Industry_NaturalMax_ChangeUp~value`
				}

				multiply_key = { lhs = Prod_S$slot$Change which = Prod_S$slot$Size } # Desired size change rate * Current size
				
				set_key = { lhs = Tmp_2 which = Prod_S$slot$Change }
				[[IncomeMaint] multiply_key = { lhs = Tmp_2 value = 1.5 } ] ## fast change for commercial based prop
				if = { # slower changes in sim
					limit = { has_global_flag = POP_Sim }
					multiply_key = { lhs = Tmp_2 value = 0.666 }
				}
				change_key = { lhs = Building_$type$Up which = Tmp_2 }
                
                # Building_$type$Up represents an absolute amount of units that want to be expanded in the industry.
                # according to all the desirable changes of the industries (either expansion or shrinking) belonging to that same Property.
                # Example: If farmlands has 4 industries and 2 of them want to grow, Farmlands will have 2 industries that provide a Building_$type$Up 
                # and 2 of them that provide a Building_$type$Down value. 
                # On the other hand, Prod_S$slot$Change reflects the specific change desire of absolute units of an specific industry. 
			}
			else = { # if Tmp_1 is negative, will want to shrink.
				set_key = { lhs = Prod_S$slot$Change which = Tmp_1 } # Desired rate of change -> her 

				# cap desired change rate
				if = {
					limit = {
						NOT = { check_key = { lhs = Prod_S$slot$Change value = -0.25 } } # `Industry_NaturalMax_ChangeDown~value`
					}
					set_key = { lhs = Prod_S$slot$Change value = -0.25 } # `Industry_NaturalMax_ChangeDown~value`
				}

				multiply_key = { lhs = Prod_S$slot$Change which = Prod_S$slot$Size } # Desired size change rate * Current size
				
				set_key = { lhs = Tmp_2 which = Prod_S$slot$Change }
				[[IncomeMaint] multiply_key = { lhs = Tmp_2 value = 1.5 } ] ## fast change for commercial based prop
				if = { # slower changes in sim
					limit = { has_global_flag = POP_Sim }
					multiply_key = { lhs = Tmp_2 value = 0.666 }
				}
				subtract_key = { lhs = Building_$type$Down which = Tmp_2 } # Building_$type$Down represents an abstract value for shrinkage desire.
			}
		}
    }
}

Infra_SetMaint = {
    set_key = { lhs = Building_$type$Up value = 0 }   # property expansion desire
    set_key = { lhs = Building_$type$Down value = 0 } # property shrink desire
	set_key = { lhs = Building_$type$1 value = 0 } # food maintenance
	set_key = { lhs = Building_$type$6 value = 0 } # raw
	set_key = { lhs = Building_$type$24 value = 0 } # industrial
	
	if = {
		limit = {
			check_key = { lhs = Building_$type$ value = 0.01 }
		}
		
		# Labor vars
		set_key = { lhs = Tmp_4 value = 0 } ## Rural
		set_key = { lhs = Tmp_5 value = 0 } ## Urban
		set_key = { lhs = Tmp_6 value = 0 } ## Nomad
		set_key = { lhs = Tmp_7 value = 0 } ## Literati
		set_key = { lhs = Tmp_8 value = 0 } ## Clergy
		set_key = { lhs = Public_Tmp1 value = 0 } ## Burghers

		Infra_SetMaintHelper = { type = $type$ slot = 0 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] } # calculate profitability of every slot. Industry heuristic logic.
		Infra_SetMaintHelper = { type = $type$ slot = 1 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }  
		Infra_SetMaintHelper = { type = $type$ slot = 2 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 3 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 4 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 5 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 6 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 7 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 8 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 9 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 10 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 11 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 12 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 13 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 14 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }
		Infra_SetMaintHelper = { type = $type$ slot = 15 [[IncomeMaint] IncomeMaint = $IncomeMaint$ ] }


		# Cap downward move so size doesnt go below size = 1
		if = {
			limit = {
				check_key = { lhs = Building_$type$Down which = Building_$type$ } # if down >= size
			}
			set_key = { lhs = Building_$type$Down which = Building_$type$ }
			subtract_key = { lhs = Building_$type$Down value = 1 }
		}

		set_key = { lhs = Tmp_3 value = 0 }
		[[max]
		## Decrease desired growth for maintenance calculation to not overspend on maintenance
		# For this we get the difference from current size to the max and compare it further below with the desire to grow
		set_key = { lhs = Tmp_3 which = Building_$type$Max }
		subtract_key = { lhs = Tmp_3 which = Building_$type$ }
		]

		[[RegularMaint]
        if = {
            limit = {
				always = $RegularMaint$
			}
			# Calculate Shrinkage or expansion
			set_key = { lhs = Tmp_0 which = Building_$type$Up }
			subtract_key = { lhs = Tmp_0 which = Building_$type$Down }

			# Check if desired rate of growht (only if positive) exceeds limit to max, if so only pay maintenance until max cap
			if = {
				limit = { 
					check_key = { lhs = Tmp_0 which = Tmp_3 } # Tmp_0 = desired growth, Tmp_3 difference to max cap
					check_key = { lhs = Tmp_3 value = 0.001 }
				}
				set_key = { lhs = Tmp_0 which = Tmp_3 }
			}

			set_key = { lhs = Tmp_1 which = Building_$type$ }
			### Remove shrinking property from paying maintenance
			if = {
				limit = { 
					NOT = { check_key = { lhs = Tmp_0 value = 0 } } # If property wants to shrink
				}
				change_key = { lhs = Tmp_1 which = Tmp_0 } # Remove desired shrinkage from property to pay maintenance on
			}

			multiply_key = { lhs = Tmp_1 value = $rate$ } ### basically a multiplier on building count to determine maint costs

			## If industries want to expand add expansion costs to maintenance costs
			if = {
				limit = { 
					check_key = { lhs = Tmp_0 value = 0 }
				}

				multiply_key = { lhs = Tmp_0 value = $factor$ } ### how much do new buildings cost
				change_key = { lhs = Tmp_1 which = Tmp_0 } # add expansion build costs to maintenance costs
			}

			# calculate total costs for maintenance + building
			multiply_key = { lhs = Tmp_1 which = Modi_$type$Cost }
			multiply_key = { lhs = Tmp_1 which = Modi_BuildingCost }
			multiply_key = { lhs = Tmp_1 which = Modi_BuildingTime }
						
			set_key = { lhs = Building_$type$1  which = Tmp_1 }
			set_key = { lhs = Building_$type$6  which = Tmp_1 }
			set_key = { lhs = Building_$type$24 which = Tmp_1 }
			
			multiply_key = { lhs = Building_$type$1 value = $food$ }
			multiply_key = { lhs = Building_$type$6 value = $raw$ }
			multiply_key = { lhs = Building_$type$24 value = $indust$ }
		}
		]

		[[IncomeMaint] ### This handles commercial
        if = {
            limit = {
				always = $IncomeMaint$
			}
			if = {
				limit = {
					check_key = { lhs = Building_$type$IncomeAverage value = 0.001 }
				}
				set_key = { lhs = Tmp_0 which = Building_$type$IncomeAverage } ## Commerce pays a % of their income as maintenance
				multiply_key = { lhs = Tmp_0 value = 0.02 }
				multiply_key = { lhs = Tmp_0 which = Modi_$type$Cost }
				multiply_key = { lhs = Tmp_0 which = Modi_BuildingCost }
				multiply_key = { lhs = Tmp_0 which = Modi_BuildingTime }
				
				set_key = { lhs = Tmp_1 value = 0 }
				
				set_key = { lhs = Tmp_2 which = TN_ProvPrc1 } # food price
				multiply_key = { lhs = Tmp_2 value = $food$ } # fixed value
				change_key = { lhs = Tmp_1 which = Tmp_2 }
				
				set_key = { lhs = Tmp_2 which = TN_ProvPrc6 } # raw material price
				multiply_key = { lhs = Tmp_2 value = $raw$ }  # fixed value
				change_key = { lhs = Tmp_1 which = Tmp_2 }
				
				set_key = { lhs = Tmp_2 which = TN_ProvPrc24 } # industral price
				multiply_key = { lhs = Tmp_2 value = $indust$ } # fixed value
				change_key = { lhs = Tmp_1 which = Tmp_2 }
				
				divide_key = { lhs = Tmp_0 which = Tmp_1 } # calculate the demand level. 2.5% of income average / sum (costs of products).
				
				set_key = { lhs = Tmp_1 which = Tmp_0 }
				multiply_key = { lhs = Tmp_1 value = $food$ }
				change_key = { lhs = Building_$type$1 which = Tmp_1 } # how much food it used
				
				set_key = { lhs = Tmp_1 which = Tmp_0 }
				multiply_key = { lhs = Tmp_1 value = $raw$ } 
				change_key = { lhs = Building_$type$6 which = Tmp_1 } # how much raw material it used
				
				set_key = { lhs = Tmp_1 which = Tmp_0 }
				multiply_key = { lhs = Tmp_1 value = $indust$ }
				change_key = { lhs = Building_$type$24 which = Tmp_1 } # how much industrial product it used
			}
		}
		]
	}
	
	#### Handle State Investments
	if = {
		limit = { # add maintenance costs based on state expansion if state invested. Always applies since state forced the expansion.
			check_key = { lhs = Building_$type$Wealth value = 0.01 }
		}

		# Sum costs per unit in price
		set_key = { lhs = Tmp_0 value = 0 }

		set_key = { lhs = Tmp_1 which = TN_ProvPrc1 }
		multiply_key = { lhs = Tmp_1 value = $food$ }
		change_key = { lhs = Tmp_0 which = Tmp_1 }

		set_key = { lhs = Tmp_1 which = TN_ProvPrc6 }
		multiply_key = { lhs = Tmp_1 value = $raw$ }
		change_key = { lhs = Tmp_0 which = Tmp_1 }

		set_key = { lhs = Tmp_1 which = TN_ProvPrc24 }
		multiply_key = { lhs = Tmp_1 value = $indust$ }
		change_key = { lhs = Tmp_0 which = Tmp_1 }

		multiply_key = { lhs = Tmp_0 value = $factor$ } # balance factor on how much new property costs per unit

		### Calculate State Investment Ability:
		#            25
		# 1 - ------------------
		#      StateReach + 25

		set_key = { lhs = Tmp_2 value = 25 } #`Industry_StateInvestment_Ability_BUPow_NeutralPoint~value`
		set_key = { lhs = Tmp_3 which = Prov_BUPow }
		change_key = { lhs = Tmp_3 value = 25 } #`Industry_StateInvestment_Ability_BUPow_NeutralPoint~value`
		divide_key = { lhs = Tmp_2 which = Tmp_3 }
		multiply_key = { lhs = Tmp_2 value = -1 }
		change_key = { lhs = Tmp_2 value = 1 }

		### Calculate State Investment Effectiveness:
		#      Corruption  
		# 1 - -------------
		#         150      
		set_key = { lhs = Tmp_3 which = Prov_BULoy }
		divide_key = { lhs = Tmp_3 value = 150 } #`Industry_StateInvestment_Corruption_BULoy_Divisor~value`
		multiply_key = { lhs = Tmp_3 value = -1 }
		change_key = { lhs = Tmp_3 value = 1 }

		set_key = { lhs = Building_$type$Wealth_Invested which = Building_$type$Wealth } # State investment
		multiply_key = { lhs = Building_$type$Wealth_Invested which = Tmp_2 } # Apply State Investment Ability to get fraction that can be invested at a time
		
		# Apply State Investment Effectivess to determine how much is just given into spending pool
		# -> at the end this means elites have to pay less out of own pockets = corruption
		set_key = { lhs = Building_$type$Wealth_Invested_Crpt which = Building_$type$Wealth_Invested }
		multiply_key = { lhs = Building_$type$Wealth_Invested which = Tmp_3 } # this is real investment now (-corruption)
		subtract_key = { lhs = Building_$type$Wealth_Invested_Crpt which = Building_$type$Wealth_Invested } # this is corruption value

		# Calculate affordable units when doing an investment
		set_key = { lhs = Tmp_1 which = Building_$type$Wealth_Invested } # this is real investment (investment - corruption)
		divide_key = { lhs = Tmp_1 which = Tmp_0 } # Real Invested Wealth / cost per unit = units affordable

		# if real investment can afford to expand at least >0 units of property -> invest
		if = {
			limit = {
				check_key = { lhs = Tmp_1 value = 0.01 }
			}
			change_key = { lhs = Building_$type$Up which = Tmp_1 } ## add affordable units to expansion desire


			## Calcualte good demands
			multiply_key = { lhs = Tmp_1 which = Modi_$type$Cost }
			multiply_key = { lhs = Tmp_1 which = Modi_BuildingCost }
			multiply_key = { lhs = Tmp_1 which = Modi_BuildingTime }

			set_key = { lhs = Tmp_2	which = Tmp_1 }
			set_key = { lhs = Tmp_3	which = Tmp_1 }
			set_key = { lhs = Tmp_4 which = Tmp_1 }

			multiply_key = { lhs = Tmp_2 value = $food$ }
			multiply_key = { lhs = Tmp_3 value = $raw$ }
			multiply_key = { lhs = Tmp_4 value = $indust$ }

			## add additional building goods demands
			change_key = { lhs = Building_$type$1  which = Tmp_2 }
			change_key = { lhs = Building_$type$6  which = Tmp_3 }
			change_key = { lhs = Building_$type$24 which = Tmp_4 }

			###
			# WEATLH DEDUCTION FROM INVESTMENT POOL IS DONE IN Infra_DoSpend!!!
			###
		}
		else = { # No units affordable --> no investment happens
			set_key = { lhs = Building_$type$Wealth_Invested	  value = 0 }
			set_key = { lhs = Building_$type$Wealth_Invested_Crpt value = 0 }
		}
	}
}

# Returns:
# Tmp_0 size of all industries
# Tmp_1 size of nomad cottage
# Tmp_2 size of higher learning
Infra_RefreshIndustryHelper = {
    if = {
        limit = {
            has_province_flag = Prod_S$slot$
            has_province_flag = Prod_S$slot$DmndB$type$
        }
        change_key = { lhs = Tmp_0 which = Prod_S$slot$Size }
		# Prevent certain industries from expanding under certain conditions.
		
		# Nomad Pasture industry won't expand for countries where the owner is not a nomad
        [[excl]
            if = {
                limit = {
                    owner = { is_nomad = no }
                    is_key_equal = { lhs = Prod_S$slot$ value = $excl$ }
                }
                set_province_flag = exclude_$slot$
                change_key = { lhs = Tmp_1 which = Prod_S$slot$Size }
            }
            else = { clr_province_flag = exclude_$slot$ }
        ]
        # Cottage industry won't expand for provinces where Industrial district is big enough
        [[excl_cottage]
            if = {
                limit = {
                    has_province_flag = Building_IndustrialHas
                    is_key_equal = { lhs = Prod_S$slot$ value = $excl_cottage$ }
                    check_key = { lhs = Building_Industrial which = Prod_S$slot$Size }
                }
                set_province_flag = exclude_$slot$
                change_key = { lhs = Tmp_1 which = Prod_S$slot$Size }
            }
            else = { clr_province_flag = exclude_$slot$ }
        ]
        # Religious education won't expand if the province has an university
        [[excl_relig]
            if = {
                limit = {
                    has_province_flag = Has_Uni
                    is_key_equal = { lhs = Prod_S$slot$ value = $excl_relig$ }
                }
                set_province_flag = exclude_$slot$
                change_key = { lhs = Tmp_1 which = Prod_S$slot$Size }
            }
            else = { clr_province_flag = exclude_$slot$ }
        ]
    }
}

Infra_RefreshIndustry = {
    set_key = { lhs = Tmp_0 value = 0 }
    set_key = { lhs = Tmp_1 value = 0 }

	# This is used to sum up the size per type of property in all the slots
    Infra_RefreshIndustryHelper = { slot = 0 type = $type$  [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 1 type = $type$  [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 2 type = $type$  [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 3 type = $type$  [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 4 type = $type$  [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 5 type = $type$  [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 6 type = $type$  [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 7 type = $type$  [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 8 type = $type$  [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 9 type = $type$  [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 10 type = $type$ [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 11 type = $type$ [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 12 type = $type$ [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 13 type = $type$ [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 14 type = $type$ [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
    Infra_RefreshIndustryHelper = { slot = 15 type = $type$ [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }

    if = {
        limit = {
            check_key = { lhs = Tmp_0 value = 0.001 } # Tmp_0 = Size of all industries combined
        }
        if = {
            limit = {
                OR = {
                    has_global_flag = POP_Sim
                    
                    NOT = {
                        check_key = { lhs = Building_$type$ which = Tmp_0 } # If property isn't greater than the size of it's industries combined
                    }

                    is_key_equal = { lhs = Tmp_1 value = 0 }
                    is_key_equal = { lhs = Tmp_0 which = Tmp_1 } 
				}
            }
            set_key = { lhs = Tmp_2 which = Building_$type$ }
            divide_key = { lhs = Tmp_2 which = Tmp_0 }

            if = { limit = { has_province_flag = Prod_S0DmndB$type$ }  multiply_key = { lhs = Prod_S0Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S1DmndB$type$ }  multiply_key = { lhs = Prod_S1Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S2DmndB$type$ }  multiply_key = { lhs = Prod_S2Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S3DmndB$type$ }  multiply_key = { lhs = Prod_S3Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S4DmndB$type$ }  multiply_key = { lhs = Prod_S4Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S5DmndB$type$ }  multiply_key = { lhs = Prod_S5Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S6DmndB$type$ }  multiply_key = { lhs = Prod_S6Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S7DmndB$type$ }  multiply_key = { lhs = Prod_S7Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S8DmndB$type$ }  multiply_key = { lhs = Prod_S8Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S9DmndB$type$ }  multiply_key = { lhs = Prod_S9Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S10DmndB$type$ } multiply_key = { lhs = Prod_S10Size which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S11DmndB$type$ } multiply_key = { lhs = Prod_S11Size which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S12DmndB$type$ } multiply_key = { lhs = Prod_S12Size which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S13DmndB$type$ } multiply_key = { lhs = Prod_S13Size which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S14DmndB$type$ } multiply_key = { lhs = Prod_S14Size which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S15DmndB$type$ } multiply_key = { lhs = Prod_S15Size which = Tmp_2 } }
        }
        else = {
            set_key = { lhs = Tmp_2 which = Building_$type$ }
            subtract_key = { lhs = Tmp_2 which = Tmp_1 }
            subtract_key = { lhs = Tmp_0 which = Tmp_1 }
            divide_key = { lhs = Tmp_2 which = Tmp_0 }

            if = { limit = { has_province_flag = Prod_S0DmndB$type$  NOT = { has_province_flag = exclude_0 } }  multiply_key = { lhs = Prod_S0Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S1DmndB$type$  NOT = { has_province_flag = exclude_1 } }  multiply_key = { lhs = Prod_S1Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S2DmndB$type$  NOT = { has_province_flag = exclude_2 } }  multiply_key = { lhs = Prod_S2Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S3DmndB$type$  NOT = { has_province_flag = exclude_3 } }  multiply_key = { lhs = Prod_S3Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S4DmndB$type$  NOT = { has_province_flag = exclude_4 } }  multiply_key = { lhs = Prod_S4Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S5DmndB$type$  NOT = { has_province_flag = exclude_5 } }  multiply_key = { lhs = Prod_S5Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S6DmndB$type$  NOT = { has_province_flag = exclude_6 } }  multiply_key = { lhs = Prod_S6Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S7DmndB$type$  NOT = { has_province_flag = exclude_7 } }  multiply_key = { lhs = Prod_S7Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S8DmndB$type$  NOT = { has_province_flag = exclude_8 } }  multiply_key = { lhs = Prod_S8Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S9DmndB$type$  NOT = { has_province_flag = exclude_9 } }  multiply_key = { lhs = Prod_S9Size  which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S10DmndB$type$ NOT = { has_province_flag = exclude_10 } } multiply_key = { lhs = Prod_S10Size which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S11DmndB$type$ NOT = { has_province_flag = exclude_11 } } multiply_key = { lhs = Prod_S11Size which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S12DmndB$type$ NOT = { has_province_flag = exclude_12 } } multiply_key = { lhs = Prod_S12Size which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S13DmndB$type$ NOT = { has_province_flag = exclude_13 } } multiply_key = { lhs = Prod_S13Size which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S14DmndB$type$ NOT = { has_province_flag = exclude_14 } } multiply_key = { lhs = Prod_S14Size which = Tmp_2 } }
            if = { limit = { has_province_flag = Prod_S15DmndB$type$ NOT = { has_province_flag = exclude_15 } } multiply_key = { lhs = Prod_S15Size which = Tmp_2 } }
        }
    }
}
Infra_DoSizeHelper1 = { # expansion or shrinkage
    if = {
        limit = {
            has_province_flag = Prod_S$slot$
            has_province_flag = Prod_S$slot$DmndB$type$
        }
        change_key = { lhs = Prod_S$slot$Size which = Prod_S$slot$Change }      
    }
}

# Calculate Property size change.
# (1)Building_$type$  	  = Current size of the property type
# (1)Building_$type$Decay = There is an annual fixed decay of 2% per year.. This reduces size.
# (2)Building_$type$Up    = represent how much industries expanded Property.
# (3)Building_$type$Down  = represent how much industries shrinked within the Property.
# New_Property_Size = (1)-(2)+(3)-(4)
Infra_DoSize = { 
	set_key = { lhs = Building_$type$Decay value = 0 }
    if = {
        limit = {
            check_key = { lhs = Building_$type$ value = 0.001 }
        }
                
        if = { # annual fixed decay of 2%
            limit = {
				NOT = { has_global_flag = POP_Sim1 }
                check_key = { lhs = Building_$type$ value = 0.001 }
            }
            set_key = { lhs = Building_$type$Decay which = Building_$type$ }
            multiply_key = { lhs = Building_$type$Decay value = 0.02 }
        }

        subtract_key = { lhs = Building_$type$ which = Building_$type$Decay }
        change_key = { lhs = Building_$type$ which = Building_$type$Up }
        subtract_key = { lhs = Building_$type$ which = Building_$type$Down }
            
       
        [[cap]
            if = {
                limit = {
                    check_key = { lhs = Building_$type$ which = $cap$ }
                }
                set_key = { lhs = Building_$type$ which = $cap$ }
            }
            Infra_UpdatePerc = { type = $type$ }
        ]

        
        Infra_DoSizeHelper1 = { slot = 0 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 1 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 2 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 3 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 4 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 5 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 6 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 7 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 8 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 9 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 10 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 11 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 12 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 13 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 14 type = $type$ }
        Infra_DoSizeHelper1 = { slot = 15 type = $type$ }
        
    }
	# Refresh industry sizes for the size change of the Property.
    Infra_RefreshIndustry = { type = $type$ [[excl] excl = $excl$ ] [[excl_cottage] excl_cottage = $excl_cottage$ ] [[excl_relig] excl_relig = $excl_relig$ ] }
}

Infra_UpdatePerc = {
	if = {
		limit = {
			check_key = { lhs = Building_$type$ value = 0.001 }
		}
		set_key = { lhs = Building_$type$Fill which = Building_$type$ }
		divide_key = { lhs = Building_$type$Fill which = Building_$type$Max }
	}
	else = {
		set_key = { lhs = Building_$type$Fill value = 0 }
	}
}

Infra_SumSpend = { # how much it spent on the products for maintenance
	set_key = { lhs = Building_$type$Spend value = 0 }
	
	set_key = { lhs = Tmp_0 which = Building_$type$1 }
    multiply_key = { lhs = Tmp_0 which = TN_SectorSpend1 }
    change_key = { lhs = Building_$type$Spend which = Tmp_0 }
	
    set_key = { lhs = Tmp_0 which = Building_$type$6 }
    multiply_key = { lhs = Tmp_0 which = TN_SectorSpend6 }
    change_key = { lhs = Building_$type$Spend which = Tmp_0 }
	
	set_key = { lhs = Tmp_0 which = Building_$type$24 }
    multiply_key = { lhs = Tmp_0 which = TN_SectorSpend24 }
    change_key = { lhs = Building_$type$Spend which = Tmp_0 }
}

Infra_DoSpendHelper = { # calc how much each estate has to spend on maintining. $rate$ differentitates how much money is the state putting into specific types of properties
	if = {
		limit = {
			check_key = { lhs = $class$_Total value = 0.001 }
			check_key = { lhs = $class$_Wealth value = 1.01 }
		}
		set_key = { lhs = Tmp_7 which = $class$_Prp$type$ }
		multiply_key = { lhs = Tmp_7 value = 0.01 }
		if = {
			limit = {
				NOT = { check_key = { lhs = Tmp_7 value = $share$ } }
			}
			set_key = { lhs = Tmp_7 value = $share$ }
		}
		
		multiply_key = { lhs = Tmp_7 which = Building_$type$Spend }
		
		# boosts the share of the class based on tribal power
		[[Tribal]
		if = {
			limit = {
				always = $Tribal$
			}
			set_key = { lhs = Tmp_8 which = Prov_TRPow }
			multiply_key = { lhs = Tmp_8 value = 0.005 }
			change_key = { lhs = Tmp_8 value = 1 }
			multiply_key = { lhs = Tmp_7 which = Tmp_8 }
			set_key = { lhs = Tmp_8 value = 0 }
		}
		]
		[[InvTribal]
		if = {
			limit = {
				always = $InvTribal$
			}
			set_key = { lhs = Tmp_8 value = 100 }
			subtract_key = { lhs = Tmp_8 which = Prov_TRPow }
			multiply_key = { lhs = Tmp_8 value = 0.005 }
			change_key = { lhs = Tmp_8 value = 0.5 }
			multiply_key = { lhs = Tmp_7 which = Tmp_8 }
			set_key = { lhs = Tmp_8 value = 0 }
		}
		]
		
		# makes the share dependent on nomadism
		[[Nomad]
		if = {
			limit = {
				always = $Nomad$
			}
			set_key = { lhs = Tmp_8 which = NM_Ratio }
			multiply_key = { lhs = Tmp_8 value = 0.009 }
			change_key = { lhs = Tmp_8 value = 0.1 }
			multiply_key = { lhs = Tmp_7 which = Tmp_8 }
			set_key = { lhs = Tmp_8 value = 0 }
		}
		]
		
		# makes the share dependent on inverse nomadism
		[[InvNomad]
		if = {
			limit = {
				always = $InvNomad$
			}
			set_key = { lhs = Tmp_8 value = 100 }
			subtract_key = { lhs = Tmp_8 which = NM_Ratio }
			multiply_key = { lhs = Tmp_8 value = 0.01 }
			multiply_key = { lhs = Tmp_7 which = Tmp_8 }
			set_key = { lhs = Tmp_8 value = 0 }
		}
		]
		set_key = { lhs = $return$ which = $class$_Wealth }
		multiply_key = { lhs = $return$ value = 0.25 }
		if = {
			limit = {
				check_key = { lhs = $return$ which = Tmp_7 }
			}
			set_key = { lhs = $return$ which = Tmp_7 }
		}
		
		change_key = { lhs = Tmp_0 which = $return$ }
	}
	else = {
		set_key = { lhs = $return$ value = 0 }
	}
}

# TMP_1 = SF
# TMP 2 = RE
# TMP 3 = NM
# TMP 4 = NO
# TMP 5 = BG
# TMP 6 = CL
Infra_ShareOfferAgriculture = {
	if = {
		limit = {
			owner = { Rights_NOGov1Has = yes }
		}
		Infra_DoSpendHelper = { type = Agriculture class = SF return = Tmp_1 share = 0.25 InvNomad=yes Tribal=yes }
		Infra_DoSpendHelper = { type = Agriculture class = NO return = Tmp_4 share = 0.5 }
	}
	else_if = {
		limit = {
			owner = { Rights_NOGov2Has = yes }
		}
		Infra_DoSpendHelper = { type = Agriculture class = SF return = Tmp_1 share = 0.3 InvNomad=yes Tribal=yes }
		Infra_DoSpendHelper = { type = Agriculture class = NO return = Tmp_4 share = 0.45 }
	}
	else_if = {
		limit = {
			owner = { Rights_NOGov3Has = yes }
		}
		Infra_DoSpendHelper = { type = Agriculture class = SF return = Tmp_1 share = 0.35 InvNomad=yes Tribal=yes }
		Infra_DoSpendHelper = { type = Agriculture class = NO return = Tmp_4 share = 0.4 }
	}
	else_if = {
		limit = {
			owner = { Rights_NOGov4Has = yes }
		}
		Infra_DoSpendHelper = { type = Agriculture class = SF return = Tmp_1 share = 0.4 InvNomad=yes Tribal=yes }
		Infra_DoSpendHelper = { type = Agriculture class = NO return = Tmp_4 share = 0.35 }
	}
	else_if = {
		limit = {
			owner = { Rights_NOGov5Has = yes }
		}
		Infra_DoSpendHelper = { type = Agriculture class = SF return = Tmp_1 share = 0.45 InvNomad=yes Tribal=yes }
		Infra_DoSpendHelper = { type = Agriculture class = NO return = Tmp_4 share = 0.3 }
	}
	else = {
		Infra_DoSpendHelper = { type = Agriculture class = SF return = Tmp_1 share = 0.55 InvNomad=yes Tribal=yes }
		Infra_DoSpendHelper = { type = Agriculture class = NO return = Tmp_4 share = 0.15 }
	}
	set_key = { lhs = Tmp_2 value = 0 }
	Infra_DoSpendHelper = { type = Agriculture class = NM return = Tmp_3 share = 0.70 Nomad=yes }
	Infra_DoSpendHelper = { type = Agriculture class = BG return = Tmp_5 share = 0.20 InvNomad=yes }
	if = {
		limit = {
			owner = { Rights_CLHie1Has = yes }
		}
		Infra_DoSpendHelper = { type = Agriculture class = CL return = Tmp_6 share = 0.2 InvNomad=yes }
	}
	else_if = {
		limit = {
			owner = { Rights_CLHie2Has = yes }
		}
		Infra_DoSpendHelper = { type = Agriculture class = CL return = Tmp_6 share = 0.15 InvNomad=yes }
	}
	else = {
		Infra_DoSpendHelper = { type = Agriculture class = CL return = Tmp_6 share = 0.1 InvNomad=yes }
	}
}
Infra_ShareOfferForestry = {
	Infra_DoSpendHelper = { type = Forestry class = SF return = Tmp_1 share = 0.45 Tribal=yes }
	set_key = { lhs = Tmp_2 value = 0 }
	set_key = { lhs = Tmp_3 value = 0 }
	Infra_DoSpendHelper = { type = Forestry class = NO return = Tmp_4 share = 0.35 }
	Infra_DoSpendHelper = { type = Forestry class = BG return = Tmp_5 share = 0.20 }
	if = {
		limit = {
			owner = { Rights_CLHie3Has = yes }
		}
		Infra_DoSpendHelper = { type = Forestry class = CL return = Tmp_6 share = 0.1 }
	}
	else_if = {
		limit = {
			owner = { Rights_CLHie2Has = yes }
		}
		Infra_DoSpendHelper = { type = Forestry class = CL return = Tmp_6 share = 0.15 }
	}
	else = {
		Infra_DoSpendHelper = { type = Forestry class = CL return = Tmp_6 share = 0.2 }
	}
}
Infra_ShareOfferFishery = {
	Infra_DoSpendHelper = { type = Fishery class = SF return = Tmp_1 share = 0.65 }
	set_key = { lhs = Tmp_2 value = 0 }
	set_key = { lhs = Tmp_3 value = 0 }
	Infra_DoSpendHelper = { type = Fishery class = NO return = Tmp_4 share = 0.25 }
	Infra_DoSpendHelper = { type = Fishery class = BG return = Tmp_5 share = 0.05 }
	Infra_DoSpendHelper = { type = Fishery class = CL return = Tmp_6 share = 0.1 }
}
Infra_ShareOfferExtraction = {
	Infra_DoSpendHelper = { type = Extraction class = SF return = Tmp_1 share = 0.45 Tribal=yes }
	set_key = { lhs = Tmp_2 value = 0 }
	set_key = { lhs = Tmp_3 value = 0 }
	Infra_DoSpendHelper = { type = Extraction class = NO return = Tmp_4 share = 0.35 }
	Infra_DoSpendHelper = { type = Extraction class = BG return = Tmp_5 share = 0.20 }
	if = {
		limit = {
			owner = { Rights_CLHie3Has = yes }
		}
		Infra_DoSpendHelper = { type = Extraction class = CL return = Tmp_6 share = 0.1 }
	}
	else_if = {
		limit = {
			owner = { Rights_CLHie2Has = yes }
		}
		Infra_DoSpendHelper = { type = Extraction class = CL return = Tmp_6 share = 0.15 }
	}
	else = {
		Infra_DoSpendHelper = { type = Extraction class = CL return = Tmp_6 share = 0.2 }
	}
}
Infra_ShareOfferIndustrial = {
	if = {
		limit = {
			has_province_flag = Industry_38Present
		}
		if = {
			limit = {
				check_key = { lhs = RE_Total value = 1 }
			}
			Infra_DoSpendHelper = { type = Industrial class = SF return = Tmp_1 share = 0.2 Tribal=yes }
		}
		else = {
			Infra_DoSpendHelper = { type = Industrial class = SF return = Tmp_1 share = 0.25 Tribal=yes }
		}
	}
	else = {
		set_key = { lhs = Tmp_1 value = 0 }
	}
	Infra_DoSpendHelper = { type = Industrial class = RE return = Tmp_2 share = 0.60 Tribal=yes }
	set_key = { lhs = Tmp_3 value = 0 }
	if = {
		limit = {
			owner = { Rights_NOGov1Has = yes }
		}
		Infra_DoSpendHelper = { type = Industrial class = NO return = Tmp_4 share = 0.275 }
	}
	else_if = {
		limit = {
			owner = { Rights_NOGov2Has = yes }
		}
		Infra_DoSpendHelper = { type = Industrial class = NO return = Tmp_4 share = 0.225 }
	}
	else_if = {
		limit = {
			owner = { Rights_NOGov3Has = yes }
		}
		Infra_DoSpendHelper = { type = Industrial class = NO return = Tmp_4 share = 0.2 }
	}
	else_if = {
		limit = {
			owner = { Rights_NOGov4Has = yes }
		}
		Infra_DoSpendHelper = { type = Industrial class = NO return = Tmp_4 share = 0.25 }
	}
	else_if = {
		limit = {
			owner = { Rights_NOGov5Has = yes }
		}
		Infra_DoSpendHelper = { type = Industrial class = NO return = Tmp_4 share = 0.2 }
	}
	else = {
		Infra_DoSpendHelper = { type = Industrial class = NO return = Tmp_4 share = 0.10 }
	}
	Infra_DoSpendHelper = { type = Industrial class = BG return = Tmp_5 share = 0.40 }
	if = {
		limit = {
			owner = { Rights_CLHie3Has = yes }
		}
		Infra_DoSpendHelper = { type = Industrial class = CL return = Tmp_6 share = 0.07 }
	}
	else_if = {
		limit = {
			owner = { Rights_CLHie2Has = yes }
		}
		Infra_DoSpendHelper = { type = Industrial class = CL return = Tmp_6 share = 0.1 }
	}
	else = {
		Infra_DoSpendHelper = { type = Industrial class = CL return = Tmp_6 share = 0.13 }
	}
}
Infra_ShareOfferCommercial = {
	set_key = { lhs = Tmp_1 value = 0 }
	Infra_DoSpendHelper = { type = Commercial class = RE return = Tmp_2 share = 0.06 Tribal=yes }
	set_key = { lhs = Tmp_3 value = 0 }
	if = {
		limit = {
			owner = { Rights_BGCom6HasGreater = yes }
		}
		Infra_DoSpendHelper = { type = Commercial class = NO return = Tmp_4 share = 0.02 }
	}
	else = {
		Infra_DoSpendHelper = { type = Commercial class = NO return = Tmp_4 share = 0.08 }
	}
	Infra_DoSpendHelper = { type = Commercial class = BG return = Tmp_5 share = 0.93 }
	set_key = { lhs = Tmp_6 value = 0 }
}
Infra_ShareOfferAcademic = {
	set_key = { lhs = Tmp_1 value = 0 }
	set_key = { lhs = Tmp_3 value = 0 }
	set_key = { lhs = Tmp_4 value = 0 }
	if = {
		limit = {
			has_province_flag = Industry_30Present
		}
		Infra_DoSpendHelper = { type = Academic class = RE return = Tmp_2 share = 0.5 }
		Infra_DoSpendHelper = { type = Academic class = BG return = Tmp_5 share = 0.2 }
		Infra_DoSpendHelper = { type = Academic class = CL return = Tmp_6 share = 0.4 }
	}
	else = {
		set_key = { lhs = Tmp_2 value = 0 }
		set_key = { lhs = Tmp_5 value = 0 }
		Infra_DoSpendHelper = { type = Academic class = CL return = Tmp_6 share = 1 }
	}
}
# Total expenditure of Property maintenance. What estates and state have to pay to maintain, including what they have to pay to maintain their share.
Infra_DoSpend = { 
	set_key = { lhs = SF_Spend$type$ value = 0 }
	set_key = { lhs = RE_Spend$type$ value = 0 }
	set_key = { lhs = NM_Spend$type$ value = 0 }
	set_key = { lhs = NO_Spend$type$ value = 0 }
	set_key = { lhs = BG_Spend$type$ value = 0 }
	set_key = { lhs = CL_Spend$type$ value = 0 }
	set_key = { lhs = BU_Spend$type$ value = 0 }
	

	### Handling of state investment
	if = {
		limit = { check_key = { lhs = Building_$type$Wealth_Invested value = 0.001 } } # Any state investment occured
	
		# give investment money to elites for property build by the state
		if = {
			limit = {
				check_key = { lhs = Building_$type$Spend which = Building_$type$Wealth_Invested } ## Spend >= Investment
			} 
		
			subtract_key = { lhs = Building_$type$Spend  which = Building_$type$Wealth_Invested } # Reduce Elite spending by Investment
			subtract_key = { lhs = Building_$type$Wealth which = Building_$type$Wealth_Invested } # reduce state investment by taken investments
		}	
		else = { # Spending < investment --> Can't give more then total spending, no wealth overflow or loss, rest remains in investment pool
			subtract_key = { lhs = Building_$type$Wealth which = Building_$type$Spend } 	# reduce state investment pool by investment spending
			set_key = { lhs = Building_$type$Wealth_Invested which = Building_$type$Spend } # amount actually invested rest remain in investment pool
			set_key = { lhs = Building_$type$Spend value = 0 } # No spending since all is paid for by the state
		}
		
		# give corruption money to elites
		if = {
			limit = { check_key = { lhs = Building_$type$Wealth_Invested_Crpt value = 0.001 } } # Any state investment corruption occured

			if = {
				limit = {
					check_key = { lhs = Building_$type$Spend which = Building_$type$Wealth_Invested_Crpt } ## Spend >= Corruption
				} 
			
				subtract_key = { lhs = Building_$type$Spend  which = Building_$type$Wealth_Invested_Crpt } # Reduce Elite spending by corruption
				subtract_key = { lhs = Building_$type$Wealth which = Building_$type$Wealth_Invested_Crpt } # reduce state investment by corruption
			}	
			else = { # Spending < corruption --> Can't give more then total spending, no wealth overflow or loss, rest remains in investment pool
				subtract_key = { lhs = Building_$type$Wealth which = Building_$type$Spend } # reduce state investment pool by corruption spending
				set_key = { lhs = Building_$type$Wealth_Invested_Crpt which = Building_$type$Spend } # amount actually corruption, rest remain in investment pool
				set_key = { lhs = Building_$type$Spend value = 0 } # No spending since all is paid for by the state
			}
		}
	}

	if = {
		limit = {
			check_key = { lhs = Building_$type$Spend value = 0.001 }
		}
		set_key = { lhs = Tmp_0 value = 0 }
		
		Infra_ShareOffer$type$ = yes
			
		if = { # calc % of wealth of each.
			limit = {
				check_key = { lhs = Tmp_0 value = 0.01 }
			}
			set_key = { lhs = Tmp_7 which = BU_Prp$type$ }
			multiply_key = { lhs = Tmp_7 value = 0.01 }
			
			if = {
				limit = {
					always = $Mine$
					OR = {
						has_province_flag = salt
						has_province_flag = Industry_9Present
						has_province_flag = Industry_10Present		
						has_province_flag = pm
					}
				}				
				set_key = { lhs = Tmp_8 value = 0.875 }
				multiply_key = { lhs = Tmp_8 which = Prov_BUPow }
				multiply_key = { lhs = Tmp_8 value = 0.01 }
				change_key = { lhs = Tmp_8 value = 0.125 }
				multiply_key = { lhs = Tmp_8 value = $BU$ }				
				if = {
					limit = {
						has_province_flag = pm
					}
					multiply_key = { lhs = Tmp_8 value = 10 }							
				}
				if = {
					limit = {
						NOT = { check_key = { lhs = Tmp_7 which = Tmp_8 } }
					}
					set_key = { lhs = Tmp_7 which = Tmp_8 }
				}
			}
			else_if = {
				limit = {
					NOT = { check_key = { lhs = Tmp_7 value = $BU$ } }
					[[Uni]always = $Uni$
					has_province_flag = Industry_30Present
					]
				}
				set_key = { lhs = Tmp_7 value = $BU$ } # unused
			}
			if = {
				limit = {
					has_global_flag = POP_Sim
					has_province_flag = pm
					always = $Mine$
				}
				multiply_key = { lhs = Tmp_1 value = 0.1 }
				multiply_key = { lhs = Tmp_2 value = 0.1 }
				multiply_key = { lhs = Tmp_3 value = 0.1 }
				multiply_key = { lhs = Tmp_4 value = 0.1 }
				multiply_key = { lhs = Tmp_5 value = 0.1 }
				multiply_key = { lhs = Tmp_6 value = 0.1 }
			}
			if = {
				limit = {
					NOT = { has_global_flag = POP_Sim10 }
				}
				if = {
					limit = {
						NOT = { check_key = { lhs = Tax_CostProp$type$Rate value = 1 } }
					}
					multiply_key = { lhs = Tmp_7 value = 0.015 }
				}
				else_if = {
					limit = {
						NOT = { check_key = { lhs = Tax_CostProp$type$Rate value = 75 } }
					}
					set_key = { lhs = Tmp_8 which = Tax_CostProp$type$Rate }
					multiply_key = { lhs = Tmp_8 value = 1.333 } ### 75% is 100%, and so on
					multiply_key = { lhs = Tmp_8 value = 0.01 }
					multiply_key = { lhs = Tmp_7 which = Tmp_8 }
				}
			}
			# Tribal power reduces BU power and therefore BU share.
			set_key = { lhs = Tmp_8 value = 100 }
			subtract_key = { lhs = Tmp_8 which = Prov_TRPow }
			multiply_key = { lhs = Tmp_8 value = 0.005 }
			change_key = { lhs = Tmp_8 value = 0.5 }
			
			multiply_key = { lhs = Tmp_7 which = Tmp_8 }
			
			# if = { # calc % of wealth of each.
			# 	limit = {
			# 		check_key = { lhs = Tmp_7 value = 0.01 }
			# 	}
			# 	set_key = { lhs = Tmp_8 value = 1 }
			# 	subtract_key = { lhs = Tmp_8 which = Tmp_7 }
			# 	set_key = { lhs = Tmp_7 which = Tmp_0 }
			# 	divide_key = { lhs = Tmp_7 which = Tmp_8 }
			# 	subtract_key = { lhs = Tmp_7 which = Tmp_0 }
			# }
			
			change_key = { lhs = Tmp_0 which = Tmp_7 }
			
			# calc % of wealth of each. Tmp_1 = SF, Tmp_2 = RE, Tmp_3 = NM, Tmp_4 = NO, Tmp_5 = BG, Tmp_6 = CL, Tmp_7 = BU
			if = {
				limit = {
					check_key = { lhs = Tmp_1 value = 0.01 }
				}
				divide_key = { lhs = Tmp_1 which = Tmp_0 }
			}
			if = {
				limit = {
					check_key = { lhs = Tmp_2 value = 0.01 }
				}
				divide_key = { lhs = Tmp_2 which = Tmp_0 }
			}
			if = {
				limit = {
					check_key = { lhs = Tmp_3 value = 0.01 }
				}
				divide_key = { lhs = Tmp_3 which = Tmp_0 }
			}
			if = {
				limit = {
					check_key = { lhs = Tmp_4 value = 0.01 }
				}
				divide_key = { lhs = Tmp_4 which = Tmp_0 }
			}
			if = {
				limit = {
					check_key = { lhs = Tmp_5 value = 0.01 }
				}
				divide_key = { lhs = Tmp_5 which = Tmp_0 }
			}
			if = {
				limit = {
					check_key = { lhs = Tmp_6 value = 0.01 }
				}
				divide_key = { lhs = Tmp_6 which = Tmp_0 }
			}
			if = {
				limit = {
					check_key = { lhs = Tmp_7 value = 0.01 }
				}
				divide_key = { lhs = Tmp_7 which = Tmp_0 }
			}
			
			set_key = { lhs = Tmp_8 value = 0 }
			
			multiply_key = { lhs = Tmp_1 which = Building_$type$Spend } # multiply building actual spending maintenance by each powerbroker % of wealth weight
			multiply_key = { lhs = Tmp_2 which = Building_$type$Spend }
			multiply_key = { lhs = Tmp_3 which = Building_$type$Spend }
			multiply_key = { lhs = Tmp_4 which = Building_$type$Spend }
			multiply_key = { lhs = Tmp_5 which = Building_$type$Spend } 
			multiply_key = { lhs = Tmp_6 which = Building_$type$Spend }
			multiply_key = { lhs = Tmp_7 which = Building_$type$Spend }
			
			change_key = { lhs = SF_SpendPrp which = Tmp_1 } # add that spending to each powerbroker
			change_key = { lhs = RE_SpendPrp which = Tmp_2 }
			change_key = { lhs = NM_SpendPrp which = Tmp_3 }
			change_key = { lhs = NO_SpendPrp which = Tmp_4 }
			change_key = { lhs = BG_SpendPrp which = Tmp_5 }
			change_key = { lhs = CL_SpendPrp which = Tmp_6 }
			change_key = { lhs = BU_SpendPrp which = Tmp_7 }
			
			change_key = { lhs = SF_Spend$type$ which = Tmp_1 } # the spending also adds to increase their size of ownership of building
			change_key = { lhs = RE_Spend$type$ which = Tmp_2 }
			change_key = { lhs = NM_Spend$type$ which = Tmp_3 }
			change_key = { lhs = NO_Spend$type$ which = Tmp_4 }
			change_key = { lhs = BG_Spend$type$ which = Tmp_5 }
			change_key = { lhs = CL_Spend$type$ which = Tmp_6 }
			change_key = { lhs = BU_Spend$type$ which = Tmp_7 }
			
			multiply_key = { lhs = Tmp_1 value = 0.1 } 
			multiply_key = { lhs = Tmp_2 value = 0.1 }
			multiply_key = { lhs = Tmp_3 value = 0.1 }
			multiply_key = { lhs = Tmp_4 value = 0.1 }
			multiply_key = { lhs = Tmp_5 value = 0.1 }
			multiply_key = { lhs = Tmp_6 value = 0.1 }
			multiply_key = { lhs = Tmp_7 value = 0.1 }
			
			change_key = { lhs = Building_$type$ShareSF which = Tmp_1 } # % share
			change_key = { lhs = Building_$type$ShareRE which = Tmp_2 }
			change_key = { lhs = Building_$type$ShareNM which = Tmp_3 }
			change_key = { lhs = Building_$type$ShareNO which = Tmp_4 }
			change_key = { lhs = Building_$type$ShareBG which = Tmp_5 }
			change_key = { lhs = Building_$type$ShareCL which = Tmp_6 }
			change_key = { lhs = Building_$type$ShareBU which = Tmp_7 }
		}
	}
	if = {
		limit = {
			check_key = { lhs = Building_$type$Loss value = 0.001 }
		}
		set_key = { lhs = Tmp_1 which = SF_Prp$type$ }
		set_key = { lhs = Tmp_2 which = RE_Prp$type$ }
		set_key = { lhs = Tmp_3 which = NM_Prp$type$ }
		set_key = { lhs = Tmp_4 which = NO_Prp$type$ }
		set_key = { lhs = Tmp_5 which = BG_Prp$type$ }
		set_key = { lhs = Tmp_6 which = CL_Prp$type$ }
		set_key = { lhs = Tmp_7 which = BU_Prp$type$ }
		
		multiply_key = { lhs = Tmp_1 value = 0.01 }
		multiply_key = { lhs = Tmp_2 value = 0.01 }
		multiply_key = { lhs = Tmp_3 value = 0.01 }
		multiply_key = { lhs = Tmp_4 value = 0.01 }
		multiply_key = { lhs = Tmp_5 value = 0.01 }
		multiply_key = { lhs = Tmp_6 value = 0.01 }
		multiply_key = { lhs = Tmp_7 value = 0.01 }
		
		multiply_key = { lhs = Tmp_1 which = Building_$type$Loss }
		multiply_key = { lhs = Tmp_2 which = Building_$type$Loss }
		multiply_key = { lhs = Tmp_3 which = Building_$type$Loss }
		multiply_key = { lhs = Tmp_4 which = Building_$type$Loss }
		multiply_key = { lhs = Tmp_5 which = Building_$type$Loss }
		multiply_key = { lhs = Tmp_6 which = Building_$type$Loss }
		multiply_key = { lhs = Tmp_7 which = Building_$type$Loss }
		
		change_key = { lhs = SF_SpendPrp which = Tmp_1 } # add that spending to each powerbroker
		change_key = { lhs = RE_SpendPrp which = Tmp_2 }
		change_key = { lhs = NM_SpendPrp which = Tmp_3 }
		change_key = { lhs = NO_SpendPrp which = Tmp_4 }
		change_key = { lhs = BG_SpendPrp which = Tmp_5 }
		change_key = { lhs = CL_SpendPrp which = Tmp_6 }
		change_key = { lhs = BU_SpendPrp which = Tmp_7 }
		
		change_key = { lhs = SF_Spend$type$ which = Tmp_1 }
		change_key = { lhs = RE_Spend$type$ which = Tmp_2 }
		change_key = { lhs = NM_Spend$type$ which = Tmp_3 }
		change_key = { lhs = NO_Spend$type$ which = Tmp_4 }
		change_key = { lhs = BG_Spend$type$ which = Tmp_5 }
		change_key = { lhs = CL_Spend$type$ which = Tmp_6 }
		change_key = { lhs = BU_Spend$type$ which = Tmp_7 }
		
		change_key = { lhs = Building_$type$Spend which = Building_$type$Loss }
	}
}

Infra_DoDecay = { # add decay
	if = {
		limit = {
			check_key = { lhs = Building_$type$ value = 0.001 }
		}
		multiply_key = { lhs = Building_$type$ShareSF value = 0.98 }
		multiply_key = { lhs = Building_$type$ShareNM value = 0.98 }
		multiply_key = { lhs = Building_$type$ShareRE value = 0.98 }
		multiply_key = { lhs = Building_$type$ShareNO value = 0.98 }
		multiply_key = { lhs = Building_$type$ShareBG value = 0.98 }
		multiply_key = { lhs = Building_$type$ShareCL value = 0.98 }
		multiply_key = { lhs = Building_$type$ShareBU value = 0.98 }
	}
}

Infra_CheckClass = { # remove dead classes
	if = {
		limit = {
			NOT = { check_key = { lhs = $class$_Total value = 0.001 } }
		}
		set_key = { lhs = Building_AgricultureShare$class$ value = 0 }
		set_key = { lhs = Building_ExtractionShare$class$ value = 0 }
		set_key = { lhs = Building_FisheryShare$class$ value = 0 }
		set_key = { lhs = Building_ForestryShare$class$ value = 0 }
		set_key = { lhs = Building_IndustrialShare$class$ value = 0 }
		set_key = { lhs = Building_AcademicShare$class$ value = 0 }
		set_key = { lhs = Building_CommercialShare$class$ value = 0 }
	}
}
Infra_CheckBU = {
	if = {
		limit = {
			isValidProv = no
		}
		set_key = { lhs = Building_AgricultureShareBU value = 0 }
		set_key = { lhs = Building_ExtractionShareBU value = 0 }
		set_key = { lhs = Building_FisheryShareBU value = 0 }
		set_key = { lhs = Building_ForestryShareBU value = 0 }
		set_key = { lhs = Building_IndustrialShareBU value = 0 }
		set_key = { lhs = Building_AcademicShareBU value = 0 }
		set_key = { lhs = Building_CommercialShareBU value = 0 }
	}
}
Infra_InitPrp = {
	set_key = { lhs = Building_$Building$ShareSF value = $SF$ }
	if = {
		limit = {
			check_key = { lhs = NM_Total value = 0.1 }
		}
		set_key = { lhs = Building_$Building$ShareNM value = $NM$ }
	}
	else = {
		change_key = { lhs = Building_$Building$ShareSF value = $NM$ }
	}
	set_key = { lhs = Building_$Building$ShareRE value = $RE$ }
	set_key = { lhs = Building_$Building$ShareNO value = $NO$ }
	set_key = { lhs = Building_$Building$ShareBG value = $BG$ }
	set_key = { lhs = Building_$Building$ShareCL value = $CL$ }
	set_key = { lhs = Building_$Building$ShareBU value = $BU$ }
}

# If no slot of type then set building amount of type to zero
Infra_ClearEmptyPropertyType = {
	if = {
		limit = {
			AND = {
				check_key = { lhs = Building_$type$ value = 0.001 }
				NOT = {
					HasSlot$type$ = yes
				}
			}
		}
		set_key = { lhs = Building_$type$ value = 0 }
	}
}

Infra_DoShare = { # calculate share of each player in %
	set_key = { lhs = Tmp_0 which = Building_$type$ShareSF }
	change_key = { lhs = Tmp_0 which = Building_$type$ShareRE }
	change_key = { lhs = Tmp_0 which = Building_$type$ShareNM }
	change_key = { lhs = Tmp_0 which = Building_$type$ShareNO }
	change_key = { lhs = Tmp_0 which = Building_$type$ShareBG }
	change_key = { lhs = Tmp_0 which = Building_$type$ShareCL }
	change_key = { lhs = Tmp_0 which = Building_$type$ShareBU }
	
	if = {
		limit = {
			check_key = { lhs = Tmp_0 value = 0.001 }
		}
		set_key = { lhs = SF_$type$ which = Building_$type$ShareSF }
		set_key = { lhs = RE_$type$ which = Building_$type$ShareRE }
		set_key = { lhs = NM_$type$ which = Building_$type$ShareNM }
		set_key = { lhs = NO_$type$ which = Building_$type$ShareNO }
		set_key = { lhs = BG_$type$ which = Building_$type$ShareBG }
		set_key = { lhs = CL_$type$ which = Building_$type$ShareCL }
		set_key = { lhs = BU_$type$ which = Building_$type$ShareBU }
		
		multiply_key = { lhs = SF_$type$ value = 0.1 } #divide_key = { lhs = SF_$type$ value = 10 }
		multiply_key = { lhs = RE_$type$ value = 0.1 } #divide_key = { lhs = RE_$type$ value = 10 }
		multiply_key = { lhs = NM_$type$ value = 0.1 } #divide_key = { lhs = NM_$type$ value = 10 }
		multiply_key = { lhs = NO_$type$ value = 0.1 } #divide_key = { lhs = NO_$type$ value = 10 }
		multiply_key = { lhs = BG_$type$ value = 0.1 } #divide_key = { lhs = BG_$type$ value = 10 }
		multiply_key = { lhs = CL_$type$ value = 0.1 } #divide_key = { lhs = CL_$type$ value = 10 }
		multiply_key = { lhs = BU_$type$ value = 0.1 } #divide_key = { lhs = BU_$type$ value = 10 }		
		
		multiply_key = { lhs = SF_$type$ which = Building_$type$ }
		multiply_key = { lhs = RE_$type$ which = Building_$type$ }
		multiply_key = { lhs = NM_$type$ which = Building_$type$ }
		multiply_key = { lhs = NO_$type$ which = Building_$type$ }
		multiply_key = { lhs = BG_$type$ which = Building_$type$ }
		multiply_key = { lhs = CL_$type$ which = Building_$type$ }
		multiply_key = { lhs = BU_$type$ which = Building_$type$ }
		
		divide_key = { lhs = SF_$type$ which = Tmp_0 }
		divide_key = { lhs = RE_$type$ which = Tmp_0 }
		divide_key = { lhs = NM_$type$ which = Tmp_0 }
		divide_key = { lhs = NO_$type$ which = Tmp_0 }
		divide_key = { lhs = BG_$type$ which = Tmp_0 }
		divide_key = { lhs = CL_$type$ which = Tmp_0 }
		divide_key = { lhs = BU_$type$ which = Tmp_0 }
		
		multiply_key = { lhs = SF_$type$ value = 10 }
		multiply_key = { lhs = RE_$type$ value = 10 }
		multiply_key = { lhs = NM_$type$ value = 10 }
		multiply_key = { lhs = NO_$type$ value = 10 }
		multiply_key = { lhs = BG_$type$ value = 10 }
		multiply_key = { lhs = CL_$type$ value = 10 }
		multiply_key = { lhs = BU_$type$ value = 10 }
	}
}

Infra_SetFillInfra = {
    set_key = { lhs = Tmp_0 value = 0 }

    set_key = { lhs = Tmp_1 which = Infra_22 }
    multiply_key = { lhs = Tmp_1 which = TN_ProvPrc22 }
    change_key = { lhs = Tmp_0 which = Tmp_1 }

    set_key = { lhs = Tmp_1 which = Infra_23 }
    multiply_key = { lhs = Tmp_1 which = TN_ProvPrc23 }
    change_key = { lhs = Tmp_0 which = Tmp_1 }

    set_key = { lhs = Tmp_1 which = Infra_24 }
    multiply_key = { lhs = Tmp_1 which = TN_ProvPrc24 }
    change_key = { lhs = Tmp_0 which = Tmp_1 }

    set_key = { lhs = Tmp_1 which = Infra_41 }
    multiply_key = { lhs = Tmp_1 which = TN_ProvPrc41 }
    change_key = { lhs = Tmp_0 which = Tmp_1 }

    set_key = { lhs = Tmp_1 which = Infra_R }
    multiply_key = { lhs = Tmp_1 which = Class_PR }
    change_key = { lhs = Tmp_0 which = Tmp_1 }

    set_key = { lhs = Tmp_1 which = Infra_UL }
    multiply_key = { lhs = Tmp_1 which = Class_PUL }
    change_key = { lhs = Tmp_0 which = Tmp_1 }

    set_key = { lhs = Tmp_1 which = Infra_Wealth }
    multiply_key = { lhs = Tmp_1 value = 0.2 }

    if = {
        limit = {
            check_key = { lhs = Tmp_1 which = Tmp_0 }
        }
        set_key = { lhs = Infra_Fill value = 100 }
    }
    else = {
        set_key = { lhs = Infra_Fill which = Tmp_1 }
        multiply_key = { lhs = Infra_Fill value = 100 }
        divide_key = { lhs = Infra_Fill which = Tmp_0 }

        multiply_key = { lhs = Infra_22 which = Infra_Fill }
        multiply_key = { lhs = Infra_23 which = Infra_Fill }
        multiply_key = { lhs = Infra_24 which = Infra_Fill }
        multiply_key = { lhs = Infra_41 which = Infra_Fill }
        multiply_key = { lhs = Infra_R which = Infra_Fill }
        multiply_key = { lhs = Infra_UL which = Infra_Fill }

		multiply_key = { lhs = Infra_22 value = 0.01 }
		multiply_key = { lhs = Infra_23 value = 0.01 }
		multiply_key = { lhs = Infra_24 value = 0.01 }
		multiply_key = { lhs = Infra_41 value = 0.01 }
		multiply_key = { lhs = Infra_R value = 0.01 }
		multiply_key = { lhs = Infra_UL value = 0.01 }
    }

    set_key = { lhs = Tmp_0 value = 0 }
    set_key = { lhs = Tmp_1 value = 0 }
}

Infra_SetCostPerUnit = {
    set_key = { lhs = Infra_$type$SizeCost1 value = 0 }

    Infra_GetCostBuild$type$ = yes

    [[prod1] 
        multiply_key = { lhs = Infra_Cost$prod1$ which = TN_ProvPrc$prod1$ }
        change_key = { lhs = Infra_$type$SizeCost1 which = Infra_Cost$prod1$ }
    ]
    [[prod2] 
        multiply_key = { lhs = Infra_Cost$prod2$ which = TN_ProvPrc$prod2$ }
        change_key = { lhs = Infra_$type$SizeCost1 which = Infra_Cost$prod2$ }
    ]
    [[prod3] 
        multiply_key = { lhs = Infra_Cost$prod3$ which = TN_ProvPrc$prod3$ }
        change_key = { lhs = Infra_$type$SizeCost1 which = Infra_Cost$prod3$ }
    ]

    [[labor] 
        multiply_key = { lhs = Infra_Cost$labor$ which = Class_P$labor$ }
        change_key = { lhs = Infra_$type$SizeCost1 which = Infra_Cost$labor$ }
    ]

    set_key = { lhs = Infra_$type$SizeCost10 which = Infra_$type$SizeCost1 }
    multiply_key = { lhs = Infra_$type$SizeCost10 value = 10 }
	
	set_key = { lhs = Infra_$type$GoalCost which = Infra_$type$Goal }
	subtract_key = { lhs = Infra_$type$GoalCost which = Infra_$type$Size }	
	multiply_key = { lhs = Infra_$type$GoalCost which = Infra_$type$SizeCost1 }

    [[prod1] set_key = { lhs = Infra_Cost$prod1$ value = 0 }]
    [[prod2] set_key = { lhs = Infra_Cost$prod2$ value = 0 }]
    [[prod3] set_key = { lhs = Infra_Cost$prod3$ value = 0 }]
    [[labor] set_key = { lhs = Infra_Cost$labor$ value = 0 }]
}
#Buildings maintenance
Infra_SetSpendInfra = {
    set_key = { lhs = Infra_$type$Spend value = 0 }
    set_key = { lhs = Infra_State$type$Spend value = 0 }

    if = {
        limit = {
            check_key = { lhs = Infra_$type$Size value = 1 }
        }
        Infra_GetCostMaint$type$ = yes

        [[prod1] 
            multiply_key = { lhs = Infra_Cost$prod1$ which = Infra_$type$Size }
            multiply_key = { lhs = Infra_Cost$prod1$ which = TN_SectorSpend$prod1$ }
            change_key = { lhs = Infra_$type$Spend which = Infra_Cost$prod1$ }
        ]
        [[prod2] 
            multiply_key = { lhs = Infra_Cost$prod2$ which = Infra_$type$Size }
            multiply_key = { lhs = Infra_Cost$prod2$ which = TN_SectorSpend$prod2$ }
            change_key = { lhs = Infra_$type$Spend which = Infra_Cost$prod2$ }
        ]
        [[prod3] 
            multiply_key = { lhs = Infra_Cost$prod3$ which = Infra_$type$Size }
            multiply_key = { lhs = Infra_Cost$prod3$ which = TN_SectorSpend$prod3$ }
            change_key = { lhs = Infra_$type$Spend which = Infra_Cost$prod3$ }
        ]

        [[labor] 
            multiply_key = { lhs = Infra_Cost$labor$ which = Infra_$type$Size }
            multiply_key = { lhs = Infra_Cost$labor$ which = Class_P$labor$ }
            multiply_key = { lhs = Infra_Cost$labor$ which = Prod_Fill$labor$ }
			multiply_key = { lhs = Infra_Cost$labor$ value = 0.01 }
            change_key = { lhs = Infra_$type$Spend which = Infra_Cost$labor$ }
        ]

		if = {
			limit = {
				OR = {
					has_province_flag = Infra_$type$100
					#[[StateFunded] always = $StateFunded$ ]
					
					# BrutusY: Here should be StateBased rather than the old StateFunded
					# However, since only Capitol is StateBased
					# This code condition alone would make AI maintain unnecessary Capitol Buildings
					AND = {
						always = $StateBased$
						is_capital = yes
						# This condition ensures that only the capital's Capitol building will be maintained
						# Hopefully, AI would not maintain a bunch of idle Capitols
						# After conquering a bunch of small neighbours
					}

				}
			}
			change_key = { lhs = Infra_StateSpend which = Infra_$type$Spend }
			change_key = { lhs = Infra_State$type$Spend which = Infra_$type$Spend }
		}
		else_if = {
			limit = {
				has_province_flag = Infra_$type$75
			}
			set_key = { lhs = Tmp_0 which = Infra_$type$Spend }
			multiply_key = { lhs = Tmp_0 value = 0.75 }
			change_key = { lhs = Infra_StateSpend which = Tmp_0 }
			change_key = { lhs = Infra_State$type$Spend which = Tmp_0 }

			multiply_key = { lhs = Infra_$type$Spend value = 0.25 }
			multiply_key = { lhs = Infra_$type$Spend which = Infra_Fill }
			multiply_key = { lhs = Infra_$type$Spend value = 0.01 }
			change_key = { lhs = Infra_$type$Spend which = Tmp_0 }
		}
		else_if = {
			limit = {
				has_province_flag = Infra_$type$50
			}
			multiply_key = { lhs = Infra_$type$Spend value = 0.5 } #divide_key = { lhs = Infra_$type$Spend value = 2 }			
			set_key = { lhs = Tmp_0 which = Infra_$type$Spend }
			change_key = { lhs = Infra_StateSpend which = Infra_$type$Spend }
			change_key = { lhs = Infra_State$type$Spend which = Infra_$type$Spend }

			multiply_key = { lhs = Infra_$type$Spend which = Infra_Fill }
			multiply_key = { lhs = Infra_$type$Spend value = 0.01 }
			change_key = { lhs = Infra_$type$Spend which = Tmp_0 }
		}
		else_if = {
			limit = {
				OR = {
					has_province_flag = Infra_$type$25
					AND = {
						always = $StateBased$
						NOT = { has_global_flag = POP_Sim }
						owner = { ai = yes }
					}
				}
			}
			multiply_key = { lhs = Infra_$type$Spend value = 0.25 } #divide_key = { lhs = Infra_$type$Spend value = 4 }			
			set_key = { lhs = Tmp_0 which = Infra_$type$Spend }
			change_key = { lhs = Infra_StateSpend which = Infra_$type$Spend }
			change_key = { lhs = Infra_State$type$Spend which = Infra_$type$Spend }

			multiply_key = { lhs = Infra_$type$Spend value = 3 }
			multiply_key = { lhs = Infra_$type$Spend which = Infra_Fill }
			multiply_key = { lhs = Infra_$type$Spend value = 0.01 }
			change_key = { lhs = Infra_$type$Spend which = Tmp_0 }
		}
		else = {
			multiply_key = { lhs = Infra_$type$Spend which = Infra_Fill }
			multiply_key = { lhs = Infra_$type$Spend value = 0.01 }
		}

        [[prod1] set_key = { lhs = Infra_Cost$prod1$ value = 0 }]
        [[prod2] set_key = { lhs = Infra_Cost$prod2$ value = 0 }]
        [[prod3] set_key = { lhs = Infra_Cost$prod3$ value = 0 }]
        [[labor] set_key = { lhs = Infra_Cost$labor$ value = 0 }]
    }
}

Infra_CheckInfra = {
    if = {
        limit = {
            check_key = { lhs = Infra_$type$Size value = 1 }
        }
        multiply_key = { lhs = Infra_$type$Decay value = 0.95 }

		if = {
			limit = {
				OR = {
					has_province_flag = Infra_$type$100
					[[StateFunded] always = $StateFunded$ ]
				}
			}
			set_key = { lhs = Tmp_1 value = 100 }
		}
		else_if = {
			limit = {
				has_province_flag = Infra_$type$50
			}
			set_key = { lhs = Tmp_1 value = 100 }
			change_key = { lhs = Tmp_1 which = Infra_Fill }
			multiply_key = { lhs = Tmp_1 value = 0.5 } #divide_key = { lhs = Tmp_1 value = 2 }			
		}
		else_if = {
			limit = {
				OR = {
					has_province_flag = Infra_$type$25
					AND = {
					   always = $StateBased$
					   NOT = { has_global_flag = POP_Sim }
					   owner = { ai = yes }
					}
				}
			}
			set_key = { lhs = Tmp_1 which = Infra_Fill }
			multiply_key = { lhs = Tmp_1 value = 0.75 }
			change_key = { lhs = Tmp_1 value = 25 }
		}
		else = {
			set_key = { lhs = Tmp_1 which = Infra_Fill }
		}

        set_key = { lhs = Tmp_0 value = 0 }

        [[prod1] change_key = { lhs = Tmp_0 which = TN_ProvFill$prod1$ }]
        [[prod2] change_key = { lhs = Tmp_0 which = TN_ProvFill$prod2$ }]
        [[prod3] change_key = { lhs = Tmp_0 which = TN_ProvFill$prod3$ }]
        [[labor] change_key = { lhs = Tmp_0 which = Prod_Fill$labor$ }]

        multiply_key = { lhs = Tmp_0 which = Tmp_1 }
        if = {
            limit = {
                check_key = { lhs = Tmp_0 value = 0.001 }
            }
        	divide_key = { lhs = Tmp_0 value = -$num$00000 }
		}
        change_key = { lhs = Tmp_0 value = 0.1 }

        change_key = { lhs = Infra_$type$Decay which = Tmp_0 }

        if = {
            limit = {
                check_key = { lhs = Infra_$type$Decay value = 1 }
            }
			random = {
				chance = 50
				set_key = { lhs = Infra_$type$Decay value = 0 }
				subtract_key = { lhs = Infra_$type$Size value = 1 }
	
				Infra_SetRankInfra = { type = $type$ }
			}
        }

        set_key = { lhs = Tmp_0 value = 0 }
        set_key = { lhs = Tmp_1 value = 0 }
    }
    else = {
        set_key = { lhs = Infra_$type$Decay value = 0 }
    }
}

Infra_SetMaintInfra = {
    if = {
        limit = {
            check_key = { lhs = Infra_$type$Size value = 1 }
        }
        Infra_GetCostMaint$type$ = yes

        [[prod1] multiply_key = { lhs = Infra_Cost$prod1$ which = Infra_$type$Size }]
        [[prod2] multiply_key = { lhs = Infra_Cost$prod2$ which = Infra_$type$Size }]
        [[prod3] multiply_key = { lhs = Infra_Cost$prod3$ which = Infra_$type$Size }]
        [[labor] multiply_key = { lhs = Infra_Cost$labor$ which = Infra_$type$Size }]

        if = {
            limit = {
				OR = {
					has_province_flag = Infra_$type$100
					[[StateFunded] always = $StateFunded$ ]
				}
            }
            [[prod1] change_key = { lhs = Infra_State$prod1$ which = Infra_Cost$prod1$ }]
            [[prod2] change_key = { lhs = Infra_State$prod2$ which = Infra_Cost$prod2$ }]
            [[prod3] change_key = { lhs = Infra_State$prod3$ which = Infra_Cost$prod3$ }]
            [[labor] change_key = { lhs = Infra_State$labor$ which = Infra_Cost$labor$ }]
        }
        else_if = {
            limit = {
                has_province_flag = Infra_$type$50
            }
            [[prod1]
				multiply_key = { lhs = Infra_Cost$prod1$ value = 0.5 } #divide_key = { lhs = Infra_Cost$prod1$ value = 2 }                
                change_key = { lhs = Infra_State$prod1$ which = Infra_Cost$prod1$ }
                change_key = { lhs = Infra_$prod1$ which = Infra_Cost$prod1$ }
            ]
            [[prod2] 
				multiply_key = { lhs = Infra_Cost$prod2$ value = 0.5 } #divide_key = { lhs = Infra_Cost$prod2$ value = 2 }                
                change_key = { lhs = Infra_State$prod2$ which = Infra_Cost$prod2$ }
                change_key = { lhs = Infra_$prod2$ which = Infra_Cost$prod2$ }
            ]
            [[prod3] 
				multiply_key = { lhs = Infra_Cost$prod3$ value = 0.5 } #divide_key = { lhs = Infra_Cost$prod3$ value = 2 }                
                change_key = { lhs = Infra_State$prod3$ which = Infra_Cost$prod3$ }
                change_key = { lhs = Infra_$prod3$ which = Infra_Cost$prod3$ }
            ]
            [[labor] 
				multiply_key = { lhs = Infra_Cost$labor$ value = 0.5 } #divide_key = { lhs = Infra_Cost$labor$ value = 2 }
                change_key = { lhs = Infra_State$labor$ which = Infra_Cost$labor$ }
                change_key = { lhs = Infra_$labor$ which = Infra_Cost$labor$ }
            ]
        }
        else_if = {
            limit = {
				OR = {
					has_province_flag = Infra_$type$25
					[[StateBased]
					AND = {
					   always = $StateBased$
					   NOT = { has_global_flag = POP_Sim }
					   owner = { ai = yes }
					}
					]
				}
            }
            [[prod1] 
				multiply_key = { lhs = Infra_Cost$prod1$ value = 0.25 } #divide_key = { lhs = Infra_Cost$prod1$ value = 2 } 
                change_key = { lhs = Infra_State$prod1$ which = Infra_Cost$prod1$ }
                multiply_key = { lhs = Infra_Cost$prod1$ value = 3 }
                change_key = { lhs = Infra_$prod1$ which = Infra_Cost$prod1$ }
            ]
            [[prod2] 
				multiply_key = { lhs = Infra_Cost$prod2$ value = 0.25 } #divide_key = { lhs = Infra_Cost$prod2$ value = 4 }                
                change_key = { lhs = Infra_State$prod2$ which = Infra_Cost$prod2$ }
                multiply_key = { lhs = Infra_Cost$prod2$ value = 3 }
                change_key = { lhs = Infra_$prod2$ which = Infra_Cost$prod2$ }
            ]
            [[prod3] 
				multiply_key = { lhs = Infra_Cost$prod3$ value = 0.25 } #divide_key = { lhs = Infra_Cost$prod3$ value = 4 }                
                change_key = { lhs = Infra_State$prod3$ which = Infra_Cost$prod3$ }
                multiply_key = { lhs = Infra_Cost$prod3$ value = 3 }
                change_key = { lhs = Infra_$prod3$ which = Infra_Cost$prod3$ }
            ]
            [[labor] 
				multiply_key = { lhs = Infra_Cost$labor$ value = 0.25 } #divide_key = { lhs = Infra_Cost$labor$ value = 4 }                
                change_key = { lhs = Infra_State$labor$ which = Infra_Cost$labor$ }
                multiply_key = { lhs = Infra_Cost$labor$ value = 3 }
                change_key = { lhs = Infra_$labor$ which = Infra_Cost$labor$ }
            ]
        }
        else = {
            [[prod1] change_key = { lhs = Infra_$prod1$ which = Infra_Cost$prod1$ }]
            [[prod2] change_key = { lhs = Infra_$prod2$ which = Infra_Cost$prod2$ }]
            [[prod3] change_key = { lhs = Infra_$prod3$ which = Infra_Cost$prod3$ }]
            [[labor] change_key = { lhs = Infra_$labor$ which = Infra_Cost$labor$ }]
        }

        [[prod1] set_key = { lhs = Infra_Cost$prod1$ value = 0 }]
        [[prod2] set_key = { lhs = Infra_Cost$prod2$ value = 0 }]
        [[prod3] set_key = { lhs = Infra_Cost$prod3$ value = 0 }]
        [[labor] set_key = { lhs = Infra_Cost$labor$ value = 0 }]
    }
}

Infra_DoIncomeInfra = {
    if = {
        limit = {
            check_key = { lhs = $class$_Wealth value = 10 }
            [[power] always = $power$ check_key = { lhs = Prov_$class$Pow value = 0.001 } ]
            check_key = { lhs = $class$_Total value = 0.001 }
        }
		set_key = { lhs = Tmp_0 value = 25 }
        
		[[power] change_key = { lhs = Tmp_0 which = Prov_$class$Pow } ]
		
		[[freedom]
			if = {
				limit = {
					always = $freedom$
				}
				change_key = { lhs = Tmp_0 value = -25 }
				change_key = { lhs = Tmp_0 which = $class$_Freedom } 
			}
		]
		
		[[charter_RE] # wealth multiplier for residents based on city charter		
			if = {
				limit = {
					always = $charter_RE$
				}
				if = {
					limit = { owner = { Rights_BGGov1Has = yes } }
					change_key = { lhs = Tmp_0 value = 15 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov2Has = yes } }
					change_key = { lhs = Tmp_0 value = 12.5 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov3Has = yes } }
					change_key = { lhs = Tmp_0 value = 10 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov4Has = yes } }
					change_key = { lhs = Tmp_0 value = -5 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov5Has = yes } }
					change_key = { lhs = Tmp_0 value = -10 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov6Has = yes } }
					change_key = { lhs = Tmp_0 value = -15 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov7Has = yes } }
					change_key = { lhs = Tmp_0 value = -25 }
				}
			}
		]
		[[charter_BG] # wealth multiplier for burghers based on city charter
			if = {
				limit = {
					always = $charter_BG$
				}
				if = {
					limit = { owner = { Rights_BGGov1Has = yes } }
					change_key = { lhs = Tmp_0 value = -10 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov2Has = yes } }
					change_key = { lhs = Tmp_0 value = -7.5 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov3Has = yes } }
					change_key = { lhs = Tmp_0 value = -5.0 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov4Has = yes } }
					change_key = { lhs = Tmp_0 value = -2.5 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov5Has = yes } }
					change_key = { lhs = Tmp_0 value = 5 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov6Has = yes } }
					change_key = { lhs = Tmp_0 value = 7.5 }
				}
				else_if = {
					limit = { owner = { Rights_BGGov7Has = yes } }
					change_key = { lhs = Tmp_0 value = 10 }
				}
		}
		]

		[[antinomad]
			if = {
				limit = {
					always = $antinomad$
					check_key = { lhs = NM_Ratio value = 50 }
				} ### 50-100 effect, 0-50 does nothing, 100 is 0, 50 is full effect
				set_key = { lhs = Tmp_1 which = NM_Ratio }
				subtract_key = { lhs = Tmp_1 value = 50 }
				multiply_key = { lhs = Tmp_1 value = -0.02 }
				change_key = { lhs = Tmp_1 value = 1 }
				multiply_key = { lhs = Tmp_0 which = Tmp_1 } 
			}
		]

		multiply_key = { lhs = Tmp_0 which = $class$_Wealth }
		
		if = {
			limit = {
				check_key = { lhs = Tmp_0 value = 0.01 }
				check_key = { lhs = $class$_Wealth value = 15 } # gotta have something
			}

			if = {
				limit = { 
					always = $commercial$ 
					Banking = 100 
				}
				[[commercial_div] divide_key = { lhs = Tmp_0 value = $commercial_div$ } ]
			}
			else = {
				divide_key = { lhs = Tmp_0 value = $div$ }
			}
			if = {
				limit = {
					check_key = { lhs = Tmp_0 value = 0.01 }
				}
				multiply_key = { lhs = Tmp_0 value = 0.008 } #divide_key = { lhs = Tmp_0 value = 125 }				
				if = {
					limit = {
						check_key = { lhs = Tmp_0 which = $class$_Wealth }
					}
					set_key = { lhs = Tmp_0 which = $class$_Wealth }
				}
				change_key = { lhs = Infra_Income which = Tmp_0 }
				change_key = { lhs = $class$_SpendInfra which = Tmp_0 }
			}
		}
    }
}

Infra_GetAppealInfra = {
    if = {
        limit = {
            OR = {
                check_key = { lhs = Infra_$type$Decay value = 0.1 }
                check_key = { lhs = Infra_$type$ value = 7 }
            }
        }
        set_key = { lhs = $return$ value = -1 } # if infrstructure cannot be build, stop upgrading
    }
    else = {
        set_key = { lhs = $return$ value = 0 } # reset appeal

		# Get appeal per class based on power and ownership in $return$ (Tmp_3)
        Infra_GetAppealHelper = { class = NO weight = $weightNO$ return = $return$ [[rural] rural = $rural$ ] [[urban] urban = $urban$ ] [[nomad] nomad = $nomad$ ] }
        Infra_GetAppealHelper = { class = BG weight = $weightBG$ return = $return$ [[rural] rural = $rural$ ] [[urban] urban = $urban$ ] [[nomad] nomad = $nomad$ ] }
        Infra_GetAppealHelper = { class = CL weight = $weightCL$ return = $return$ [[rural] rural = $rural$ ] [[urban] urban = $urban$ ] [[nomad] nomad = $nomad$ ] }

		[[urban]
			if = {
				limit = {
					always = $urban$
				}
				Infra_GetAmenities_Cap = { return = Public_Tmp0 } # Get amenities population capacity
				set_key = { lhs = Public_Tmp1 which = RE_Total }

				## Multiply pre cost appeal by a modifier based on how much a city is over it's amenities limit
				# Formula: (Residents / Cap)
				multiply_key = { lhs = Public_Tmp1 value = 1.8 } # use this to balance the effect vs. the cap -> 1.5 = at the cap you get 50% more appeal
				if = {
					limit = {
						check_key = { lhs = Public_Tmp0 value = 0.001 }
					}
					divide_key = { lhs = Public_Tmp1 which = Public_Tmp0 }
				}
				else = {
					set_key = { lhs = Public_Tmp1 value = 0 }
				}

				if = {
					limit = {
						check_key = { lhs = Public_Tmp0 value = 3 }
					}
					set_key = { lhs = Public_Tmp0 value = 3 }
				}
				else_if = {
					limit = {
						NOT = { check_key = { lhs = Public_Tmp0 value = 0.75 } }
					}
					set_key = { lhs = Public_Tmp0 value = 0.75 }
				}

				multiply_key = { lhs = $return$ which = Public_Tmp0 }
				set_key = { lhs = Public_Tmp0 value = 0 }
				set_key = { lhs = Public_Tmp1 value = 0 }
			}
		]
		[[paths]
		if = {
			limit = { always = $paths$ check_key = { lhs = TN_Pass value = 1 } } 
			multiply_key = { lhs = $return$ value = 1.333 } # ancient paths are desired to have Pathing
		}
		]

        Infra_GetCostBuild$type$ = yes # get base goods to build one unit

		# multiply goods with prices
        multiply_key = { lhs = Infra_Cost6 which = TN_ProvPrc6 }
        multiply_key = { lhs = Infra_Cost22 which = TN_ProvPrc22 }
        multiply_key = { lhs = Infra_Cost23 which = TN_ProvPrc23 }
        multiply_key = { lhs = Infra_Cost24 which = TN_ProvPrc24 }
        multiply_key = { lhs = Infra_Cost41 which = TN_ProvPrc41 }

		# Multiply Labor requirements with labour wages (PR = PriceRural, PUL = PriceUrbanLabour)
        multiply_key = { lhs = Infra_CostR which = Class_PR }
        multiply_key = { lhs = Infra_CostUL which = Class_PUL }

		# Sum up total costs in Tmp_9 (All goods costs + Labor Costs
        set_key = { lhs = Tmp_9 which = Infra_Cost6 }
        change_key = { lhs = Tmp_9 which = Infra_Cost22 }
        change_key = { lhs = Tmp_9 which = Infra_Cost23 }
        change_key = { lhs = Tmp_9 which = Infra_Cost24 }
        change_key = { lhs = Tmp_9 which = Infra_Cost41 }
		
        change_key = { lhs = Tmp_9 which = Infra_CostR }
        change_key = { lhs = Tmp_9 which = Infra_CostUL }

		# Appeal / Total Costs per unit
        divide_key = { lhs = $return$ which = Tmp_9 }
		
		# Get infrastructure unit goal - current amount of units
        set_key = { lhs = Tmp_9 which = Infra_$type$Goal }
        subtract_key = { lhs = Tmp_9 which = Infra_$type$Size }

		# Appeal / Required Units to Upgrade
        divide_key = { lhs = $return$ which = Tmp_9 }
		
		# Get Rank of current unit + 1
		set_key = { lhs = Tmp_9 which = Infra_$type$ }
		change_key = { lhs = Tmp_9 value = 1 }

		# Appeal / Rank+1
		divide_key = { lhs = $return$ which = Tmp_9 }

		[[urban] ## ONLY UPGRAED AMENITIES WHEN HAVING THE LAST RANK FULFILLED ATLEAST 50% 
			if = {
				limit = { always = $urban$ }

				Infra_GetAmenities_Cap = { return = Public_Tmp0 } # Get amenities population capacity
				set_key = { lhs = Public_Tmp1 which = RE_Total }

				if = {
					limit = {
						check_key = { lhs = Public_Tmp0 value = 0.001 }
					}
					divide_key = { lhs = Public_Tmp1 which = Public_Tmp0 }
				}
				else = {
					set_key = { lhs = Public_Tmp1 value = 0 }
				}

				if = {
					limit = { NOT = { check_key = { lhs = Public_Tmp1 value = 0.75 } } }

					set_key = { lhs = $return$ value = -1 }
				}
			}
		]

		# Clear variables
        set_key = { lhs = Infra_Cost6 value = 0 }
        set_key = { lhs = Infra_Cost22 value = 0 }
        set_key = { lhs = Infra_Cost23 value = 0 }
        set_key = { lhs = Infra_Cost24 value = 0 }
        set_key = { lhs = Infra_Cost41 value = 0 }
        set_key = { lhs = Infra_CostR value = 0 }
        set_key = { lhs = Infra_CostUL value = 0 }
        set_key = { lhs = Tmp_9 value = 0 }
    }
}

Infra_SetRankInfra = {
    set_key = { lhs = Infra_$type$ value = 0 }

    Infra_GetGoal$type$ = { inp = Infra_$type$ return = Infra_$type$Goal }
    
    while = {
        limit = {
            check_key = { lhs = Infra_$type$Size which = Infra_$type$Goal }

            NOT = {
                check_key = { lhs = Infra_$type$ value = 7 }
            }
        }
        change_key = { lhs = Infra_$type$ value = 1 }

        Infra_GetGoal$type$ = { inp = Infra_$type$ return = Infra_$type$Goal }
    }

    set_province_flag = Infra_Update
}

Infra_RefreshModifier = {
	if = {
		limit = {
			OR = {
				has_province_flag = Infra_S0
				has_province_flag = Infra_S1
				has_province_flag = Infra_S2
				has_province_flag = Infra_S3
				has_province_flag = Infra_S4
				has_province_flag = Infra_S5
				has_province_flag = Infra_S6
				has_province_flag = Infra_S7
				has_province_flag = Infra_S8
				has_province_flag = Infra_S9
			}
		}
        if = {
            limit = {
                NOT = { 
                    has_province_modifier = Construct_Modi 
                }
            }
            add_permanent_province_modifier = { name = Construct_Modi duration = -1 }
        }
	}
	else_if = {
		limit = {
			has_province_modifier = Construct_Modi
		}
        set_key = { lhs = Construct_Parallel value = 0 }
		remove_province_modifier = Construct_Modi
	}
}
Infra_UISet = {
	if = {
		limit = {
			PREV = { has_country_flag = Infra_$Infra$25 }
		}
		set_province_flag = Infra_$Infra$25
	}
	else = {
		clr_province_flag = Infra_$Infra$25
	}
	if = {
		limit = {
			PREV = { has_country_flag = Infra_$Infra$50 }
		}
		set_province_flag = Infra_$Infra$50
	}
	else = {
		clr_province_flag = Infra_$Infra$50
	}
	if = {
		limit = {
			PREV = { has_country_flag = Infra_$Infra$75 }
		}
		set_province_flag = Infra_$Infra$75
	}
	else = {
		clr_province_flag = Infra_$Infra$75
	}
	if = {
		limit = {
			PREV = { has_country_flag = Infra_$Infra$100 }
		}
		set_province_flag = Infra_$Infra$100
	}
	else = {
		clr_province_flag = Infra_$Infra$100
	}
}