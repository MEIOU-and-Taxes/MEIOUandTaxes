#by Fire and Shiro

Plague_InitSystem = {
	every_province = {
		limit = {
			isValidEmpty = yes
		}
      	set_key = { lhs = Plague_Factors value = 1 }
		trigger_switch = {
			on_trigger = has_terrain
			
			arctic = {
				multiply_key = { lhs = Plague_Factors value = 0.2 }
			}
			forest_flats = {
				multiply_key = { lhs = Plague_Factors value = 0.7 }
			}
			forest_hills = {
				multiply_key = { lhs = Plague_Factors value = 0.6 }
			}
			forest_mountains = {
				multiply_key = { lhs = Plague_Factors value = 0.3 }
			}
			forest_highlands = {
				multiply_key = { lhs = Plague_Factors value = 0.5 }
			}
			wood_flats = {
				multiply_key = { lhs = Plague_Factors value = 0.9 }
			}
			wood_hills = {
				multiply_key = { lhs = Plague_Factors value = 0.7 }
			}
			wood_mountains = {
				multiply_key = { lhs = Plague_Factors value = 0.5 }
			}
			wood_highlands = {
				multiply_key = { lhs = Plague_Factors value = 0.6 }
			}
			shrub_flats = {
				multiply_key = { lhs = Plague_Factors value = 0.95 }
			}
			shrub_hills = {
				multiply_key = { lhs = Plague_Factors value = 0.8 }
			}
			shrub_mountains = {
				multiply_key = { lhs = Plague_Factors value = 0.5 }
			}
			shrub_highlands = {
				multiply_key = { lhs = Plague_Factors value = 0.7 }
			}
			grass_flats = {
				multiply_key = { lhs = Plague_Factors value = 1.0 }
			}
			grass_hills = {
				multiply_key = { lhs = Plague_Factors value = 0.8 }
			}
			grass_mountains = {
				multiply_key = { lhs = Plague_Factors value = 0.5 }
			}
			grass_highlands = {
				multiply_key = { lhs = Plague_Factors value = 0.7 }
			}
			desert_flats = {
				multiply_key = { lhs = Plague_Factors value = 0.5 }
			}
			desert_hills = {
				multiply_key = { lhs = Plague_Factors value = 0.4 }
			}
			desert_mountains = {
				multiply_key = { lhs = Plague_Factors value = 0.2 }
			}
			desert_highlands = {
				multiply_key = { lhs = Plague_Factors value = 0.3 }
			}
			jungle_flats = {
				multiply_key = { lhs = Plague_Factors value = 0.6 }
			}
			jungle_hills = {
				multiply_key = { lhs = Plague_Factors value = 0.4 }
			}
			floodplains = {
				multiply_key = { lhs = Plague_Factors value = 0.8 }
			}
			taiga = {
				multiply_key = { lhs = Plague_Factors value = 0.6 }
			}
			marsh = {
				multiply_key = { lhs = Plague_Factors value = 0.7 }
			}
			alpine_tundra = {
				multiply_key = { lhs = Plague_Factors value = 0.3 }
			}
			tundra = {
				multiply_key = { lhs = Plague_Factors value = 0.4 }
			}
			small_island = {
				multiply_key = { lhs = Plague_Factors value = 0.9 }
			}
		}
		if = {
			limit = {
				province_group = saharan_steppes_group # limit trans sahara
			}
			multiply_key = { lhs = Plague_Factors value = 0.2 }
		}
		if = {
			limit = {
				is_city = no
				is_colony = no
				NOT = {
					continent = north_america
					continent = south_america
				}
			}
			multiply_key = { lhs = Plague_Factors value = 0.5 } # limit uncolonised spread
		}
        set_key = { lhs = Plague_SpawnChance0 value = 0 }
        set_key = { lhs = Plague_SpawnChance1 value = 0 }
        set_key = { lhs = Plague_SpawnChance2 value = 0 }
        set_key = { lhs = Plague_SpawnChance3 value = 0 }
        set_key = { lhs = Plague_SpawnChance4 value = 0 }
        if = {
            limit = {
                NOT = {
                    continent = north_america #Handled differently
					continent = south_america #Handled differently
                    
                }
            }
            if = { # set bubonic base spawning chance
                limit = {
                    NOT = { continent = indian_continent }
                    check_key = { lhs = Land_AvgTemp value = 10 }
                }
                if = {
                    limit = {
                        check_key = { lhs = Land_AvgTemp value = 12 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Land_AvgTemp value = 14 }
                        }
                        change_key = { lhs = Plague_SpawnChance0 value = 10 }
                    }
                    else = { 
                        change_key = { lhs = Plague_SpawnChance0 value = 5 }
                    }
                }
                else = { 
                    change_key = { lhs = Plague_SpawnChance0 value = 1 } 
                }
            }
            if = { # smallpox was exogenous in Africa. Smallpox more in cold places.
                limit = {
                    NOT = { continent = africa }
                    NOT = { check_key = { lhs = Land_AvgTemp value = 12 } }
                }
                if = {
                    limit = {
                        NOT = { check_key = { lhs = Land_AvgTemp value = 10 } }
                    }
                    if = {
                        limit = {
                            NOT = { check_key = { lhs = Land_AvgTemp value = 8 } }
                        }
                        change_key = { lhs = Plague_SpawnChance1 value = 3 }
                    }
                    else = { 
                        change_key = { lhs = Plague_SpawnChance1 value = 2 }
                    }
                }
                else = { 
                    change_key = { lhs = Plague_SpawnChance1 value = 1 } 
                }
            }
            if = { # Typhus 
                limit = { # No records of african typhus pre 1900
                    NOT = { 
                        continent = africa
                    }  
                }
                change_key = { lhs = Plague_SpawnChance3 value = 1 }
            }
            if = { # Malaria
                limit = {
                    continent = africa 
                }
                change_key = { lhs = Plague_SpawnChance4 value = 1 }
            }
            if = {
                limit = {
                    check_key = { lhs = Land_AvgTemp value = 15.5 } 
                }
                if = {
                    limit = {
                        check_key = { lhs = Land_AvgTemp value = 17.5 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Land_AvgTemp value = 19.5 }
                        }
                        if = {
                            limit = {
                                check_key = { lhs = Land_AvgTemp value = 21.5 }
                            }
                            if = {
                                limit = {
                                    check_key = { lhs = Land_AvgTemp value = 23.5 }
                                }
                                change_key = { lhs = Plague_SpawnChance4 value = 7 }
                            }
                            else = {
                                change_key = { lhs = Plague_SpawnChance4 value = 5 }
                            }
                        }
                        else = {
                            change_key = { lhs = Plague_SpawnChance4 value = 3.7 }
                        }
                    }
                    else = {
                        change_key = { lhs = Plague_SpawnChance4 value = 2.65 }
                    }
                }
                else = {
                    change_key = { lhs = Plague_SpawnChance4 value = 0.7 }
                }        
            }
            if = {
                limit = {
                    has_terrain = marsh
                    check_key = { lhs = Land_AvgTemp value = 13 }
                }
                change_key = { lhs = Plague_SpawnChance4 value = 2 }
            }
            trigger_switch = { # 0 is bubonic, 1 smallpox, 2 Salmonella, 3 typhus, 4 malaria
                on_trigger = has_terrain
                
                arctic = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.25 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.25 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.25 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
                }
                forest_flats = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 1.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 1 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 1 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 1.2 }
                }
                forest_hills = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0.75 }
                }
                forest_mountains = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
                }
                forest_highlands = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
                }
                wood_flats = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 1.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 1.5 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 1.5 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 1.5 }
                }
                wood_hills = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0.75 }
                }
                wood_mountains = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.5 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0.25 }
                }
                wood_highlands = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0.75 }
                }
                shrub_flats = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 2 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 1.5 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 1.5 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 1 }
                }
                shrub_hills = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0.75 }
                }
                shrub_mountains = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
                }
                shrub_highlands = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                  
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
                }
                grass_flats = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 1.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 1.5 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 1.5 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 1.5 }
                   
                }
                grass_hills = {
                   
                }
                grass_mountains = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                  
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
                }
                grass_highlands = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
                }
                desert_flats = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.75 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.75 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
                }
                desert_hills = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.5 }
                  
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
                }
                desert_mountains = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.5 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
                }
                desert_highlands = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.5 }
                  
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
                }
                jungle_flats = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 2 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 1.5 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 1.5 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 2 }
                }
                jungle_hills = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 1.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 1 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 1 }
                  
                   multiply_key = { lhs = Plague_SpawnChance4 value = 2 }
                }
                floodplains = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 2 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 2 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 2 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 2.75 }
                }
                taiga = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 1 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 1 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 1 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 1.5 }
                }
                marsh = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 1 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 1 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 1 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 2 }
                }
                alpine_tundra = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.5 }
                   
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
                }
                tundra = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 0.5 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 0.5 }
                  
                   multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
                }
                small_island = {
                   multiply_key = { lhs = Plague_SpawnChance0 value = 1 }
                   multiply_key = { lhs = Plague_SpawnChance1 value = 1 }
                   multiply_key = { lhs = Plague_SpawnChance2 value = 1 }
                   multiply_key = { lhs = Plague_SpawnChance4 value = 1 }
                }
            }
            if = {
                limit = {
                    check_key = { lhs = TN_River value = 1 }
                }
                change_key = { lhs = Plague_SpawnChance4 value = 2 }
            }
            if = {
                limit = {
                    check_key = { lhs = Plague_SpawnChance4 value = 0.1 }
                }
                set_province_flag = mosquitos
            }
        }
            #SOUTH AMERICA AND NORTH AMERICA
        if = {
            limit = {
                OR = {
                    continent = south_america
                    continent = north_america
                }
            }
            set_key = { lhs = Tmp_4 value = 0 }
            if = {
                limit = {
                    check_key = { lhs = Land_AvgTemp value = 15.5 } 
                }
                if = {
                    limit = {
                        check_key = { lhs = Land_AvgTemp value = 17.5 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Land_AvgTemp value = 19.5 }
                        }
                        if = {
                            limit = {
                                check_key = { lhs = Land_AvgTemp value = 21.5 }
                            }
                            if = {
                                limit = {
                                    check_key = { lhs = Land_AvgTemp value = 23.5 }
                                }
                                change_key = { lhs = Tmp_4 value = 7 }
                            }
                            else = {
                                change_key = { lhs = Tmp_4 value = 5 }
                            }
                        }
                        else = {
                            change_key = { lhs = Tmp_4 value = 4 }
                        }
                    }
                    else = {
                        change_key = { lhs = Tmp_4 value = 3 }
                    }
                }
                else = {
                    change_key = { lhs = Tmp_4 value = 1 }
                }        
            }
            if = {
                limit = {
                    has_terrain = marsh
                    check_key = { lhs = Land_AvgTemp value = 13 }
                }
                change_key = { lhs = Tmp_4 value = 2 }
            }
            trigger_switch = { # 0 is bubonic, 1 smallpox, 2 Salmonella, 3 typhus, 4 malaria
                on_trigger = has_terrain
                
                arctic = {
                   
                   multiply_key = { lhs = Tmp_4 value = 0 }
                }
                forest_flats = {
                  
                   multiply_key = { lhs = Tmp_4 value = 1.2 }
                }
                forest_hills = {
                  
                   multiply_key = { lhs = Tmp_4 value = 0.75 }
                }
                forest_mountains = {
                   
                   multiply_key = { lhs = Tmp_4 value = 0 }
                }
                forest_highlands = {
                  
                   
                   multiply_key = { lhs = Tmp_4 value = 0 }
                }
                wood_flats = {
                  
                   multiply_key = { lhs = Tmp_4 value = 1.5 }
                }
                wood_hills = {
                  
                   multiply_key = { lhs = Tmp_4 value = 0.75 }
                }
                wood_mountains = {
                 
                   multiply_key = { lhs = Tmp_4 value = 0.25 }
                }
                wood_highlands = {
                  
                   multiply_key = { lhs = Tmp_4 value = 0.75 }
                }
                shrub_flats = {
                  
                   multiply_key = { lhs = Tmp_4 value = 1 }
                }
                shrub_hills = {
                   
                   multiply_key = { lhs = Tmp_4 value = 0.75 }
                }
                shrub_mountains = {
                 
                   multiply_key = { lhs = Tmp_4 value = 0.5 }
                }
                shrub_highlands = {
                 
                   multiply_key = { lhs = Tmp_4 value = 0.5 }
                }
                grass_flats = {
                  
                   multiply_key = { lhs = Tmp_4 value = 1.5 }
                   
                }
                grass_hills = {
                   
                }
                grass_mountains = {
                  
                   multiply_key = { lhs = Tmp_4 value = 0 }
                }
                grass_highlands = {
                  
                   multiply_key = { lhs = Tmp_4 value = 0 }
                }
                desert_flats = {
                  
                   multiply_key = { lhs = Tmp_4 value = 0.5 }
                }
                desert_hills = {
                  
                   multiply_key = { lhs = Tmp_4 value = 0.5 }
                }
                desert_mountains = {
                  
                   multiply_key = { lhs = Tmp_4 value = 0.5 }
                }
                desert_highlands = {
                   
                   multiply_key = { lhs = Tmp_4 value = 0 }
                }
                jungle_flats = {
                  
                   multiply_key = { lhs = Tmp_4 value = 2 }
                }
                jungle_hills = {
                  
                   multiply_key = { lhs = Tmp_4 value = 2 }
                }
                floodplains = {
                  
                   multiply_key = { lhs = Tmp_4 value = 2.75 }
                }
                taiga = {
                    multiply_key = { lhs = Tmp_4 value = 1.5 }
                }
                marsh = {

                   multiply_key = { lhs = Tmp_4 value = 2 }
                }
                alpine_tundra = {
                    multiply_key = { lhs = Tmp_4 value = 0 }
                }
                tundra = {
                    multiply_key = { lhs = Tmp_4 value = 0 }
                }
                small_island = {
                  
                   multiply_key = { lhs = Tmp_4 value = 1 }
                }
            }
            if = {
                limit = {
                    check_key = { lhs = Tmp_4 value = 0.1 }
                }
                set_province_flag = possible_malaria
            }
        }
        
            # Starting Immunity #
            
        if = { # Africa is a lot more resistant to malaria on start
            limit = { 
                continent = africa
            }
            set_key = { lhs = Plague_Resistance0 value = 0 }
            set_key = { lhs = Plague_Resistance1 value = 10 }
            set_key = { lhs = Plague_Resistance2 value = 10 }
            set_key = { lhs = Plague_Resistance3 value = 10 }
            set_key = { lhs = Plague_Resistance4 value = 75 }
            if = {
                limit = {
                    superregion = north_africa_superregion
                }
                set_key = { lhs = Plague_Resistance0 value = 40 } # north africa was hit by black death
            }
        }
        if = {
            limit = {
                OR = {
                    continent = southeast_asia 
                    continent = indian_continent
                }
            }
            set_key = { lhs = Plague_Resistance0 value = 72 } #bubonic
            set_key = { lhs = Plague_Resistance1 value = 75 } #smallpox
            set_key = { lhs = Plague_Resistance2 value = 0 } #salmonella
            set_key = { lhs = Plague_Resistance3 value = 75 } #typhus
            set_key = { lhs = Plague_Resistance4 value = 65 } #malaria
        }
        else_if = {
            limit = {
                NOT = {
                    continent = north_america
                    continent = south_america
                    continent = europe
                }
            }
            set_key = { lhs = Plague_Resistance0 value = 65 } #bubonic
            set_key = { lhs = Plague_Resistance1 value = 70 } #smallpox
            set_key = { lhs = Plague_Resistance2 value = 0 } #salmonella
            set_key = { lhs = Plague_Resistance3 value = 75 } #typhus
            set_key = { lhs = Plague_Resistance4 value = 50 } #malaria
        }
        else_if = {
            limit = {
                continent = europe
            }
            set_key = { lhs = Plague_Resistance0 value = 60 } #bubonic
            set_key = { lhs = Plague_Resistance1 value = 75 } #smallpox
            set_key = { lhs = Plague_Resistance2 value = 0 } #salmonella
            set_key = { lhs = Plague_Resistance3 value = 75 } #typhus
            set_key = { lhs = Plague_Resistance4 value = 65 } #malaria
        }
    }        
}
Plague_Init = {
	every_province = {
		limit = {
			isValidEmpty = yes
			NOT = { has_province_flag = Plague$Type$ }
		}
		set_province_flag = PlagueCand$Type$
		set_key = { lhs = Plague_Susceptible$Type$ value = 100 }
        if = {
            limit = {
                NOT = { check_key = { lhs = Plague_Resistance$Type$ value = 1 } }
            }
            set_key = { lhs = Plague_Resistance$Type$ value = 1.5 }
        }
        subtract_key = { lhs = Plague_Susceptible$Type$ which = Plague_Resistance$Type$ } # remove susceptible based on starting immunity
		set_key = { lhs = Plague_SusceptibleChange$Type$ value = 0 }
		set_key = { lhs = Plague_Infected$Type$ value = 0 }
		set_key = { lhs = Plague_InfectedChange$Type$ value = 0 }
		set_key = { lhs = Plague_Removed$Type$ value = 0 }
		set_key = { lhs = Plague_RemovedChange$Type$ value = 0 }
		set_key = { lhs = Plague_Dead$Type$ value = 0 }
		set_key = { lhs = Plague_DeadChange$Type$ value = 0 }
		set_key = { lhs = Plague_DeadRaw$Type$ value = 0 }
		set_key = { lhs = Plague_DeadRawChange$Type$ value = 0 }
	}
}
Plague_Spawn = {
	set_province_flag = Plague
	clr_province_flag = PlagueCand$Type$
	set_province_flag = Plague$Type$
    set_province_flag = PlagueSpawner
	set_key = { lhs = Plague_Susceptible$Type$ value = 100 }
    if = {
        limit = {
            NOT = { check_key = { lhs = Plague_Resistance$Type$ value = 1.5 } }
        }
        set_key = { lhs = Plague_Resistance$Type$ value = 1.5 }
    }
    subtract_key = { lhs = Plague_Susceptible$Type$ which = Plague_Resistance$Type$ }
	set_key = { lhs = Plague_SusceptibleChange$Type$ value = 0 }
	set_key = { lhs = Plague_Infected$Type$ value = 0 }
	set_key = { lhs = Plague_InfectedChange$Type$ value = 0 }
	set_key = { lhs = Plague_Removed$Type$ value = 0 }
	set_key = { lhs = Plague_RemovedChange$Type$ value = 0 }
	set_key = { lhs = Plague_Dead$Type$ value = 0 }
	set_key = { lhs = Plague_DeadChange$Type$ value = 0 }
	set_key = { lhs = Plague_DeadRaw$Type$ value = 0 }
	set_key = { lhs = Plague_DeadRawChange$Type$ value = 0 }
    set_key = { lhs = Plague_Infected$Type$ value = $InitInfection$ }
	set_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Infected$Type$ }
	subtract_key = { lhs = Plague_Susceptible$Type$ which = Plague_Infected$Type$ }
	subtract_key = { lhs = Plague_SusceptibleChange$Type$ which = Plague_Infected$Type$ }
	add_permanent_province_modifier = {
		name = Plague_Spawn$Type$
		duration = -1
	}
    add_province_modifier = {
		name = Plague_origin1
		duration = 1
        hidden = yes
	}
    Plague_Init = { Type = $Type$ }
    every_country = {
        limit = {
            isValidCountry = yes
            ai = no
            has_discovered = PREV
        }
        PREV = {
            trigger_switch = {
                on_trigger = has_province_flag 
                
                Plague0 = { PREV = { country_event = { id = Plague_Spawner.7 } } }
                Plague1 = { PREV = { country_event = { id = Plague_Spawner.8 } } }
                Plague2 = { PREV = { country_event = { id = Plague_Spawner.9 } } }
                Plague3 = { PREV = { country_event = { id = Plague_Spawner.10 } } }
                Plague4 = { PREV = { country_event = { id = Plague_Spawner.11 } } }
            }
        }
    }
}
Plague_Spawn_Malaria = {
	set_province_flag = Plague
	clr_province_flag = PlagueCand$Type$
	set_province_flag = Plague$Type$
    set_province_flag = PlagueSpawner
	set_key = { lhs = Plague_Susceptible$Type$ value = 100 }
    if = {
        limit = {
            OR = {
                culture_group = sahelian_group
                culture_group = dogon_group
                culture_group = senufo_group
                culture_group = akan_group
                culture_group = kru_group
                culture_group = volta_group
                culture_group = saharan_group
                culture_group = plateau_group
#             culture_group = chadic_group
                culture_group = kwa_group
                culture_group = southern_african
                culture_group = kongo_group
                culture_group = great_lakes_group
                culture_group = swahili_group
            }
            NOT = { check_key = { lhs = Plague_Resistance$Type$ value = 30 } }
        }
        set_key = { lhs = Plague_Resistance$Type$ value = 30 }
    }
    else_if = {
        limit = {
            NOT = { check_key = { lhs = Plague_Resistance$Type$ value = 1.5 } }
        }
        set_key = { lhs = Plague_Resistance$Type$ value = 1.5 }
    }
    subtract_key = { lhs = Plague_Susceptible$Type$ which = Plague_Resistance$Type$ }
	set_key = { lhs = Plague_SusceptibleChange$Type$ value = 0 }
	set_key = { lhs = Plague_Infected$Type$ value = 0 }
	set_key = { lhs = Plague_InfectedChange$Type$ value = 0 }
	set_key = { lhs = Plague_Removed$Type$ value = 0 }
	set_key = { lhs = Plague_RemovedChange$Type$ value = 0 }
	set_key = { lhs = Plague_Dead$Type$ value = 0 }
	set_key = { lhs = Plague_DeadChange$Type$ value = 0 }
	set_key = { lhs = Plague_DeadRaw$Type$ value = 0 }
	set_key = { lhs = Plague_DeadRawChange$Type$ value = 0 }
    set_key = { lhs = Plague_Infected$Type$ value = $InitInfection$ }
	set_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Infected$Type$ }
	subtract_key = { lhs = Plague_Susceptible$Type$ which = Plague_Infected$Type$ }
	subtract_key = { lhs = Plague_SusceptibleChange$Type$ which = Plague_Infected$Type$ }
	add_permanent_province_modifier = {
		name = Plague_Spawn$Type$
		duration = -1
	}
    add_province_modifier = {
		name = Plague_origin1
		duration = 1
        hidden = yes
	}
    Plague_Init = { Type = $Type$ }
    every_country = {
        limit = {
            isValidCountry = yes
            ai = no
            has_discovered = PREV
        }
        PREV = {
            trigger_switch = {
                on_trigger = has_province_flag 
                
                Plague0 = { PREV = { country_event = { id = Plague_Spawner.7 } } }
                Plague1 = { PREV = { country_event = { id = Plague_Spawner.8 } } }
                Plague2 = { PREV = { country_event = { id = Plague_Spawner.9 } } }
                Plague3 = { PREV = { country_event = { id = Plague_Spawner.10 } } }
                Plague4 = { PREV = { country_event = { id = Plague_Spawner.11 } } }
            }
        }
    }
}
Plague_Clean = {
	clr_province_flag = Plague$Type$
    clr_province_flag = max_death
    clr_province_flag = PlagueSpawner
    clr_province_flag = PlagueTNM$Type$
    clr_province_flag = PlagueTNM$Type$
	set_key = { lhs = Plague_Susceptible$Type$ value = 0 }
	set_key = { lhs = Plague_Infected$Type$ value = 0 }
	#set_key = { lhs = Plague_RemovedChange$Type$ value = 0 }
	#set_key = { lhs = Plague_DeadChange$Type$ value = 0 }
	#set_key = { lhs = Plague_DeadRawChange$Type$ value = 0 }
    remove_province_modifier = Plague_mod$Type$
    remove_province_modifier = Plague_mod_m$Type$
    remove_province_modifier = Plague_mod_s$Type$
    remove_province_modifier = Plague_Spawn$Type$
    clr_province_flag = Plague
    add_province_modifier = {
        name = Plague_Passed$Type$
        duration = 365
    }
    if = {
        limit = {
            check_key = { lhs = Plague_Dead$Type$ value = 5 } #if >5% of population died
        }
        hidden_effect = {
            province_event = { id = MEC_ProvinceInteraction.1 days = 2 }
        }
    }
}
Plague_Clean_Malaria = {
    if = {
        limit = {
            OR = {
                continent = north_america
                continent = south_america
            }
            has_province_flag = possible_malaria
            NOT = { check_key = { lhs = Plague_SpawnChance4 value = 0.1 } }
            check_key = { lhs = Plague_Dead$Type$ value = 5 }
        }
        America_Malaria_Calculator = yes
        set_province_flag = mosquitos
    }
    clr_province_flag = Plague$Type$
    clr_province_flag = max_death
    clr_province_flag = PlagueSpawner
    clr_province_flag = PlagueTNM$Type$
    clr_province_flag = PlagueTNM$Type$
	
    remove_province_modifier = Plague_mod$Type$
    remove_province_modifier = Plague_mod_m$Type$
    remove_province_modifier = Plague_mod_s$Type$
    remove_province_modifier = Plague_Spawn$Type$
    add_province_modifier = {
        name = Plague_Passed$Type$
        duration = 365
    }
}
#Plague_Test = {
#	#Plague_Init = { Type=0 }
#    #Plague_Init = { Type=1 }
#    #Plague_Init = { Type=2 }
#    #Plague_Init = { Type=3 }
#    #Plague_Init = { Type=4 }
#    #89 = {
#    #    Plague_Spawn = { Type=0 InitInfection=0.01 }
#    #}
#    #2354 = {
#    #    Plague_Spawn = { Type=1 InitInfection=0.01 }
#    #}
#    178 = {
#        Plague_Spawn = { Type=0 InitInfection=0.01 }
#    }
#    #695 = {
#    #    Plague_Spawn = { Type=3 InitInfection=0.01 }
#    #}
#    #5407 = {
#    #    Plague_Spawn = { Type=2 InitInfection=0.01 }
#    #}
#    #89 = {
#    #    Plague_Spawn = { Type=4 InitInfection=0.01 }
#    #}
#}
#Plague_Test_1 = {
#	Plague_Init = { Type=0 }
#    Plague_Init = { Type=1 }
#    Plague_Init = { Type=2 }
#    Plague_Init = { Type=3 }
#    Plague_Init = { Type=4 }
#    #89 = {
#    #    Plague_Spawn = { Type=0 InitInfection=0.01 }
#    #}
#    200 = {
#        Plague_Spawn = { Type=4 InitInfection=0.01 }
#    }
#    #183 = {
#    #    Plague_Spawn = { Type=0 InitInfection=0.01 }
#    #}
#    #695 = {
#    #    Plague_Spawn = { Type=3 InitInfection=0.01 }
#    #}
#    #5407 = {
#    #    Plague_Spawn = { Type=0 InitInfection=0.01 }
#    #}
#}
#Plague_Test_2 = {
#	Plague_Init = { Type=0 }
#    Plague_Init = { Type=1 }
#    Plague_Init = { Type=2 }
#    Plague_Init = { Type=3 }
#    Plague_Init = { Type=4 }
#    #361 = {
#    #    Plague_Spawn = { Type=2 InitInfection=0.01 }
#    #}
#    #2354 = {
#    #    Plague_Spawn = { Type=3 InitInfection=0.01 }
#    #}
#    #183 = {
#    #    Plague_Spawn = { Type=0 InitInfection=0.01 }
#    #}
#    #695 = {
#    #    Plague_Spawn = { Type=3 InitInfection=0.01 }
#    #}
#    #5407 = {
#    #    Plague_Spawn = { Type=0 InitInfection=0.01 }
#    #}
#}
Plague_Model = {
	contgroup = {
		limit = {
			is_key_equal = { lhs = ID_Cont which = PREV }
		}
		set_province_flag = ActivePlague$Type$
	}
	if = { # plague cleaner
		limit = {
            OR = {
                AND = {
                    NOT = { check_key = { lhs = Plague_DeadChange$Type$ value = 0.1 } }
                    had_province_flag = {
                        flag = Plague$Type$
                        days = 486
                    }
                }
                AND = {
                    NOT = { check_key = { lhs = Plague_Susceptible$Type$ value = 1 } }
                    NOT = { check_key = { lhs = Plague_Infected$Type$ value = 0.05 } }
                }
            }
		}				
        Plague_Clean = { Type = $Type$ }
        contgroup = {
            limit = {
                is_key_equal = { lhs = ID_Cont which = PREV }
            }
            clr_province_flag = ActivePlague$Type$
        }       
	}
    if = {
        limit = {
            has_province_flag = Plague$Type$
        }
        if = { 
            limit = {
                NOT = { has_province_flag = PlagueSpread$Type$ }
                NOT = { has_province_flag = PlagueCD$Type$ }
            }
            if = {
                limit = {
                    check_key = { lhs = Plague_Infected$Type$ value = 0.3 }
                }
                if = {
                    limit = {
                        check_key = { lhs = Plague_Infected$Type$ value = 0.5 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Plague_Infected$Type$ value = 0.7 }
                        }
                        if = {
                            limit = {
                                check_key = { lhs = Plague_Infected$Type$ value = 0.9 }
                            }
                            random_list = {
                                75 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                25 = {
                                }
                            }
                        }
                        else = {
                            random_list = {
                                65 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                35 = {
                                }
                            }
                        }
                    }
                    else = {
                        random_list = {
                            55 = {
                                set_province_flag = PlagueSpread$Type$
                            }
                            45 = {
                            }
                        }
                    }
                }
                else = {
                    random_list = {
                        45 = {
                            set_province_flag = PlagueSpread$Type$
                        }
                        55 = {
                        }
                    }
                }
            }
            else = {
                if = {
                    limit = {
                        check_key = { lhs = Plague_Infected$Type$ value = 0.05 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Plague_Infected$Type$ value = 0.07 }
                        }
                        if = {
                            limit = {
                                check_key = { lhs = Plague_Infected$Type$ value = 0.1 }
                            }
                            if = {
                                limit = {
                                    check_key = { lhs = Plague_Infected$Type$ value = 0.2 }
                                }
                                random_list = {
                                    30 = {
                                        set_province_flag = PlagueSpread$Type$
                                    }
                                    70 = {
                                    }
                                }
                            }
                            else = {
                                random_list = {
                                    25 = {
                                        set_province_flag = PlagueSpread$Type$
                                    }
                                    75 = {
                                    }
                                }
                            }
                        }
                        else = {
                            random_list = {
                                20 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                80 = {
                                }
                            }
                        }
                    }
                    else = {
                        random_list = {
                            15 = {
                                set_province_flag = PlagueSpread$Type$
                            }
                            85 = {
                            }
                        }
                    }
                }
            }
        }
        if = {
            limit = {
                has_province_flag = PlagueSpread$Type$
            }
            
            every_neighbor_province = {
                limit = {
                    has_province_flag = PlagueCand$Type$
                }            
                if = {
                    limit = {
                        check_key = { lhs = Plague_Resistance$Type$ value = 50 }
                    }
                    random_list = {
                        5 = {
                            Plague_Spread = { Type=$Type$ }
                            if = {
                                limit = {
                                    NOT = { check_key = { lhs = Land_Size value = 200 } }
                                }
                                PREV = {
                                    every_neighbor_province = {
                                        limit = {
                                            has_province_flag = PlagueCand$Type$
                                        }
                                        Plague_Spread = { Type=$Type$ }
                                    }
                                }
                            }
                        }
                        8 = {
                            PREV = { clr_province_flag = PlagueSpread$Type$ }
                        }
                    }
                }
                else = {
                    random_list = {
                        7 = {
                            Plague_Spread = { Type=$Type$ }
                            if = {
                                limit = {
                                    NOT = { check_key = { lhs = Land_Size value = 200 } }
                                }
                                PREV = {
                                    every_neighbor_province = {
                                        limit = {
                                            has_province_flag = PlagueCand$Type$
                                        }
                                        Plague_Spread = { Type=$Type$ }
                                    }
                                }
                            }
                        }
                        5 = {
                            PREV = { clr_province_flag = PlagueSpread$Type$ }
                        }
                    }
                }
            }
            every_empty_neighbor_province = {
                limit = {
                    has_province_flag = PlagueCand$Type$
                }
                random_list = {
                    30 = {
                        Plague_Spread = { Type=$Type$ }
                        if = {
                            limit = {
                                NOT = { check_key = { lhs = Land_Size value = 750 } }
                            }
                            PREV = {
                                every_empty_neighbor_province = {
                                    limit = {
                                        has_province_flag = PlagueCand$Type$
                                    }
                                    Plague_Spread = { Type=$Type$ }
                                }
                            }
                        }
                    }
                    70 = {
                        PREV = { clr_province_flag = PlagueSpread$Type$ }
                    }
                }
            }
            if = {
                limit = {
                    has_province_flag = TN_Port
                    has_province_flag = TN_COT_M
                    OR = {
                        NOT = { has_province_flag = PlagueTN$Type$ }
                        NOT = { has_province_flag = PlagueTNM$Type$ }
                    }
                    check_key = { lhs = Plague_Infected$Type$ value = 0.65 }
                }
                save_event_target_as = Plague
                owner = {
                    save_event_target_as = PlagueOwner
                }
                TN_effect = {
                    effect = TN_effect15
                    param1 = $Type$
                }
                if = {
                    limit = {
                        OR = {
                            NOT = { has_province_flag = PlagueTN$Type$ }
                            NOT = { has_province_flag = PlagueTNM$Type$ }
                        }
                    }
                    clr_province_flag = PlagueSpread$Type$
                }
            }
        }        
        else_if = {
            limit = {
                has_province_flag = PlagueCD$Type$
            }
            clr_province_flag = PlagueCD$Type$
        }
        Plague_ModelHelper = { Type=$Type$ SpreadRate=$SpreadRate$ RemovalRate=$RemovalRate$ Severity=$Severity$ ImmunityGain=$ImmunityGain$ } 
    }
}
Plague_Tick = {
	if = {
		limit = {
			has_province_flag = Plague
		}
        if = {
            limit = {
                has_province_flag = Plague0
            }
            Plague_Model = { Type=0 SpreadRate=16 RemovalRate=0.77 Severity=0.27 ImmunityGain=0.67 } # Bubonic
            
        }
        else_if = {
            limit = {
                has_province_flag = Plague1
            }
            Plague_Model_Smallpox = { Type=1 SpreadRate=11 RemovalRate=0.73 Severity=0.38 ImmunityGain=1 } # Smallpox
        }
        else_if = {
            limit = {
                has_province_flag = Plague2
            }
            Plague_Model_Salmonella = { Type=2 SpreadRate=38 RemovalRate=0.45 Severity=0.70 ImmunityGain=0.85 } # Salmonella
        }
        else_if = {
            limit = {
                has_province_flag = Plague3
            }
            Plague_Model_Typhus = { Type=3 SpreadRate=0.8 RemovalRate=0.55 Severity=0.25 ImmunityGain=0.8 } # Typhus
        }
        else_if = {
            limit = {
                has_province_flag = Plague4
            }
            Plague_Model_Malaria = { Type=4 SpreadRate=15 RemovalRate=0.4 Severity=0.13 ImmunityGain=0.3 }  # Malaria
        }
	}
}
Plague_CountryTick = {
    if = {
        limit = {
            ai = no
        }
        if = {
            limit = {
                any_owned_province = {
                    has_province_flag = Plague
                }
            }
            set_global_flag = Plague
        }
        else = {
            clr_global_flag = Plague
        }
    }
}
Plague_ModelHelper = { #Bubonic
	### Calculate new infected
	## define population that can be infected. immunity removes parts of the population from being able to infect others
    if = {
        limit = {
            check_key = { lhs = Plague_Susceptible$Type$ value = 0 }
        }
        set_key = { lhs = Plague_Tmp0 value = 4.5 }
		set_key = { lhs = Plague_Tmp1 which = Plague_Resistance$Type$ }
		multiply_key = { lhs = Plague_Tmp1 value = 0.01 }
		multiply_key = { lhs = Plague_Tmp1 which = Plague_Tmp1 }
        subtract_key = { lhs = Plague_Tmp0 which = Plague_Tmp1 }

        # Store the susceptible change
        set_key = { lhs = Plague_Tmp2 which = Plague_Susceptible$Type$ }
        multiply_key = { lhs = Plague_Susceptible$Type$ value = 0.84 } #remove % each month. Diseases don't have infinite time to infect
        subtract_key = { lhs = Plague_Tmp2 which = Plague_Susceptible$Type$ }
        if = {
            limit = {
                NOT = { check_key = { lhs = Plague_Susceptible$Type$ value = 1 } }
            }
            set_key = { lhs = Plague_Susceptible$Type$ value = 0 }
        }
        
        ## apply factors to spread, like population density, disease type, etc
        Plague_SpreadRateCalc = { return=Plague_InfectedChange$Type$ SpreadRate=$SpreadRate$ } # outputs a multiplier
           
        # calculate actual people infected
        multiply_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Susceptible$Type$ }
        multiply_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Tmp0 } # multiply spreading rate by immunity factor. 
        multiply_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Infected$Type$ } # more infection means critical mass, this is key. if it doesnt boom, it might not spread
        multiply_key = { lhs = Plague_InfectedChange$Type$ value = 0.001 }
        
        if = {
            limit = {
                check_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Susceptible$Type$ }
            }
            set_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Susceptible$Type$ }
        }
        else_if = { # over flow measures
            limit = {
                NOT = { check_key = { lhs = Plague_InfectedChange$Type$ value = 0 } }
            }
            set_key = { lhs = Plague_InfectedChange$Type$ value = 0 }
        }
        
        ## add to infected total
        
        change_key = { lhs = Plague_Infected$Type$ which = Plague_InfectedChange$Type$ }
           
        # remove infected from being susceptible, they are instead infected
        set_key = { lhs = Plague_SusceptibleChange$Type$ which = Plague_InfectedChange$Type$ }
        multiply_key = { lhs = Plague_SusceptibleChange$Type$ value = -1 }
        
        change_key = { lhs = Plague_Susceptible$Type$ which = Plague_SusceptibleChange$Type$ } # cant infect the infected
        subtract_key = { lhs = Plague_SusceptibleChange$Type$ which = Plague_Tmp2 } # add the base decay
    }
	else = {
		set_key = { lhs = Plague_InfectedChange$Type$ value = 0 }
	}
    
    ### Calculate new 'removed'
	# apply the disease 'removal' rate, the speed of which people recover or die basically
	set_key = { lhs = Plague_RemovedChange$Type$ which = Plague_Infected$Type$ }
	multiply_key = { lhs = Plague_RemovedChange$Type$ value = $RemovalRate$ } # disease Recovery rate
	change_key = { lhs = Plague_Removed$Type$ which = Plague_RemovedChange$Type$ } # remove them
	# remove removed from infected
	subtract_key = { lhs = Plague_Infected$Type$ which = Plague_RemovedChange$Type$ }
	subtract_key = { lhs = Plague_InfectedChange$Type$ which = Plague_RemovedChange$Type$ }
	# calculate the % that becomes immunne
	set_key = { lhs = Plague_Tmp0 which = Plague_RemovedChange$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = $ImmunityGain$ } # disease immunity gain (some might not add much immunity)
	change_key = { lhs = Plague_Resistance$Type$ which = Plague_Tmp0 } # add resistant % to resistant
    
    
    
	### Calculate new dead
	set_key = { lhs = Plague_DeadChange$Type$ which = Plague_RemovedChange$Type$ }
	set_key = { lhs = Public_Tmp2 value = 1 }
	divide_key = { lhs = Public_Tmp2 which = Class_FillLifeC } #avg life fullfilment
    multiply_key = { lhs = Public_Tmp2 value = $Severity$ } # disease death rate
	multiply_key = { lhs = Plague_DeadChange$Type$ which = Public_Tmp2 } #multiply dead depending on life quality
   
	change_key = { lhs = Plague_Dead$Type$ which = Plague_DeadChange$Type$ }
    if = {
        limit = {
            NOT = { has_province_flag = max_death }
            check_key = { lhs = Plague_Dead$Type$ value = 10 }
        }
        if = {
            limit = {
                check_key = { lhs = Plague_Dead$Type$ value = 20 }
            }
            remove_province_modifier = Plague_mod$Type$
            remove_province_modifier = Plague_mod_m$Type$
            add_permanent_province_modifier = { name = Plague_mod_s$Type$ duration = -1 }
            set_province_flag = max_death
        }
        else = { 
            remove_province_modifier = Plague_mod$Type$
            remove_province_modifier = Plague_mod_s$Type$
            add_permanent_province_modifier = { name = Plague_mod_m$Type$ duration = -1 }
        }
    }
	# Calculate raw dead
	set_key = { lhs = Plague_DeadRaw$Type$ which = Plague_Dead$Type$ }
	multiply_key = { lhs = Plague_DeadRaw$Type$ value = 0.01 } # 100->1 scale
	set_key = { lhs = Plague_DeadRawChange$Type$ which = Plague_DeadChange$Type$ }
	multiply_key = { lhs = Plague_DeadRawChange$Type$ value = 0.01 } # 100->1 scale
	
	multiply_key = { lhs = Plague_DeadRaw$Type$ which = Class_Total }
	multiply_key = { lhs = Plague_DeadRawChange$Type$ which = Class_Total }
	
	## Apply dead
    set_key = { lhs = Plague_Tmp0 value = 100 }
    subtract_key = { lhs = Plague_Tmp0 which = Plague_DeadChange$Type$ }
    multiply_key = { lhs = Plague_Tmp0 value = 0.01 }
	
	# note, this might be performance intensive. we might need to batch this or something
	Public_ChangeClassPropAll = { type = which inp = Plague_Tmp0 } # apply to all classes equally, could change

    set_key = { lhs = Plague_Tmp0 which = Plague_RemovedChange$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = 0.5 }
    change_key = { lhs = Plague_Tmp0 which = Plague_DeadChange$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = 0.5 }
    POP_SetDevastation = {
        type = which
        inp = Plague_Tmp0
    }
}
Plague_SpreadRateCalc = {
	set_key = { lhs = $return$ which = SF_Total }
    divide_key = { lhs = $return$ which = Land_PSize }
    random_list = { #randomness
        1 = { multiply_key = { lhs = $return$ value = 23 } }
        10 = { multiply_key = { lhs = $return$ value = 12 } }
        1 = { multiply_key = { lhs = $return$ value = 6 } }
    }
    multiply_key = { lhs = $return$ which = Plague_Factors } #Differentiate by Terrain Type
	multiply_key = { lhs = $return$ value = $SpreadRate$ } #Differentiate by Plague Type
}
Plague_Spread = {
    set_key = { lhs = Plague_Infected$Type$ which = PREV }
	set_key = { lhs = Plague_Tmp0 which = Plague_Resistance$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = 0.01 }
	multiply_key = { lhs = Plague_Tmp0 which = Plague_Tmp0 }
    multiply_key = { lhs = Plague_Infected$Type$ which = Plague_Tmp0 }
    multiply_key = { lhs = Plague_Infected$Type$ value = 0.5 }
   	multiply_key = { lhs = Plague_Infected$Type$ which = Plague_Factors } # Slow spread by terrain
	if = {
		limit = {
			check_key = { lhs = Plague_Infected$Type$ which = Plague_Susceptible$Type$ }
		}
		set_key = { lhs = Plague_Infected$Type$ which = Plague_Susceptible$Type$ }
	}
	else_if = { # over flow measures
		limit = {
			NOT = { check_key = { lhs = Plague_Infected$Type$ value = 0.001 } }
		}
		set_key = { lhs = Plague_Infected$Type$ value = 0.001 }
	}
    if = {
        limit = {
            check_key = { lhs = Plague_Infected$Type$ value = 0.001 }
        }
        set_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Infected$Type$ }
        subtract_key = { lhs = Plague_Susceptible$Type$ which = Plague_Infected$Type$ }
        multiply_key = { lhs = Plague_Susceptible$Type$ value = 0.9 }
        subtract_key = { lhs = Plague_SusceptibleChange$Type$ which = Plague_Infected$Type$ }
        set_province_flag = Plague
        set_province_flag = PlagueCD$Type$
        clr_province_flag = PlagueCand$Type$
        set_province_flag = Plague$Type$
        
        if = { limit = { NOT = { has_province_modifier = Plague_mod$Type$ } }
            add_permanent_province_modifier = {
                name = Plague_mod$Type$
                duration = -1
            }
        }
    }
    else = { 
        set_key = { lhs = Plague_Infected$Type$ value = 0 }
    }
}
Plague_SpreadScope = {
	set_province_flag = Plague
	set_province_flag = PlagueCD$Type$
	clr_province_flag = PlagueCand$Type$
	set_province_flag = Plague$Type$
	set_key = { lhs = Plague_Infected$Type$ which = PREV }
	set_key = { lhs = Plague_Tmp0 which = Plague_Resistance$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = 0.01 }
	multiply_key = { lhs = Plague_Tmp0 which = Plague_Tmp0 }
    multiply_key = { lhs = Plague_Infected$Type$ which = Plague_Tmp0 }
   	multiply_key = { lhs = Plague_Infected$Type$ which = Plague_Factors } # Slow spread by terrain
	if = {
		limit = {
			check_key = { lhs = Plague_Infected$Type$ which = Plague_Susceptible$Type$ }
		}
		set_key = { lhs = Plague_Infected$Type$ which = Plague_Susceptible$Type$ }
	}
	else_if = { # over flow measures
		limit = {
			NOT = { check_key = { lhs = Plague_Infected$Type$ value = 0.001 } }
		}
		set_key = { lhs = Plague_Infected$Type$ value = 0.001 }
	}
	multiply_key = { lhs = Plague_Infected$Type$ which = Plague_Factors } # Slow spread by terrain
    set_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Infected$Type$ }
	subtract_key = { lhs = Plague_Susceptible$Type$ which = Plague_Infected$Type$ }
	subtract_key = { lhs = Plague_SusceptibleChange$Type$ which = Plague_Infected$Type$ }
	if = { limit = { NOT = { has_province_modifier = Plague_mod$Type$ } }
		add_permanent_province_modifier = {
			name = Plague_mod$Type$
			duration = -1
		}
	}
}
Plague_Model_Smallpox = { 
	contgroup = {
		limit = {
			is_key_equal = { lhs = ID_Cont which = PREV }
		}
		set_province_flag = ActivePlague$Type$
	}
    
	if = { # plague cleaner
		limit = {
            OR = {
                AND = {
                    NOT = { check_key = { lhs = Plague_DeadChange$Type$ value = 0.1 } }
                    had_province_flag = {
                        flag = Plague$Type$
                        days = 486
                    }
                }
                AND = {
                    NOT = { check_key = { lhs = Plague_Susceptible$Type$ value = 1 } }
                    NOT = { check_key = { lhs = Plague_Infected$Type$ value = 0.05 } }
                }
            }
		}
		Plague_Clean = { Type= $Type$ }
        contgroup = {
            limit = {
                is_key_equal = { lhs = ID_Cont which = PREV }
            }
            clr_province_flag = ActivePlague$Type$
        }
	}
    if = { 
		limit = {
			has_province_flag = Plague$Type$
		}
		
		if = { 
            limit = {
                NOT = { has_province_flag = PlagueSpread$Type$ }
                NOT = { has_province_flag = PlagueCD$Type$ }
            }
            if = {
                limit = {
                    check_key = { lhs = Plague_Infected$Type$ value = 0.2 }
                }
                if = {
                    limit = {
                        check_key = { lhs = Plague_Infected$Type$ value = 0.4 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Plague_Infected$Type$ value = 0.6 }
                        }
                        if = {
                            limit = {
                                check_key = { lhs = Plague_Infected$Type$ value = 0.8 }
                            }
                            random_list = {
                                70 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                30 = {
                                }
                            }
                        }
                        else = {
                            random_list = {
                                60 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                40 = {
                                }
                            }
                        }
                    }
                    else = {
                        random_list = {
                            50 = {
                                set_province_flag = PlagueSpread$Type$
                            }
                            50 = {
                            }
                        }
                    }
                }
                else = {
                    random_list = {
                        40 = {
                            set_province_flag = PlagueSpread$Type$
                        }
                        60 = {
                        }
                    }
                }
            }
        }
            
		if = {
			limit = {
				has_province_flag = PlagueSpread$Type$
			}
			every_neighbor_province = {
				limit = {
					has_province_flag = PlagueCand$Type$
				}
                if = {
                    limit = {
                        check_key = { lhs = Plague_Resistance$Type$ value = 50 }
                    }
                    random_list = {
                        30 = {
                            Plague_Spread = { Type=$Type$ }
                            if = {
                                limit = {
                                    NOT = { check_key = { lhs = Land_Size value = 275 } }
                                }
                                PREV = {
                                    every_neighbor_province = {
                                        limit = {
                                            has_province_flag = PlagueCand$Type$
                                        }
                                        Plague_Spread = { Type=$Type$ }
                                    }
                                }
                            }
                        }
                        70 = {
                            PREV = { clr_province_flag = PlagueSpread$Type$ }
                        }
                    } 
                }
                else = {
                    random_list = {
                        55 = {
                            Plague_Spread = { Type=$Type$ }
                            if = {
                                limit = {
                                    NOT = { check_key = { lhs = Land_Size value = 275 } }
                                }
                                PREV = {
                                    every_neighbor_province = {
                                        limit = {
                                            has_province_flag = PlagueCand$Type$
                                        }
                                        Plague_Spread = { Type=$Type$ }
                                    }
                                }
                            }
                        }
                        45 = {
                            PREV = { clr_province_flag = PlagueSpread$Type$ }
                        }
                    }
                }
			}
			every_empty_neighbor_province = {
				limit = {
					has_province_flag = PlagueCand$Type$
				}
				random_list = {
					40 = {
						Plague_Spread = { Type=$Type$ }
						if = {
							limit = {
								NOT = { check_key = { lhs = Land_Size value = 750 } }
							}
							PREV = {
								every_empty_neighbor_province = {
									limit = {
										has_province_flag = PlagueCand$Type$
									}
									Plague_Spread = { Type=$Type$ }
								}
							}
						}
					}
					60 = {
						PREV = { clr_province_flag = PlagueSpread$Type$ }
					}
				}
			}
		}
        else_if = {
            limit = {
                has_province_flag = PlagueCD$Type$
            }
            clr_province_flag = PlagueCD$Type$
        }   
        Plague_ModelHelper = { Type=$Type$ SpreadRate=$SpreadRate$ RemovalRate=$RemovalRate$ Severity=$Severity$ ImmunityGain=$ImmunityGain$ } 
	}
}
Plague_Model_Salmonella = {
	contgroup = {
		limit = {
			is_key_equal = { lhs = ID_Cont which = PREV }
		}
		set_province_flag = ActivePlague$Type$
	}
	if = { # plague cleaner
		limit = {
            OR = {
                AND = {
                    NOT = { check_key = { lhs = Plague_DeadChange$Type$ value = 0.1 } }
                    had_province_flag = {
                        flag = Plague$Type$
                        days = 486
                    }
                }
                AND = {
                    NOT = { check_key = { lhs = Plague_Susceptible$Type$ value = 1 } }
                    NOT = { check_key = { lhs = Plague_Infected$Type$ value = 0.05 } }
                }
            }
		}		
        Plague_Clean = { Type = $Type$ }
        contgroup = {
            limit = {
                is_key_equal = { lhs = ID_Cont which = PREV }
            }
            clr_province_flag = ActivePlague$Type$
        }		
	}
    if = {
        limit = {
            has_province_flag = Plague$Type$
        }
        if = { 
            limit = {
                NOT = { has_province_flag = PlagueSpread$Type$ }
                NOT = { has_province_flag = PlagueCD$Type$ }
            }
            if = {
                limit = {
                    check_key = { lhs = Plague_Infected$Type$ value = 0.3 }
                }
                if = {
                    limit = {
                        check_key = { lhs = Plague_Infected$Type$ value = 0.5 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Plague_Infected$Type$ value = 0.7 }
                        }
                        if = {
                            limit = {
                                check_key = { lhs = Plague_Infected$Type$ value = 0.9 }
                            }
                            random_list = {
                                80 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                20 = {
                                }
                            }
                        }
                        else = {
                            random_list = {
                                70 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                30 = {
                                }
                            }
                        }
                    }
                    else = {
                        random_list = {
                            60 = {
                                set_province_flag = PlagueSpread$Type$
                            }
                            40 = {
                            }
                        }
                    }
                }
                else = {
                    random_list = {
                        50 = {
                            set_province_flag = PlagueSpread$Type$
                        }
                        50 = {
                        }
                    }
                }
            }
            if = {
                limit = {
                    has_province_flag = PlagueSpread$Type$
                }
                every_neighbor_province = {
                    limit = {
                        has_province_flag = salmonella_candidate
                        has_province_flag = PlagueCand$Type$
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Plague_Resistance$Type$ value = 50 }
                        }
                        random_list = {
                            5 = {
                                Plague_Spread = { Type=$Type$ }
                                if = {
                                    limit = {
                                        NOT = { check_key = { lhs = Land_Size value = 200 } }
                                    }
                                    PREV = {
                                        every_neighbor_province = {
                                            limit = {
                                                has_province_flag = PlagueCand$Type$
                                            }
                                            Plague_Spread = { Type=$Type$ }
                                        }
                                    }
                                }
                            }
                            8 = {
                                PREV = { clr_province_flag = PlagueSpread$Type$ }
                            }
                        }
                    }
                    else = {
                        random_list = {
                            7 = {
                                Plague_Spread = { Type=$Type$ }
                                if = {
                                    limit = {
                                        NOT = { check_key = { lhs = Land_Size value = 200 } }
                                    }
                                    PREV = {
                                        every_neighbor_province = {
                                            limit = {
                                                has_province_flag = PlagueCand$Type$
                                            }
                                            Plague_Spread = { Type=$Type$ }
                                        }
                                    }
                                }
                            }
                            6 = {
                                PREV = { clr_province_flag = PlagueSpread$Type$ }
                            }
                        }
                    }
                }
                every_empty_neighbor_province = {
                    limit = {
                        has_province_flag = PlagueCand$Type$
                        has_province_flag = salmonella_candidate
                    }
                    random_list = {
                        30 = {
                            Plague_Spread = { Type=$Type$ }
                            if = {
                                limit = {
                                    NOT = { check_key = { lhs = Land_Size value = 750 } }
                                }
                                PREV = {
                                    every_empty_neighbor_province = {
                                        limit = {
                                            has_province_flag = PlagueCand$Type$
                                        }
                                        Plague_Spread = { Type=$Type$ }
                                    }
                                }
                            }
                        }
                        70 = {
                            PREV = { clr_province_flag = PlagueSpread$Type$ }
                        }
                    }
                }
            }
        }
        else_if = {
            limit = {
                has_province_flag = PlagueCD$Type$
            }
            clr_province_flag = PlagueCD$Type$
        }
        Plague_ModelHelper = { Type=$Type$ SpreadRate=$SpreadRate$ RemovalRate=$RemovalRate$ Severity=$Severity$ ImmunityGain=$ImmunityGain$ } 
    }
}
Plague_Model_Typhus = { 
	contgroup = {
		limit = {
			is_key_equal = { lhs = ID_Cont which = PREV }
		}
		set_province_flag = ActivePlague$Type$
	}
    
	if = { # plague cleaner
		limit = {
            OR = {
                AND = {
                    NOT = { check_key = { lhs = Plague_DeadChange$Type$ value = 0.1 } }
                    had_province_flag = {
                        flag = Plague$Type$
                        days = 486
                    }
                }
                AND = {
                    NOT = { check_key = { lhs = Plague_Susceptible$Type$ value = 1 } }
                    NOT = { check_key = { lhs = Plague_Infected$Type$ value = 0.05 } }
                }
            }
		}		
        Plague_Clean = { Type = $Type$ }
        contgroup = {
            limit = {
                is_key_equal = { lhs = ID_Cont which = PREV }
            }
            clr_province_flag = ActivePlague$Type$
        }		
	}
    if = { 
		limit = {
			has_province_flag = Plague$Type$
		}
		
		if = { 
            limit = {
                check_key = { lhs = Plague_SpawnChance3 value = 1 } 
                NOT = { has_province_flag = PlagueSpread$Type$ }
                NOT = { has_province_flag = PlagueCD$Type$ }
                check_key = { lhs = Plague_SpawnChance3 value = 1 } # provinces that can't host ricketzia, don't spread.
            }
            
            if = {
                limit = {
                    check_key = { lhs = Plague_Infected$Type$ value = 0.3 }
                }
                if = {
                    limit = {
                        check_key = { lhs = Plague_Infected$Type$ value = 0.5 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Plague_Infected$Type$ value = 0.7 }
                        }
                        if = {
                            limit = {
                                check_key = { lhs = Plague_Infected$Type$ value = 0.9 }
                            }
                            random_list = {
                                70 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                30 = {
                                }
                            }
                        }
                        else = {
                            random_list = {
                                60 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                40 = {
                                }
                            }
                        }
                    }
                    else = {
                        random_list = {
                            50 = {
                                set_province_flag = PlagueSpread$Type$
                            }
                            50 = {
                            }
                        }
                    }
                }
                else = {
                    random_list = {
                        40 = {
                            set_province_flag = PlagueSpread$Type$
                        }
                        60 = {
                        }
                    }
                }
            }
        }
		if = {
			limit = {
				has_province_flag = PlagueSpread$Type$
			}
			every_neighbor_province = {
				limit = {
					has_province_flag = PlagueCand$Type$
				}
				random_list = {
					40 = {
						Plague_Spread = { Type=$Type$ }
						if = {
							limit = {
								NOT = { check_key = { lhs = Land_Size value = 300 } }
							}
							PREV = {
								every_neighbor_province = {
									limit = {
										has_province_flag = PlagueCand$Type$
									}
									Plague_Spread = { Type=$Type$ }
								}
							}
						}
					}
					60 = {
						PREV = { clr_province_flag = PlagueSpread$Type$ }
					}
				}
			}
			every_empty_neighbor_province = {
				limit = {
					has_province_flag = PlagueCand$Type$
				}
				random_list = {
					40 = {
						Plague_Spread = { Type=$Type$ }
						if = {
							limit = {
								NOT = { check_key = { lhs = Land_Size value = 750 } }
							}
							PREV = {
								every_empty_neighbor_province = {
									limit = {
										has_province_flag = PlagueCand$Type$
									}
									Plague_Spread = { Type=$Type$ }
								}
							}
						}
					}
					60 = {
						PREV = { clr_province_flag = PlagueSpread$Type$ }
					}
				}
			}
		}
        else_if = {
            limit = {
                has_province_flag = PlagueCD$Type$
            }
            clr_province_flag = PlagueCD$Type$
        }
        Plague_ModelHelper = { Type=$Type$ SpreadRate=$SpreadRate$ RemovalRate=$RemovalRate$ Severity=$Severity$ ImmunityGain=$ImmunityGain$ } 
	}
}
Plague_ModelHelper_Typhus = {
	### Calculate new infected
	## define population that can be infected. immunity removes parts of the population from being able to infect others
    if = {
        limit = {
            check_key = { lhs = Plague_Susceptible$Type$ value = 0 }
        }
        set_key = { lhs = Plague_Tmp0 value = 1.5 }
		set_key = { lhs = Plague_Tmp1 which = Plague_Resistance$Type$ }
		multiply_key = { lhs = Plague_Tmp1 value = 0.01 }
		multiply_key = { lhs = Plague_Tmp1 which = Plague_Tmp1 }
        subtract_key = { lhs = Plague_Tmp0 which = Plague_Tmp1 }

        
        set_key = { lhs = Plague_Tmp2 which = Plague_Susceptible$Type$ }
        multiply_key = { lhs = Plague_Susceptible$Type$ value = 0.82 } #remove % each month. Diseases don't have infinite time to infect
        subtract_key = { lhs = Plague_Tmp2 which = Plague_Susceptible$Type$ }
        if = {
            limit = {
                NOT = { check_key = { lhs = Plague_Susceptible$Type$ value = 1 } }
            }
            set_key = { lhs = Plague_Susceptible$Type$ value = 0 }
        }
        
        ## apply factors to spread, like population density, disease type, etc
        Plague_SpreadRateCalc_Typhus = { return=Plague_InfectedChange$Type$ SpreadRate=$SpreadRate$ } # outputs a multiplier
        
        # calculate actual people infected
        multiply_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Susceptible$Type$ }
        multiply_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Tmp0 } # multiply spreading rate by immunity factor. Above 50 immunity slows down spreading.
        multiply_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Infected$Type$ } # more infection means critical mass, this is key. if it doesnt boom, it might not spread
        multiply_key = { lhs = Plague_InfectedChange$Type$ value = 0.001 }
        
        if = {
            limit = {
                check_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Susceptible$Type$ }
            }
            set_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Susceptible$Type$ }
        }
        else_if = {
            limit = {
                NOT = { check_key = { lhs = Plague_InfectedChange$Type$ value = 0 } }
            }
            set_key = { lhs = Plague_InfectedChange$Type$ value = 0 }
        }
    }
	else = {
		set_key = { lhs = Plague_InfectedChange$Type$ value = 0 }
	}
    
	## add to infected total
    
	change_key = { lhs = Plague_Infected$Type$ which = Plague_InfectedChange$Type$ }
       
	# remove infected from being susceptible, they are instead infected
	set_key = { lhs = Plague_SusceptibleChange$Type$ which = Plague_InfectedChange$Type$ }
    multiply_key = { lhs = Plague_SusceptibleChange$Type$ value = -1 }
    
	change_key = { lhs = Plague_Susceptible$Type$ which = Plague_SusceptibleChange$Type$ } # cant infect the infected
    subtract_key = { lhs = Plague_SusceptibleChange$Type$ which = Plague_Tmp2 } # add the base decay for display

	
	### Calculate new 'removed'
	# apply the disease 'removal' rate, the speed of which people recover or die basically
	set_key = { lhs = Plague_RemovedChange$Type$ which = Plague_Infected$Type$ }
	multiply_key = { lhs = Plague_RemovedChange$Type$ value = $RemovalRate$ } # disease Recovery rate
	change_key = { lhs = Plague_Removed$Type$ which = Plague_RemovedChange$Type$ } # remove them
	# remove removed from infected
	subtract_key = { lhs = Plague_Infected$Type$ which = Plague_RemovedChange$Type$ }
	subtract_key = { lhs = Plague_InfectedChange$Type$ which = Plague_RemovedChange$Type$ }
	# calculate the % that becomes immunne
	set_key = { lhs = Plague_Tmp0 which = Plague_RemovedChange$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = $ImmunityGain$ } # disease immunity gain (some might not add much immunity)
	change_key = { lhs = Plague_Resistance$Type$ which = Plague_Tmp0 } # add resistant % to resistant
    
    
    
	### Calculate new dead
	set_key = { lhs = Plague_DeadChange$Type$ which = Plague_RemovedChange$Type$ }
	set_key = { lhs = Public_Tmp2 value = 1 }
	divide_key = { lhs = Public_Tmp2 which = Class_FillLifeC } #avg life fullfilment
    multiply_key = { lhs = Public_Tmp2 value = $Severity$ } # disease death rate
	multiply_key = { lhs = Plague_DeadChange$Type$ which = Public_Tmp2 } #multiply dead depending on life quality
   
	change_key = { lhs = Plague_Dead$Type$ which = Plague_DeadChange$Type$ }
    if = {
        limit = {
            NOT = { has_province_flag = PlagueSpawner }
            check_key = { lhs = Plague_Dead$Type$ value = 10 }
        }
        if = {
            limit = {
                check_key = { lhs = Plague_Dead$Type$ value = 20 }
            }
            remove_province_modifier = Plague_mod$Type$
            remove_province_modifier = Plague_mod_m$Type$
            add_permanent_province_modifier = { name = Plague_mod_s$Type$ duration = -1 }
        }
        else = { 
            remove_province_modifier = Plague_mod$Type$
            remove_province_modifier = Plague_mod_s$Type$
            add_permanent_province_modifier = { name = Plague_mod_m$Type$ duration = -1 }
        }
    }
    
	# Calculate raw dead
	set_key = { lhs = Plague_DeadRaw$Type$ which = Plague_Dead$Type$ }
	multiply_key = { lhs = Plague_DeadRaw$Type$ value = 0.01 } # 100->1 scale
	set_key = { lhs = Plague_DeadRawChange$Type$ which = Plague_DeadChange$Type$ }
	multiply_key = { lhs = Plague_DeadRawChange$Type$ value = 0.01 } # 100->1 scale
	
	multiply_key = { lhs = Plague_DeadRaw$Type$ which = Class_Total }
	multiply_key = { lhs = Plague_DeadRawChange$Type$ which = Class_Total }
	
	## Apply dead
    set_key = { lhs = Plague_Tmp0 value = 100 }
    subtract_key = { lhs = Plague_Tmp0 which = Plague_DeadChange$Type$ }
    multiply_key = { lhs = Plague_Tmp0 value = 0.01 }
	
	# note, this might be performance intensive. we might need to batch this or something
	Public_ChangeClassPropAll = { type = which inp = Plague_Tmp0 } # apply to all classes equally, could change

    set_key = { lhs = Plague_Tmp0 which = Plague_RemovedChange$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = 0.5 }
    change_key = { lhs = Plague_Tmp0 which = Plague_DeadChange$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = 0.5 }
    POP_SetDevastation = {
        type = which
        inp = Plague_Tmp0
    }
}
Plague_SpreadRateCalc_Typhus = { # Typhus was very dependant on pop density
	set_key = { lhs = $return$ which = SF_Total }
    set_key = { lhs = Plague_Tmp1 which = Land_PSize }
    #divide_key = { lhs = Plague_Tmp1 value = 0.9 }
    divide_key = { lhs = $return$ which = Plague_Tmp1 }
    multiply_key = { lhs = $return$ which = $return$ } # typhus gets exponential approach since it was very dependant on pop density
    random_list = { #randomness
        1 = { multiply_key = { lhs = $return$ value = 26 } }
        5 = { multiply_key = { lhs = $return$ value = 13 } }
        1 = { multiply_key = { lhs = $return$ value = 3 } }
    }
    multiply_key = { lhs = $return$ which = Plague_Factors } #Differentiate by Terrain Type
	multiply_key = { lhs = $return$ value = $SpreadRate$ } #Differentiate by Plague Type
}
Plague_Model_Malaria = { 
	contgroup = {
		limit = {
			is_key_equal = { lhs = ID_Cont which = PREV }
		}
		set_province_flag = ActivePlague$Type$
	}
    
	if = { # plague cleaner
		limit = {
            OR = {
                AND = {
                    NOT = { check_key = { lhs = Plague_DeadChange$Type$ value = 0.3 } }
                    had_province_flag = {
                        flag = Plague$Type$
                        days = 486
                    }
                }
                AND = {
                    NOT = { check_key = { lhs = Plague_Susceptible$Type$ value = 1 } }
                    NOT = { check_key = { lhs = Plague_Infected$Type$ value = 0.5 } }
                }
            }
		}
		random_list = {
			50 = {
				Plague_Clean_Malaria = { Type= $Type$ }
				contgroup = {
					limit = {
						is_key_equal = { lhs = ID_Cont which = PREV }
					}
					clr_province_flag = ActivePlague$Type$
				}
			}
			50 = {
			}
		}
	}
    if = { 
		limit = {
			has_province_flag = Plague$Type$
        }
        if = {
            limit = {
                NOT = { has_province_flag = PlagueSpread$Type$ }
                NOT = { has_province_flag = PlagueCD$Type$ }
                has_province_flag = mosquitos # provinces that can't host mosquitos, don't spread.
            }
		
            if = {
                limit = {
                    check_key = { lhs = Plague_Infected$Type$ value = 0.3 }
                }
                if = {
                    limit = {
                        check_key = { lhs = Plague_Infected$Type$ value = 0.5 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Plague_Infected$Type$ value = 0.7 }
                        }
                        if = {
                            limit = {
                                check_key = { lhs = Plague_Infected$Type$ value = 0.9 }
                            }
                            random_list = {
                                70 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                30 = {
                                }
                            }
                        }
                        else = {
                            random_list = {
                                60 = {
                                    set_province_flag = PlagueSpread$Type$
                                }
                                40 = {
                                }
                            }
                        }
                    }
                    else = {
                        random_list = {
                            50 = {
                                set_province_flag = PlagueSpread$Type$
                            }
                            50 = {
                            }
                        }
                    }
                }
                else = {
                    random_list = {
                        40 = {
                            set_province_flag = PlagueSpread$Type$
                        }
                        60 = {
                        }
                    }
                }
            }
            if = {
                limit = {
                    has_province_flag = PlagueSpread$Type$
                }
                every_neighbor_province = {
                    limit = {
                        check_key = { lhs = Plague_SpawnChance4 value = 0.1 }
                        has_province_flag = PlagueCand$Type$
                    }
                    random_list = {
                        5 = {
                            Plague_Spread = { Type=$Type$ }
                            if = {
                                limit = {
                                    NOT = { check_key = { lhs = Land_Size value = 150 } }
                                }
                                PREV = {
                                    every_neighbor_province = {
                                        limit = {
                                            check_key = { lhs = Plague_SpawnChance4 value = 0.1 }
                                            has_province_flag = PlagueCand$Type$
                                        }
                                        Plague_Spread = { Type=$Type$ }
                                    }
                                }
                            }
                        }
                        6 = {
                            PREV = { clr_province_flag = PlagueSpread$Type$ }
                        }
                    }
                }
                every_empty_neighbor_province = {
                    limit = {
                        has_province_flag = PlagueCand$Type$
                    }
                    random_list = {
                        70 = {
                            Plague_Spread = { Type=$Type$ }
                            if = {
                                limit = {
                                    NOT = { check_key = { lhs = Land_Size value = 750 } }
                                }
                                PREV = {
                                    every_empty_neighbor_province = {
                                        limit = {
                                            has_province_flag = PlagueCand$Type$
                                        }
                                        Plague_Spread = { Type=$Type$ }
                                    }
                                }
                            }
                        }
                        30 = {
                            PREV = { clr_province_flag = PlagueSpread$Type$ }
                        }
                    }
                }
            }
        }
        else_if = {
            limit = {
                has_province_flag = PlagueCD$Type$
            }
            clr_province_flag = PlagueCD$Type$
        }
        Plague_ModelHelper_Malaria = { Type=$Type$ SpreadRate=$SpreadRate$ RemovalRate=$RemovalRate$ Severity=$Severity$ ImmunityGain=$ImmunityGain$ } 
    }
}
Plague_ModelHelper_Malaria = {
	### Calculate new infected
	## define population that can be infected. immunity removes parts of the population from being able to infect others
    if = {
        limit = {
            check_key = { lhs = Plague_Susceptible$Type$ value = 0 }
        }
        set_key = { lhs = Plague_Tmp0 value = 1.5 }
		set_key = { lhs = Plague_Tmp1 which = Plague_Resistance$Type$ }
		multiply_key = { lhs = Plague_Tmp1 value = 0.01 }
		multiply_key = { lhs = Plague_Tmp1 which = Plague_Tmp1 }
        subtract_key = { lhs = Plague_Tmp0 which = Plague_Tmp1 }
        set_key = { lhs = Plague_Tmp2 which = Plague_Susceptible$Type$ }
        multiply_key = { lhs = Plague_Susceptible$Type$ value = 0.82 } #remove % each month. Diseases don't have infinite time to infect
        subtract_key = { lhs = Plague_Tmp2 which = Plague_Susceptible$Type$ }
        if = {
            limit = {
                NOT = { check_key = { lhs = Plague_Susceptible$Type$ value = 1 } }
            }
            set_key = { lhs = Plague_Susceptible$Type$ value = 0 }
        }
        
        ## apply factors to spread, like population density, disease type, etc
        Plague_SpreadRateCalc_Malaria = { return=Plague_InfectedChange$Type$ SpreadRate=$SpreadRate$ } # outputs a multiplier
        
        # calculate actual people infected
        multiply_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Susceptible$Type$ }
        multiply_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Tmp0 } # multiply spreading rate by immunity factor. Above 50 immunity slows down spreading.
        multiply_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Infected$Type$ } # more infection means critical mass, this is key. if it doesnt boom, it might not spread
        multiply_key = { lhs = Plague_InfectedChange$Type$ value = 0.001 }
        
        if = {
            limit = {
                check_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Susceptible$Type$ }
            }
            set_key = { lhs = Plague_InfectedChange$Type$ which = Plague_Susceptible$Type$ }
        }
        else_if = {
            limit = {
                NOT = { check_key = { lhs = Plague_InfectedChange$Type$ value = 0 } }
            }
			set_key = { lhs = Plague_InfectedChange$Type$ value = 0 }
		}
    }
	else = {
		set_key = { lhs = Plague_InfectedChange$Type$ value = 0 }
	}
    
	## add to infected total
    
	change_key = { lhs = Plague_Infected$Type$ which = Plague_InfectedChange$Type$ }
       
	# remove infected from being susceptible, they are instead infected
	set_key = { lhs = Plague_SusceptibleChange$Type$ which = Plague_InfectedChange$Type$ }
    multiply_key = { lhs = Plague_SusceptibleChange$Type$ value = -1 }
    
	change_key = { lhs = Plague_Susceptible$Type$ which = Plague_SusceptibleChange$Type$ } # cant infect the infected
    subtract_key = { lhs = Plague_SusceptibleChange$Type$ which = Plague_Tmp2 } # add the base decay
   
	
	### Calculate new 'removed'
	# apply the disease 'removal' rate, the speed of which people recover or die basically
	set_key = { lhs = Plague_RemovedChange$Type$ which = Plague_Infected$Type$ }
	multiply_key = { lhs = Plague_RemovedChange$Type$ value = $RemovalRate$ } # disease Recovery rate
	change_key = { lhs = Plague_Removed$Type$ which = Plague_RemovedChange$Type$ } # remove them
	# remove removed from infected
	subtract_key = { lhs = Plague_Infected$Type$ which = Plague_RemovedChange$Type$ }
	subtract_key = { lhs = Plague_InfectedChange$Type$ which = Plague_RemovedChange$Type$ }
	# calculate the % that becomes immunne
	set_key = { lhs = Plague_Tmp0 which = Plague_RemovedChange$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = $ImmunityGain$ } # disease immunity gain (some might not add much immunity)
	change_key = { lhs = Plague_Resistance$Type$ which = Plague_Tmp0 } # add resistant % to resistant
    
    
    
	### Calculate new dead
	set_key = { lhs = Plague_DeadChange$Type$ which = Plague_RemovedChange$Type$ }
	set_key = { lhs = Public_Tmp2 value = 1 }
	divide_key = { lhs = Public_Tmp2 which = Class_FillLifeC } #avg life fullfilment
    multiply_key = { lhs = Public_Tmp2 value = $Severity$ } # disease death rate
	multiply_key = { lhs = Plague_DeadChange$Type$ which = Public_Tmp2 } #multiply dead depending on life quality
   
	change_key = { lhs = Plague_Dead$Type$ which = Plague_DeadChange$Type$ }
    if = {
        limit = {
            NOT = { has_province_flag = PlagueSpawner }
            check_key = { lhs = Plague_Dead$Type$ value = 10 }
        }
        if = {
            limit = {
                check_key = { lhs = Plague_Dead$Type$ value = 20 }
            }
            remove_province_modifier = Plague_mod$Type$
            remove_province_modifier = Plague_mod_m$Type$
            add_permanent_province_modifier = { name = Plague_mod_s$Type$ duration = -1 }
        }
        else = { 
            remove_province_modifier = Plague_mod$Type$
            remove_province_modifier = Plague_mod_s$Type$
            add_permanent_province_modifier = { name = Plague_mod_m$Type$ duration = -1 }
        }
    }
    
	# Calculate raw dead
	set_key = { lhs = Plague_DeadRaw$Type$ which = Plague_Dead$Type$ }
	multiply_key = { lhs = Plague_DeadRaw$Type$ value = 0.01 } # 100->1 scale
	set_key = { lhs = Plague_DeadRawChange$Type$ which = Plague_DeadChange$Type$ }
	multiply_key = { lhs = Plague_DeadRawChange$Type$ value = 0.01 } # 100->1 scale
	
	multiply_key = { lhs = Plague_DeadRaw$Type$ which = Class_Total }
	multiply_key = { lhs = Plague_DeadRawChange$Type$ which = Class_Total }
	
	## Apply dead
    set_key = { lhs = Plague_Tmp0 value = 100 }
    subtract_key = { lhs = Plague_Tmp0 which = Plague_DeadChange$Type$ }
    multiply_key = { lhs = Plague_Tmp0 value = 0.01 }
	
	# note, this might be performance intensive. we might need to batch this or something
	Public_ChangeClassPropAll = { type = which inp = Plague_Tmp0 } # apply to all classes equally, could change

    set_key = { lhs = Plague_Tmp0 which = Plague_RemovedChange$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = 0.5 }
    change_key = { lhs = Plague_Tmp0 which = Plague_DeadChange$Type$ }
	multiply_key = { lhs = Plague_Tmp0 value = 0.5 }
    POP_SetDevastation = {
        type = which
        inp = Plague_Tmp0
    }
}
Plague_SpreadRateCalc_Malaria = { # Malaria
	set_key = { lhs = $return$ which = SF_Total }
    set_key = { lhs = Plague_Tmp1 which = Land_PSize }
    divide_key = { lhs = Plague_Tmp1 value = 1.4 }
    divide_key = { lhs = $return$ which = Plague_Tmp1 }
    multiply_key = { lhs = $return$ which = Plague_Factors } #Differentiate by Terrain Type
	multiply_key = { lhs = $return$ value = $SpreadRate$ } #Differentiate by Plague Type
}
America_Malaria_Calculator = {
    clr_province_flag = possible_malaria
    set_key = { lhs = Plague_SpawnChance4 value = 0 }
    if = {
        limit = {
            check_key = { lhs = Land_AvgTemp value = 15.5 } 
        }
        if = {
            limit = {
                check_key = { lhs = Land_AvgTemp value = 17.5 }
            }
            if = {
                limit = {
                    check_key = { lhs = Land_AvgTemp value = 19.5 }
                }
                if = {
                    limit = {
                        check_key = { lhs = Land_AvgTemp value = 21.5 }
                    }
                    if = {
                        limit = {
                            check_key = { lhs = Land_AvgTemp value = 23.5 }
                        }
                        change_key = { lhs = Plague_SpawnChance4 value = 7 }
                    }
                    else = {
                        change_key = { lhs = Plague_SpawnChance4 value = 5 }
                    }
                }
                else = {
                    change_key = { lhs = Plague_SpawnChance4 value = 4 }
                }
            }
            else = {
                change_key = { lhs = Plague_SpawnChance4 value = 3 }
            }
        }
        else = {
            change_key = { lhs = Plague_SpawnChance4 value = 1 }
        }        
    }
    if = {
        limit = {
            has_terrain = marsh
            check_key = { lhs = Land_AvgTemp value = 13 }
        }
        change_key = { lhs = Plague_SpawnChance4 value = 2 }
    }
    trigger_switch = { 
        on_trigger = has_terrain
        
        arctic = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
        }
        forest_flats = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 1.2 }
        }
        forest_hills = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0.75 }
        }
        forest_mountains = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
        }
        forest_highlands = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
        }
        wood_flats = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 1.5 }
        }
        wood_hills = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0.75 }
        }
        wood_mountains = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0.25 }
        }
        wood_highlands = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0.75 }
        }
        shrub_flats = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 1 }
        }
        shrub_hills = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0.75 }
        }
        shrub_mountains = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
        }
        shrub_highlands = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
        }
        grass_flats = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 1.5 }
        }
        grass_hills = {
           
        }
        grass_mountains = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
        }
        grass_highlands = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
        }
        desert_flats = {
           multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
        }
        desert_hills = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
        }
        desert_mountains = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0.5 }
        }
        desert_highlands = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
        }
        jungle_flats = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 2 }
        }
        jungle_hills = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 2 }
        }
        floodplains = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 2.75 }
        }
        taiga = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 1.5 }
        }
        marsh = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 2 }
        }
        alpine_tundra = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
        }
        tundra = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 0 }
        }
        small_island = {
            multiply_key = { lhs = Plague_SpawnChance4 value = 1 }
        }
    }
}
Immunity_Calc = { 
    random_list = {
        90 = {
            if = {
                limit = {
                    check_key = { lhs = Plague_Resistance$Type$ value = 2 }
                }
                subtract_key = { lhs = Plague_Resistance$Type$ value = 1 }
            }
        }
        5 = { 
            if = {
                limit = {
                    check_key = { lhs = Plague_Resistance$Type$ value = 6 }
                }                
                subtract_key = { lhs = Plague_Resistance$Type$ value = 4 }
            }
        }
        1 = {
            if = {
                limit = {
                    check_key = { lhs = Plague_Resistance$Type$ value = 11 }
                }
                subtract_key = { lhs = Plague_Resistance$Type$ value = 8 }
            }
        }
        1 = {
        }
    }
}
#