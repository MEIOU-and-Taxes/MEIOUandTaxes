namespace = SYS_StateProperty

### Concept for Estates Acquiring State Property
# If Capacity is overburdened, prov will be found where we can sell to local powerbroker
	#Weighting table is as follows:
	#########  Monarch / Tribal / Republic / Theocracy
	#Farmland   6 / 6 / 1 / 6
	#Extraction 7 / 7 / 1 / 2
	#Forestry   4 / 5 / 1 / 3
	#Fishery    5 / 4 / 1 / 5
	#Industrial 2 / 2 / 5 / 4
	#Commerce   1 / 1 / 5 / 1
	#Academic   3 / 3 / 5 / 7
	## The higher the number, the less likely it is picked for selling 

#Farmland
country_event = {
	id = SYS_StateProperty.002
	title = SYS_StateProperty.002.t
	desc = SYS_StateProperty.002.desc
	picture = CITY_DEVELOPMENT_eventPicture
	
	trigger = {
		has_country_flag = StatePropertyBurden
		check_key = { lhs = BuyOutTarget value = 25 }
		check_key = { lhs = StatePropertyAgriculture value = 5 }
		NOT = { has_country_flag = NoFarmlandForSale }
	}
	
	mean_time_to_happen = {
		months = 1
		modifier = {
			factor = 1
			government = monarchy
		}
		modifier = {
			factor = 6
			government = tribal
		}
		#modifier = {
		#	factor = 1
		#	government = republic
		#}
		modifier = {
			factor = 6
			government = theocracy
		}
	}
	
	immediate = {
		#find a province
			random_owned_province = {
				limit = {
					check_key = { lhs = BU_Agriculture value = 0.001 }
					#NOT = { has_province_flag = RecentlySoldProperty }
				}
				save_event_target_as = StatePropertyBuyOut
				
				if = { # sell a chunk
					limit = {
						check_key = { lhs = BU_Agriculture value = 25 }
					}
					set_key = { lhs = BuyOutAmount which = BU_Agriculture }
					multiply_key = { lhs = BuyOutAmount value = 0.75 }
				}
				else = { # sell it all 
					set_key = { lhs = BuyOutAmount which = BU_Agriculture }
					#multiply_key = { lhs = BuyOutAmount value = 0.75 }
				}
				
				if = { 
					limit = { 
						check_key = { lhs = Building_AgricultureGross value = 1 }
					}
					set_key = { lhs = BuyOutValue which = Building_AgricultureGross } # take profits of that property
				}
				else = {
					set_key = { lhs = BuyOutValue value = 1 } # to have at least some kind of value
				}
				divide_key = { lhs = BuyOutValue which = Building_Agriculture } # divide profits with size of that property
				multiply_key = { lhs = BuyOutValue value = 10 } # 10 years projected profits
				multiply_key = { lhs = BuyOutValue which = BuyOutAmount } # projected profits x amount to be sold
				ROOT = { set_key = { lhs = BuyOutValue which = PREV } } # Theoretical value saved to country scope
				ROOT = { set_key = { lhs = BuyOutAmount which = PREV } } # Amount saved to country scope
				
				#Nobility
				set_key = { lhs = Tmp_1 value = 1 }
				multiply_key = { lhs = Tmp_1 which = Prov_NOLoy } # 0 to 100
				multiply_key = { lhs = Tmp_1 value = 0.5 } # to have a 0 to 50 range
				change_key = { lhs = Tmp_1 value = 50 } #make sure they offer at least 50%
				multiply_key = { lhs = Tmp_1 value = 0.01 } # 50 to 100 -> 0.50 to 1.00
				multiply_key = { lhs = Tmp_1 which = BuyOutValue } # Factor x Value
				#Clergy
				set_key = { lhs = Tmp_2 value = 1 }
				multiply_key = { lhs = Tmp_2 which = Prov_CLLoy } # 0 to 100
				multiply_key = { lhs = Tmp_2 value = 0.5 } # to have a 0 to 50 range
				change_key = { lhs = Tmp_2 value = 50 } #make sure they offer at least 50%
				multiply_key = { lhs = Tmp_2 value = 0.01 } # 50 to 100 -> 0.50 to 1.00
				multiply_key = { lhs = Tmp_2 which = BuyOutValue } # Factor x Value				
				#Burgher
				set_key = { lhs = Tmp_3 value = 1 }
				multiply_key = { lhs = Tmp_3 which = Prov_BGLoy } # 0 to 100
				multiply_key = { lhs = Tmp_3 value = 0.5 } # to have a 0 to 50 range
				change_key = { lhs = Tmp_3 value = 50 } #make sure they offer at least 50%
				multiply_key = { lhs = Tmp_3 value = 0.01 } # 50 to 100 -> 0.50 to 1.00
				multiply_key = { lhs = Tmp_3 which = BuyOutValue } # Factor x Value
				#Commoners
				set_key = { lhs = Tmp_4 value = 0.65 } #Commoners always offer 65% for now
				multiply_key = { lhs = Tmp_4 which = BuyOutValue } # Factor x Value	

				ROOT = { set_key = { lhs = Tmp_1 which = PREV } } # adding that to country scope for loc
				ROOT = { set_key = { lhs = Tmp_2 which = PREV } } # adding that to country scope for loc
				ROOT = { set_key = { lhs = Tmp_3 which = PREV } } # adding that to country scope for loc
				ROOT = { set_key = { lhs = Tmp_4 which = PREV } } # adding that to country scope for loc
			}
			
	}
	#Nobility
	option = {
		name = SYS_StateProperty.002.a
		trigger = {
			event_target:StatePropertyBuyOut = {
				check_key = { lhs = NO_Wealth which = Tmp_1 }
			}
		}
		hidden_effect = {
			event_target:StatePropertyBuyOut = {				
				change_key = { lhs = NO_Agriculture which = BuyOutAmount }
				subtract_key = { lhs = BU_Agriculture which = BuyOutAmount }
				
				subtract_key = { lhs = NO_Wealth which = Tmp_1 }
				
				set_key = { lhs = Tmp_5 which = BuyOutAmount }
				multiply_key = { lhs = Tmp_5 which = Modi_StatePropertyAgriculture } # calculate impact of sold StateProperty
				ROOT = { set_key = { lhs = Tmp_5 which = PREV } } # Updating Country Scope, to be used in next iteration
				set_province_flag = RecentlySoldProperty
			}
			subtract_key = { lhs = BuyOutTarget which = Tmp_5 } # Updating Country Scope, to be used in next iteration
			set_var_from_key = { var = ducat_gain key = Tmp_1 }
			old_scaled_ducat_gained_country = yes
			
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2.00
				owner = { government = monarchy }
			}
		}
		
	}
	#Clergy
	option = {
		name = SYS_StateProperty.002.b
		trigger = {
			event_target:StatePropertyBuyOut = {
				check_key = { lhs = CL_Wealth which = Tmp_2 }
			}
		}
		hidden_effect = {
			event_target:StatePropertyBuyOut = {				
				change_key = { lhs = CL_Agriculture which = BuyOutAmount }
				subtract_key = { lhs = BU_Agriculture which = BuyOutAmount }
				
				subtract_key = { lhs = CL_Wealth which = Tmp_2 }
				
				set_key = { lhs = Tmp_5 which = BuyOutAmount }
				multiply_key = { lhs = Tmp_5 which = Modi_StatePropertyAgriculture } # calculate impact of sold StateProperty
				ROOT = { set_key = { lhs = Tmp_5 which = PREV } } # Updating Country Scope, to be used in next iteration
				set_province_flag = RecentlySoldProperty
			}
			subtract_key = { lhs = BuyOutTarget which = Tmp_5 } # Updating Country Scope, to be used in next iteration
			set_var_from_key = { var = ducat_gain key = Tmp_2 }
			old_scaled_ducat_gained_country = yes

		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2.00
				owner = { government = theocracy }
			}
		}
		
	}
	#Burgher
	option = {
		name = SYS_StateProperty.002.c
		trigger = {
			event_target:StatePropertyBuyOut = {
				check_key = { lhs = BG_Wealth which = Tmp_3 }
				Rights_BGGov4HasGreater = yes
			}
		}
		hidden_effect = {
			event_target:StatePropertyBuyOut = {
				change_key = { lhs = BG_Agriculture which = BuyOutAmount }
				subtract_key = { lhs = BU_Agriculture which = BuyOutAmount }
				
				subtract_key = { lhs = BG_Wealth which = Tmp_3 }
				
				set_key = { lhs = Tmp_5 which = BuyOutAmount }
				multiply_key = { lhs = Tmp_5 which = Modi_StatePropertyAgriculture } # calculate impact of sold StateProperty
				ROOT = { set_key = { lhs = Tmp_5 which = PREV } } # Updating Country Scope, to be used in next iteration
				set_province_flag = RecentlySoldProperty
			}
			subtract_key = { lhs = BuyOutTarget which = Tmp_5 } # Updating Country Scope, to be used in next iteration
			set_var_from_key = { var = ducat_gain key = Tmp_3 }
			old_scaled_ducat_gained_country = yes

		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 2.00
				owner = { government = republic }
			}
		}
		
	}
	#Commoners
	option = {
		name = SYS_StateProperty.002.d
		trigger = {
			event_target:StatePropertyBuyOut = {
				check_key = { lhs = SF_Wealth which = Tmp_4 }
			}
			OR = {
				Rights_NOTen4Has = yes
				Rights_NOGov5Has = yes
			}
		}
		hidden_effect = {
			event_target:StatePropertyBuyOut = {
				change_key = { lhs = SF_Agriculture which = BuyOutAmount }
				subtract_key = { lhs = BU_Agriculture which = BuyOutAmount }
				
				subtract_key = { lhs = SF_Wealth which = Tmp_4 }
				
				set_key = { lhs = Tmp_5 which = BuyOutAmount }
				multiply_key = { lhs = Tmp_5 which = Modi_StatePropertyAgriculture } # calculate impact of sold StateProperty
				ROOT = { set_key = { lhs = Tmp_5 which = PREV } } # Updating Country Scope, to be used in next iteration
				set_province_flag = RecentlySoldProperty
			}
			subtract_key = { lhs = BuyOutTarget which = Tmp_5 } # Updating Country Scope, to be used in next iteration
			set_var_from_key = { var = ducat_gain key = Tmp_4 }
			old_scaled_ducat_gained_country = yes

		}
		ai_chance = {
			factor = 100
			modifier = {
				owner = { num_of_cities = 50 }
				factor = 1.5
			}
			modifier = {
				owner = { num_of_cities = 80 }
				factor = 1.5
			}
		}
		
	}
	#Nobody
	option = {
		name = SYS_StateProperty.002.e
		trigger = {
		}
		hidden_effect = {
			event_target:StatePropertyBuyOut = {
				change_key = { lhs = Prov_BULoy value = 10 }
				
			}
			set_country_flag = NoFarmlandForSale

		}
		ai_chance = {
			factor = 0
		}
		
	}
	#NoProvince has that property
	option = {
		name = SYS_StateProperty.002.f
		trigger = {
			all_owned_province = {
				NOT = { check_key = { lhs = BU_Agriculture value = 0.001 } }
			}
		}
		hidden_effect = {
		}
		ai_chance = {
			factor = 0
		}
		
	}
	after = {
		hidden_effect = {
			event_target:StatePropertyBuyOut = {
				set_key = { lhs = Tmp_1 value = 0 }
				set_key = { lhs = Tmp_2 value = 0 }
				set_key = { lhs = Tmp_3 value = 0 }
				set_key = { lhs = Tmp_4 value = 0 }
				set_key = { lhs = Tmp_5 value = 0 }
				set_key = { lhs = BuyOutAmount value = 0 }
				set_key = { lhs = BuyOutValue value = 0 }
			}
			set_key = { lhs = Tmp_1 value = 0 }
			set_key = { lhs = Tmp_2 value = 0 }
			set_key = { lhs = Tmp_3 value = 0 }
			set_key = { lhs = Tmp_4 value = 0 }
			set_key = { lhs = Tmp_5 value = 0 }
			set_key = { lhs = BuyOutAmount value = 0 }
			set_key = { lhs = BuyOutValue value = 0 }
			if = {
				limit = {
					NOT = { check_key = { lhs = BuyOutTarget value = 25 } }
				}
				clr_country_flag = StatePropertyBurden
			}
		}
	}
}
